<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="description" content="This guide pairs each SQL example with a PySpark DataFrame API equivalent.
Assumptions: df is employees, and other tables are similarly named DataFrames (departments, orders, etc.).
Imports used in PySpark examples
from pyspark.sql import functions as F from pyspark.sql.functions import col, lit, when, lower, upper, count, sum, avg, max, min, row_number, rank, dense_rank, ntile, lead, lag, coalesce from pyspark.sql.window import Window ðŸ§© Section 1: Basic Queries (1â€“10) SQL -- 1 SELECT * FROM employees; -- 2 SELECT first_name, last_name, hire_date FROM employees; -- 3 SELECT COUNT(*) FROM employees; -- 4 SELECT COUNT(salary) FROM employees; -- 5 SELECT DISTINCT department FROM employees; -- 6 SELECT * FROM employees WHERE department = &#39;Sales&#39;; -- 7 SELECT * FROM employees WHERE department = &#39;Sales&#39; AND salary &gt; 60000; -- 8 SELECT * FROM employees WHERE department = &#39;Sales&#39; OR department = &#39;Marketing&#39;; -- 9 SELECT * FROM employees WHERE (department = &#39;Sales&#39; OR department = &#39;Marketing&#39;) AND salary &gt; 70000; -- 10 SELECT * FROM employees WHERE NOT department = &#39;IT&#39;; PySpark # 1 df.show() # 2 df.select(&#34;first_name&#34;, &#34;last_name&#34;, &#34;hire_date&#34;).show() # 3 df.count() # 4 df.select(F.count(&#34;salary&#34;)).show() # 5 df.select(&#34;department&#34;).distinct().show() # 6 df.filter(col(&#34;department&#34;) == &#34;Sales&#34;).show() # 7 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) &amp; (col(&#34;salary&#34;) &gt; 60000)).show() # 8 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)).show() # 9 df.filter(((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)) &amp; (col(&#34;salary&#34;) &gt; 70000)).show() # 10 df.filter(col(&#34;department&#34;) != &#34;IT&#34;).show() ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20) SQL -- 11 SELECT * FROM employees WHERE department IN (&#39;Sales&#39;, &#39;Marketing&#39;, &#39;IT&#39;); -- 12 SELECT * FROM employees WHERE department NOT IN (&#39;Sales&#39;, &#39;Marketing&#39;); -- 13 SELECT * FROM employees WHERE salary BETWEEN 50000 AND 75000; -- 14 SELECT * FROM employees WHERE first_name ILIKE &#39;%jo%&#39;; -- 15 SELECT * FROM employees WHERE last_name LIKE &#39;Smi%&#39;; -- 16 SELECT * FROM employees WHERE email LIKE &#39;%@gmail.com&#39;; -- 17 SELECT * FROM employees WHERE first_name LIKE &#39;_a%&#39;; -- 18 SELECT * FROM employees WHERE manager_id IS NULL; -- 19 SELECT * FROM employees WHERE manager_id IS NOT NULL; -- 20 SELECT * FROM employees WHERE hire_date BETWEEN &#39;2023-01-01&#39; AND &#39;2023-12-31&#39;; PySpark # 11 df.filter(col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;, &#34;IT&#34;)).show() # 12 df.filter(~col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;)).show() # 13 df.filter(col(&#34;salary&#34;).between(50000, 75000)).show() # 14 (case-insensitive search) df.filter(lower(col(&#34;first_name&#34;)).like(&#34;%jo%&#34;)).show() # 15 df.filter(col(&#34;last_name&#34;).startswith(&#34;Smi&#34;)).show() # 16 df.filter(col(&#34;email&#34;).endswith(&#34;@gmail.com&#34;)).show() # 17 (single char then &#39;a&#39;) df.filter(col(&#34;first_name&#34;).rlike(&#34;^.a.*&#34;)).show() # 18 df.filter(col(&#34;manager_id&#34;).isNull()).show() # 19 df.filter(col(&#34;manager_id&#34;).isNotNull()).show() # 20 df.filter(col(&#34;hire_date&#34;).between(&#34;2023-01-01&#34;, &#34;2023-12-31&#34;)).show() â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30) SQL -- 21 SELECT * FROM employees ORDER BY last_name ASC; -- 22 SELECT * FROM employees ORDER BY salary DESC; -- 23 SELECT * FROM employees ORDER BY department ASC, salary DESC; -- 24 SELECT * FROM employees ORDER BY salary DESC LIMIT 10; -- 25 SELECT * FROM employees ORDER BY hire_date DESC LIMIT 5; -- 26 SELECT DISTINCT department FROM employees ORDER BY department; -- 27 SELECT * FROM employees ORDER BY employee_id OFFSET 10 LIMIT 10; -- 28 SELECT * FROM employees ORDER BY salary DESC LIMIT 1; -- 29 SELECT DISTINCT salary FROM employees ORDER BY salary DESC LIMIT 1 OFFSET 1; -- 30 SELECT first_name, last_name, (salary * 0.1) AS bonus FROM employees ORDER BY bonus DESC; PySpark # 21 df.orderBy(col(&#34;last_name&#34;).asc()).show() # 22 df.orderBy(col(&#34;salary&#34;).desc()).show() # 23 df.orderBy(col(&#34;department&#34;).asc(), col(&#34;salary&#34;).desc()).show() # 24 df.orderBy(col(&#34;salary&#34;).desc()).limit(10).show() # 25 df.orderBy(col(&#34;hire_date&#34;).desc()).limit(5).show() # 26 df.select(&#34;department&#34;).distinct().orderBy(&#34;department&#34;).show() # 27 (rows 11â€“20): use ROW_NUMBER then filter w = Window.orderBy(&#34;employee_id&#34;) df.withColumn(&#34;rn&#34;, row_number().over(w)).filter((col(&#34;rn&#34;) &gt;= 11) &amp; (col(&#34;rn&#34;) &lt;= 20)).drop(&#34;rn&#34;).show() # 28 df.orderBy(col(&#34;salary&#34;).desc()).limit(1).show() # 29 (second-highest salary) â€“ two ways df.select(&#34;salary&#34;).distinct().orderBy(col(&#34;salary&#34;).desc()).limit(2).orderBy(col(&#34;salary&#34;).asc()).limit(1).show() # or using dense_rank w2 = Window.orderBy(col(&#34;salary&#34;).desc()) df.select(&#34;salary&#34;, dense_rank().over(w2).alias(&#34;dr&#34;)).filter(col(&#34;dr&#34;) == 2).select(&#34;salary&#34;).distinct().show() # 30 df.select(&#34;first_name&#34;, &#34;last_name&#34;, (col(&#34;salary&#34;) * 0.1).alias(&#34;bonus&#34;)).orderBy(col(&#34;bonus&#34;).desc()).show() ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40) SQL -- 31 SELECT department, COUNT(*) FROM employees GROUP BY department; -- 32 SELECT department, AVG(salary) FROM employees GROUP BY department; -- 33 SELECT department, SUM(salary) FROM employees GROUP BY department; -- 34 SELECT department, MAX(salary) FROM employees GROUP BY department; -- 35 SELECT department, MIN(salary) FROM employees GROUP BY department; -- 36 SELECT department, AVG(salary) FROM employees GROUP BY department HAVING AVG(salary) &gt; 65000; -- 37 SELECT department, COUNT(*) FROM employees GROUP BY department HAVING COUNT(*) &gt; 5; -- 38 SELECT department, AVG(salary) FROM employees WHERE hire_date &gt; &#39;2022-01-01&#39; GROUP BY department; -- 39 SELECT department, job_title, AVG(salary) FROM employees GROUP BY department, job_title; -- 40 SELECT department, MAX(salary) FROM employees GROUP BY department; PySpark # 31 df.groupBy(&#34;department&#34;).count().show() # 32 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 33 df.groupBy(&#34;department&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 34 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() # 35 df.groupBy(&#34;department&#34;).agg(min(&#34;salary&#34;).alias(&#34;min_salary&#34;)).show() # 36 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).filter(col(&#34;avg_salary&#34;) &gt; 65000).show() # 37 df.groupBy(&#34;department&#34;).count().filter(col(&#34;count&#34;) &gt; 5).show() # 38 df.filter(col(&#34;hire_date&#34;) &gt; &#34;2022-01-01&#34;).groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;)).show() # 39 df.groupBy(&#34;department&#34;, &#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 40 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() ðŸ”— Section 5: Joins (41â€“60) SQL -- 41 SELECT e.first_name, d.department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id; -- 42 SELECT e.first_name, d.department_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id; -- 43 SELECT e.first_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id WHERE d.department_id IS NULL; -- 44 SELECT e.first_name, d.department_name FROM employees e RIGHT JOIN departments d ON e.department_id = d.department_id; -- 45 SELECT e.first_name, d.department_name FROM employees e FULL OUTER JOIN departments d ON e.department_id = d.department_id; -- 46 SELECT e.first_name, p.project_name, d.department_name FROM employees e JOIN projects p ON e.employee_id = p.employee_id JOIN departments d ON e.department_id = d.department_id; -- 47 SELECT e.first_name AS employee, m.first_name AS manager FROM employees e JOIN employees m ON e.manager_id = m.employee_id; -- 48 SELECT o.order_id, c.customer_name FROM orders o JOIN customers c ON o.customer_zip_code = c.customer_zip_code; -- 49 SELECT * FROM employees CROSS JOIN departments; -- 50 SELECT p.* FROM products p LEFT JOIN sales s ON p.product_id = s.product_id WHERE s.sale_id IS NULL; -- 51 SELECT e.first_name, e.last_name FROM employees e LEFT JOIN employee_projects ep ON e.employee_id = ep.employee_id WHERE ep.project_id IS NULL; -- 52 SELECT p.project_name FROM projects p LEFT JOIN employee_projects ep ON p.project_id = ep.project_id WHERE ep.employee_id IS NULL; -- 53 SELECT d.department_name, SUM(e.salary) AS total_salary FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 54 SELECT d.department_name, COUNT(e.employee_id) AS num_employees FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 55 SELECT o.*, c.customer_name FROM orders o JOIN customers c ON o.customer_id = c.customer_id AND o.order_date = c.last_purchase_date; -- 56 SELECT e.first_name, m.first_name AS manager_name, d.department_name FROM employees e JOIN employees m ON e.manager_id = m.employee_id JOIN departments d ON m.department_id = d.department_id; -- 57 SELECT e.employee_id, h.salary_grade FROM employees e JOIN salary_grades h ON e.salary BETWEEN h.min_salary AND h.max_salary; -- 58 SELECT e.first_name, d.department_name FROM employees e JOIN departments d ON e.department_id = d.department_id WHERE d.location_city = &#39;New York&#39;; -- 59 SELECT d.department_name, AVG(e.salary) AS avg_salary FROM employees e JOIN departments d ON e.department_id = d.department_id GROUP BY d.department_name; -- 60 SELECT a.order_id, b.item_name FROM table_a a JOIN table_b b ON a.product_id = b.item_id; PySpark # 41 employees.join(departments, &#34;department_id&#34;, &#34;inner&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 42 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 43 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;)\ .filter(departments.department_id.isNull())\ .select(employees.first_name).show() # 44 employees.join(departments, &#34;department_id&#34;, &#34;right&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 45 employees.join(departments, &#34;department_id&#34;, &#34;outer&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 46 employees.join(projects, &#34;employee_id&#34;)\ .join(departments, &#34;department_id&#34;)\ .select(&#34;first_name&#34;, &#34;project_name&#34;, &#34;department_name&#34;).show() # 47 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .select(col(&#34;e.first_name&#34;).alias(&#34;employee&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager&#34;)).show() # 48 orders.join(customers, orders.customer_zip_code == customers.customer_zip_code)\ .select(&#34;order_id&#34;, &#34;customer_name&#34;).show() # 49 employees.crossJoin(departments).show() # 50 products.join(sales, &#34;product_id&#34;, &#34;left&#34;)\ .filter(col(&#34;sale_id&#34;).isNull())\ .select(&#34;product_id&#34;, *[c for c in products.columns if c != &#34;product_id&#34;]).show() # 51 employees.join(employee_projects, &#34;employee_id&#34;, &#34;left&#34;)\ .filter(col(&#34;project_id&#34;).isNull())\ .select(&#34;first_name&#34;, &#34;last_name&#34;).show() # 52 projects.join(employee_projects, &#34;project_id&#34;, &#34;left&#34;)\ .filter(col(&#34;employee_id&#34;).isNull())\ .select(&#34;project_name&#34;).show() # 53 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 54 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(count(&#34;employee_id&#34;).alias(&#34;num_employees&#34;)).show() # 55 orders.join(customers, (orders.customer_id == customers.customer_id) &amp; (orders.order_date == customers.last_purchase_date))\ .select(orders[&#34;*&#34;], customers.customer_name).show() # 56 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;); d = departments.alias(&#34;d&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .join(d, col(&#34;m.department_id&#34;) == col(&#34;d.department_id&#34;))\ .select(col(&#34;e.first_name&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager_name&#34;), col(&#34;d.department_name&#34;)).show() # 57 employees.join(salary_grades, (employees.salary &gt;= salary_grades.min_salary) &amp; (employees.salary &lt;= salary_grades.max_salary))\ .select(&#34;employee_id&#34;, &#34;salary_grade&#34;).show() # 58 employees.join(departments, &#34;department_id&#34;)\ .filter(col(&#34;location_city&#34;) == &#34;New York&#34;)\ .select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 59 employees.join(departments, &#34;department_id&#34;)\ .groupBy(&#34;department_name&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 60 table_a.join(table_b, table_a.product_id == table_b.item_id)\ .select(table_a.order_id, table_b.item_name).show() ðŸ§  Section 6: Subqueries (61â€“75) SQL -- 61 SELECT * FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 62 SELECT * FROM employees WHERE department_id IN ( SELECT department_id FROM departments WHERE location_city = &#39;San Francisco&#39; ); -- 63 SELECT d.department_name, s.avg_salary FROM ( SELECT department_id, AVG(salary) AS avg_salary FROM employees GROUP BY department_id ) AS s JOIN departments d ON s.department_id = d.department_id; -- 64 SELECT first_name, salary, (SELECT AVG(salary) FROM employees) AS company_avg_salary FROM employees; -- 65 SELECT * FROM employees e WHERE salary &gt; (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id); -- 66 SELECT d.department_name FROM departments d WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id AND e.salary &gt; 100000); -- 67 SELECT d.department_name FROM departments d WHERE NOT EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id); -- 68 SELECT * FROM departments WHERE department_id IN (SELECT DISTINCT department_id FROM employees); -- 69 SELECT * FROM employees e WHERE EXISTS (SELECT 1 FROM orders o WHERE o.employee_id = e.employee_id); -- 70 SELECT d.department_name, (SELECT SUM(salary) FROM employees e WHERE e.department_id = d.department_id) AS total_department_salary FROM departments d; -- 71 SELECT department_name FROM departments WHERE department_id = ( SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary) DESC LIMIT 1 ); -- 72 SELECT customer_name FROM customers WHERE customer_id IN (SELECT customer_id FROM orders WHERE product_id = 123); -- 73 SELECT COUNT(*) FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 74 SELECT customer_name FROM customers WHERE customer_id NOT IN (SELECT DISTINCT customer_id FROM orders); -- 75 SELECT e.first_name, e.salary, e.job_title FROM employees e WHERE e.salary &lt; (SELECT AVG(salary) FROM employees WHERE job_title = e.job_title); PySpark # 61 avg_sal = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.filter(col(&#34;salary&#34;) &gt; avg_sal).show() # 62 sf_depts = departments.filter(col(&#34;location_city&#34;) == &#34;San Francisco&#34;).select(&#34;department_id&#34;).distinct() df.join(sf_depts, &#34;department_id&#34;).show() # 63 avg_df = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) avg_df.join(departments, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;avg_salary&#34;).show() # 64 avg_val = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.select(&#34;first_name&#34;, &#34;salary&#34;, lit(avg_val).alias(&#34;company_avg_salary&#34;)).show() # 65 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;dept_avg&#34;)) df.join(dept_avg, &#34;department_id&#34;).filter(col(&#34;salary&#34;) &gt; col(&#34;dept_avg&#34;)).show() # 66 high_paid = df.filter(col(&#34;salary&#34;) &gt; 100000).select(&#34;department_id&#34;).distinct() departments.join(high_paid, &#34;department_id&#34;).select(&#34;department_name&#34;).distinct().show() # 67 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;, &#34;left_anti&#34;).select(&#34;department_name&#34;).show() # 68 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;).show() # 69 df.join(orders.select(&#34;employee_id&#34;).distinct(), &#34;employee_id&#34;).select(df[&#34;*&#34;]).distinct().show() # 70 dept_totals = df.groupBy(&#34;department_id&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_department_salary&#34;)) departments.join(dept_totals, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;total_department_salary&#34;).show() # 71 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) top_dept = dept_avg.orderBy(col(&#34;avg_salary&#34;).desc()).limit(1) departments.join(top_dept, &#34;department_id&#34;).select(&#34;department_name&#34;).show() # 72 buyers = orders.filter(col(&#34;product_id&#34;) == 123).select(&#34;customer_id&#34;).distinct() customers.join(buyers, &#34;customer_id&#34;).select(&#34;customer_name&#34;).show() # 73 df.filter(col(&#34;salary&#34;) &gt; avg_sal).count() # 74 customers.join(orders.select(&#34;customer_id&#34;).distinct(), &#34;customer_id&#34;, &#34;left_anti&#34;).select(&#34;customer_name&#34;).show() # 75 job_avg = df.groupBy(&#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;job_avg&#34;)) df.join(job_avg, &#34;job_title&#34;).filter(col(&#34;salary&#34;) &lt; col(&#34;job_avg&#34;)).select(&#34;first_name&#34;, &#34;salary&#34;, &#34;job_title&#34;).show() ðŸªŸ Section 7: Window Functions (76â€“85) SQL -- 76 SELECT first_name, department, salary, ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees; -- 77 SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank FROM employees; -- 78 SELECT first_name, department, salary, DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank FROM employees; -- 79 SELECT first_name, salary, NTILE(4) OVER (ORDER BY salary DESC) AS quartile FROM employees; -- 80 SELECT order_date, total_amount, LEAD(total_amount, 1) OVER (ORDER BY order_date) AS next_order_amount FROM orders; -- 81 SELECT order_date, total_amount, LAG(total_amount, 1, 0) OVER (ORDER BY order_date) AS previous_order_amount FROM orders; -- 82 SELECT order_date, total_amount, SUM(total_amount) OVER (ORDER BY order_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total FROM orders; -- 83 SELECT order_date, total_amount, AVG(total_amount) OVER (ORDER BY order_date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg FROM orders; -- 84 SELECT * FROM ( SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees ) AS ranked_employees WHERE rn &lt;= 3; -- 85 SELECT product_id, SUM(sales) AS product_sales, SUM(SUM(sales)) OVER () AS total_sales, (SUM(sales) / SUM(SUM(sales)) OVER ()) * 100 AS percentage_of_total FROM sales GROUP BY product_id; PySpark w_dept = Window.partitionBy(&#34;department&#34;).orderBy(col(&#34;salary&#34;).desc()) # 76 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, row_number().over(w_dept).alias(&#34;rn&#34;)).show() # 77 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, rank().over(w_dept).alias(&#34;rank&#34;)).show() # 78 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, dense_rank().over(w_dept).alias(&#34;dense_rank&#34;)).show() # 79 df.select(&#34;first_name&#34;, &#34;salary&#34;, ntile(4).over(Window.orderBy(col(&#34;salary&#34;).desc())).alias(&#34;quartile&#34;)).show() # 80 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lead(&#34;total_amount&#34;, 1).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;next_order_amount&#34;)).show() # 81 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lag(&#34;total_amount&#34;, 1, 0).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;previous_order_amount&#34;)).show() # 82 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, F.sum(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;) .rowsBetween(Window.unboundedPreceding, Window.currentRow)).alias(&#34;running_total&#34;)).show() # 83 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, avg(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;).rowsBetween(-2, Window.currentRow)).alias(&#34;moving_avg&#34;)).show() # 84 df.withColumn(&#34;rn&#34;, rank().over(w_dept)).filter(col(&#34;rn&#34;) &lt;= 3).drop(&#34;rn&#34;).show() # 85 prod_sales = sales.groupBy(&#34;product_id&#34;).agg(sum(&#34;sales&#34;).alias(&#34;product_sales&#34;)) prod_sales.withColumn(&#34;total_sales&#34;, sum(&#34;product_sales&#34;).over(Window.partitionBy()))\ .withColumn(&#34;percentage_of_total&#34;, (col(&#34;product_sales&#34;) / col(&#34;total_sales&#34;)) * 100)\ .select(&#34;product_id&#34;, &#34;product_sales&#34;, &#34;total_sales&#34;, &#34;percentage_of_total&#34;).show() ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100) SQL -- 86 WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary; -- 87 INSERT INTO employees (first_name, last_name, salary) VALUES (&#39;John&#39;, &#39;Doe&#39;, 60000); -- 88 UPDATE employees SET salary = salary * 1.05 WHERE department = &#39;IT&#39;; -- 89 DELETE FROM employees WHERE employee_id = 101; -- 90 TRUNCATE TABLE old_data; -- 91 SELECT first_name FROM employees UNION SELECT first_name FROM customers; -- 92 SELECT first_name FROM employees UNION ALL SELECT first_name FROM customers; -- 93 SELECT first_name, salary, CASE WHEN salary &gt; 100000 THEN &#39;High Earner&#39; WHEN salary BETWEEN 50000 AND 100000 THEN &#39;Mid-Range&#39; ELSE &#39;Junior&#39; END AS salary_level FROM employees; -- 94 SELECT department, COUNT(CASE WHEN salary &gt; 70000 THEN 1 END) AS high_salary_count, COUNT(CASE WHEN salary &lt;= 70000 THEN 1 END) AS low_salary_count FROM employees GROUP BY department; -- 95 SELECT CAST(order_date AS DATE) FROM orders; -- 96 SELECT COALESCE(email, &#39;No Email Provided&#39;) FROM employees; -- 97 SELECT NULLIF(salary, 0) FROM employees; -- 98 (Recursive CTE) WITH RECURSIVE subordinates AS ( SELECT employee_id, manager_id FROM employees WHERE employee_id = 1 UNION ALL SELECT e.employee_id, e.manager_id FROM employees e JOIN subordinates s ON e.manager_id = s.employee_id ) SELECT * FROM subordinates; -- 99 SELECT department, job_title, SUM(salary) FROM employees GROUP BY GROUPING SETS ((department), (job_title), ()); -- 100 SELECT department, job_title, SUM(salary) FROM employees GROUP BY ROLLUP(department, job_title); PySpark # 86 (Use SQL CTE via temp view) df.createOrReplaceTempView(&#34;employees&#34;) spark.sql(&#34;&#34;&#34; WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary &#34;&#34;&#34;).show() # 87 (Insert-like: union new rows) df_new = spark.createDataFrame([(&#34;John&#34;, &#34;Doe&#34;, 60000)], [&#34;first_name&#34;, &#34;last_name&#34;, &#34;salary&#34;]) df = df.unionByName(df_new) # 88 (Update-like) df = df.withColumn(&#34;salary&#34;, when(col(&#34;department&#34;) == &#34;IT&#34;, col(&#34;salary&#34;) * 1.05).otherwise(col(&#34;salary&#34;))) # 89 (Delete-like) df = df.filter(col(&#34;employee_id&#34;) != 101) # 90 (Truncate-like in-memory) df = df.limit(0) # for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;) # 91 UNION (distinct) df_union_distinct = df1.union(df2).distinct() # 92 UNION ALL df_union_all = df1.union(df2) # 93 CASE/WHEN df.select(&#34;first_name&#34;, &#34;salary&#34;, when(col(&#34;salary&#34;) &gt; 100000, &#34;High Earner&#34;) .when((col(&#34;salary&#34;) &gt;= 50000) &amp; (col(&#34;salary&#34;) &lt;= 100000), &#34;Mid-Range&#34;) .otherwise(&#34;Junior&#34;).alias(&#34;salary_level&#34;)).show() # 94 Pivot without true pivot df.groupBy(&#34;department&#34;).agg( count(when(col(&#34;salary&#34;) &gt; 70000, 1)).alias(&#34;high_salary_count&#34;), count(when(col(&#34;salary&#34;) &lt;= 70000, 1)).alias(&#34;low_salary_count&#34;) ).show() # 95 CAST orders.select(col(&#34;order_date&#34;).cast(&#34;date&#34;).alias(&#34;order_date&#34;)).show() # 96 COALESCE df.select(coalesce(col(&#34;email&#34;), lit(&#34;No Email Provided&#34;)).alias(&#34;email&#34;)).show() # 97 NULLIF(salary,0) =&gt; NULL when equal df.select(when(col(&#34;salary&#34;) == 0, lit(None)).otherwise(col(&#34;salary&#34;)).alias(&#34;salary_or_null&#34;)).show() # 98 Recursive CTE not native; iterative approach example (hierarchy traversal) # Start with seed seed = df.filter(col(&#34;employee_id&#34;) == 1).select(&#34;employee_id&#34;, &#34;manager_id&#34;) result = seed frontier = seed while True: step = df.select(&#34;employee_id&#34;, &#34;manager_id&#34;)\ .join(frontier, df.manager_id == frontier.employee_id, &#34;inner&#34;)\ .select(df.employee_id, df.manager_id).dropDuplicates() new_nodes = step.join(result, [&#34;employee_id&#34;, &#34;manager_id&#34;], &#34;left_anti&#34;) if new_nodes.rdd.isEmpty(): break result = result.unionByName(new_nodes).dropDuplicates() frontier = new_nodes # result contains recursive closure # 99 GROUPING SETS -&gt; cube with filters cube_df = df.cube(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)) # Keep only grouping sets: (department), (job_title), () from pyspark.sql.functions import grouping_id cube_df.filter( (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 1) | # (department,NULL) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 2) | # (NULL,job_title) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 3) # (NULL,NULL) ).show() # 100 ROLLUP df.rollup(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)).show() âœ… Notes Some SQL constructs (OFFSET, Recursive CTE) donâ€™t map 1:1 to PySpark; patterns above show practical equivalents. Replace .show() with .write.format(&#34;delta&#34;)... to persist as needed.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="SQL & PySpark Queries :: Data Engineering Notes">
    <meta name="twitter:description" content="This guide pairs each SQL example with a PySpark DataFrame API equivalent.
Assumptions: df is employees, and other tables are similarly named DataFrames (departments, orders, etc.).
Imports used in PySpark examples
from pyspark.sql import functions as F from pyspark.sql.functions import col, lit, when, lower, upper, count, sum, avg, max, min, row_number, rank, dense_rank, ntile, lead, lag, coalesce from pyspark.sql.window import Window ðŸ§© Section 1: Basic Queries (1â€“10) SQL -- 1 SELECT * FROM employees; -- 2 SELECT first_name, last_name, hire_date FROM employees; -- 3 SELECT COUNT(*) FROM employees; -- 4 SELECT COUNT(salary) FROM employees; -- 5 SELECT DISTINCT department FROM employees; -- 6 SELECT * FROM employees WHERE department = &#39;Sales&#39;; -- 7 SELECT * FROM employees WHERE department = &#39;Sales&#39; AND salary &gt; 60000; -- 8 SELECT * FROM employees WHERE department = &#39;Sales&#39; OR department = &#39;Marketing&#39;; -- 9 SELECT * FROM employees WHERE (department = &#39;Sales&#39; OR department = &#39;Marketing&#39;) AND salary &gt; 70000; -- 10 SELECT * FROM employees WHERE NOT department = &#39;IT&#39;; PySpark # 1 df.show() # 2 df.select(&#34;first_name&#34;, &#34;last_name&#34;, &#34;hire_date&#34;).show() # 3 df.count() # 4 df.select(F.count(&#34;salary&#34;)).show() # 5 df.select(&#34;department&#34;).distinct().show() # 6 df.filter(col(&#34;department&#34;) == &#34;Sales&#34;).show() # 7 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) &amp; (col(&#34;salary&#34;) &gt; 60000)).show() # 8 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)).show() # 9 df.filter(((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)) &amp; (col(&#34;salary&#34;) &gt; 70000)).show() # 10 df.filter(col(&#34;department&#34;) != &#34;IT&#34;).show() ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20) SQL -- 11 SELECT * FROM employees WHERE department IN (&#39;Sales&#39;, &#39;Marketing&#39;, &#39;IT&#39;); -- 12 SELECT * FROM employees WHERE department NOT IN (&#39;Sales&#39;, &#39;Marketing&#39;); -- 13 SELECT * FROM employees WHERE salary BETWEEN 50000 AND 75000; -- 14 SELECT * FROM employees WHERE first_name ILIKE &#39;%jo%&#39;; -- 15 SELECT * FROM employees WHERE last_name LIKE &#39;Smi%&#39;; -- 16 SELECT * FROM employees WHERE email LIKE &#39;%@gmail.com&#39;; -- 17 SELECT * FROM employees WHERE first_name LIKE &#39;_a%&#39;; -- 18 SELECT * FROM employees WHERE manager_id IS NULL; -- 19 SELECT * FROM employees WHERE manager_id IS NOT NULL; -- 20 SELECT * FROM employees WHERE hire_date BETWEEN &#39;2023-01-01&#39; AND &#39;2023-12-31&#39;; PySpark # 11 df.filter(col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;, &#34;IT&#34;)).show() # 12 df.filter(~col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;)).show() # 13 df.filter(col(&#34;salary&#34;).between(50000, 75000)).show() # 14 (case-insensitive search) df.filter(lower(col(&#34;first_name&#34;)).like(&#34;%jo%&#34;)).show() # 15 df.filter(col(&#34;last_name&#34;).startswith(&#34;Smi&#34;)).show() # 16 df.filter(col(&#34;email&#34;).endswith(&#34;@gmail.com&#34;)).show() # 17 (single char then &#39;a&#39;) df.filter(col(&#34;first_name&#34;).rlike(&#34;^.a.*&#34;)).show() # 18 df.filter(col(&#34;manager_id&#34;).isNull()).show() # 19 df.filter(col(&#34;manager_id&#34;).isNotNull()).show() # 20 df.filter(col(&#34;hire_date&#34;).between(&#34;2023-01-01&#34;, &#34;2023-12-31&#34;)).show() â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30) SQL -- 21 SELECT * FROM employees ORDER BY last_name ASC; -- 22 SELECT * FROM employees ORDER BY salary DESC; -- 23 SELECT * FROM employees ORDER BY department ASC, salary DESC; -- 24 SELECT * FROM employees ORDER BY salary DESC LIMIT 10; -- 25 SELECT * FROM employees ORDER BY hire_date DESC LIMIT 5; -- 26 SELECT DISTINCT department FROM employees ORDER BY department; -- 27 SELECT * FROM employees ORDER BY employee_id OFFSET 10 LIMIT 10; -- 28 SELECT * FROM employees ORDER BY salary DESC LIMIT 1; -- 29 SELECT DISTINCT salary FROM employees ORDER BY salary DESC LIMIT 1 OFFSET 1; -- 30 SELECT first_name, last_name, (salary * 0.1) AS bonus FROM employees ORDER BY bonus DESC; PySpark # 21 df.orderBy(col(&#34;last_name&#34;).asc()).show() # 22 df.orderBy(col(&#34;salary&#34;).desc()).show() # 23 df.orderBy(col(&#34;department&#34;).asc(), col(&#34;salary&#34;).desc()).show() # 24 df.orderBy(col(&#34;salary&#34;).desc()).limit(10).show() # 25 df.orderBy(col(&#34;hire_date&#34;).desc()).limit(5).show() # 26 df.select(&#34;department&#34;).distinct().orderBy(&#34;department&#34;).show() # 27 (rows 11â€“20): use ROW_NUMBER then filter w = Window.orderBy(&#34;employee_id&#34;) df.withColumn(&#34;rn&#34;, row_number().over(w)).filter((col(&#34;rn&#34;) &gt;= 11) &amp; (col(&#34;rn&#34;) &lt;= 20)).drop(&#34;rn&#34;).show() # 28 df.orderBy(col(&#34;salary&#34;).desc()).limit(1).show() # 29 (second-highest salary) â€“ two ways df.select(&#34;salary&#34;).distinct().orderBy(col(&#34;salary&#34;).desc()).limit(2).orderBy(col(&#34;salary&#34;).asc()).limit(1).show() # or using dense_rank w2 = Window.orderBy(col(&#34;salary&#34;).desc()) df.select(&#34;salary&#34;, dense_rank().over(w2).alias(&#34;dr&#34;)).filter(col(&#34;dr&#34;) == 2).select(&#34;salary&#34;).distinct().show() # 30 df.select(&#34;first_name&#34;, &#34;last_name&#34;, (col(&#34;salary&#34;) * 0.1).alias(&#34;bonus&#34;)).orderBy(col(&#34;bonus&#34;).desc()).show() ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40) SQL -- 31 SELECT department, COUNT(*) FROM employees GROUP BY department; -- 32 SELECT department, AVG(salary) FROM employees GROUP BY department; -- 33 SELECT department, SUM(salary) FROM employees GROUP BY department; -- 34 SELECT department, MAX(salary) FROM employees GROUP BY department; -- 35 SELECT department, MIN(salary) FROM employees GROUP BY department; -- 36 SELECT department, AVG(salary) FROM employees GROUP BY department HAVING AVG(salary) &gt; 65000; -- 37 SELECT department, COUNT(*) FROM employees GROUP BY department HAVING COUNT(*) &gt; 5; -- 38 SELECT department, AVG(salary) FROM employees WHERE hire_date &gt; &#39;2022-01-01&#39; GROUP BY department; -- 39 SELECT department, job_title, AVG(salary) FROM employees GROUP BY department, job_title; -- 40 SELECT department, MAX(salary) FROM employees GROUP BY department; PySpark # 31 df.groupBy(&#34;department&#34;).count().show() # 32 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 33 df.groupBy(&#34;department&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 34 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() # 35 df.groupBy(&#34;department&#34;).agg(min(&#34;salary&#34;).alias(&#34;min_salary&#34;)).show() # 36 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).filter(col(&#34;avg_salary&#34;) &gt; 65000).show() # 37 df.groupBy(&#34;department&#34;).count().filter(col(&#34;count&#34;) &gt; 5).show() # 38 df.filter(col(&#34;hire_date&#34;) &gt; &#34;2022-01-01&#34;).groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;)).show() # 39 df.groupBy(&#34;department&#34;, &#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 40 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() ðŸ”— Section 5: Joins (41â€“60) SQL -- 41 SELECT e.first_name, d.department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id; -- 42 SELECT e.first_name, d.department_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id; -- 43 SELECT e.first_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id WHERE d.department_id IS NULL; -- 44 SELECT e.first_name, d.department_name FROM employees e RIGHT JOIN departments d ON e.department_id = d.department_id; -- 45 SELECT e.first_name, d.department_name FROM employees e FULL OUTER JOIN departments d ON e.department_id = d.department_id; -- 46 SELECT e.first_name, p.project_name, d.department_name FROM employees e JOIN projects p ON e.employee_id = p.employee_id JOIN departments d ON e.department_id = d.department_id; -- 47 SELECT e.first_name AS employee, m.first_name AS manager FROM employees e JOIN employees m ON e.manager_id = m.employee_id; -- 48 SELECT o.order_id, c.customer_name FROM orders o JOIN customers c ON o.customer_zip_code = c.customer_zip_code; -- 49 SELECT * FROM employees CROSS JOIN departments; -- 50 SELECT p.* FROM products p LEFT JOIN sales s ON p.product_id = s.product_id WHERE s.sale_id IS NULL; -- 51 SELECT e.first_name, e.last_name FROM employees e LEFT JOIN employee_projects ep ON e.employee_id = ep.employee_id WHERE ep.project_id IS NULL; -- 52 SELECT p.project_name FROM projects p LEFT JOIN employee_projects ep ON p.project_id = ep.project_id WHERE ep.employee_id IS NULL; -- 53 SELECT d.department_name, SUM(e.salary) AS total_salary FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 54 SELECT d.department_name, COUNT(e.employee_id) AS num_employees FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 55 SELECT o.*, c.customer_name FROM orders o JOIN customers c ON o.customer_id = c.customer_id AND o.order_date = c.last_purchase_date; -- 56 SELECT e.first_name, m.first_name AS manager_name, d.department_name FROM employees e JOIN employees m ON e.manager_id = m.employee_id JOIN departments d ON m.department_id = d.department_id; -- 57 SELECT e.employee_id, h.salary_grade FROM employees e JOIN salary_grades h ON e.salary BETWEEN h.min_salary AND h.max_salary; -- 58 SELECT e.first_name, d.department_name FROM employees e JOIN departments d ON e.department_id = d.department_id WHERE d.location_city = &#39;New York&#39;; -- 59 SELECT d.department_name, AVG(e.salary) AS avg_salary FROM employees e JOIN departments d ON e.department_id = d.department_id GROUP BY d.department_name; -- 60 SELECT a.order_id, b.item_name FROM table_a a JOIN table_b b ON a.product_id = b.item_id; PySpark # 41 employees.join(departments, &#34;department_id&#34;, &#34;inner&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 42 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 43 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;)\ .filter(departments.department_id.isNull())\ .select(employees.first_name).show() # 44 employees.join(departments, &#34;department_id&#34;, &#34;right&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 45 employees.join(departments, &#34;department_id&#34;, &#34;outer&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 46 employees.join(projects, &#34;employee_id&#34;)\ .join(departments, &#34;department_id&#34;)\ .select(&#34;first_name&#34;, &#34;project_name&#34;, &#34;department_name&#34;).show() # 47 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .select(col(&#34;e.first_name&#34;).alias(&#34;employee&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager&#34;)).show() # 48 orders.join(customers, orders.customer_zip_code == customers.customer_zip_code)\ .select(&#34;order_id&#34;, &#34;customer_name&#34;).show() # 49 employees.crossJoin(departments).show() # 50 products.join(sales, &#34;product_id&#34;, &#34;left&#34;)\ .filter(col(&#34;sale_id&#34;).isNull())\ .select(&#34;product_id&#34;, *[c for c in products.columns if c != &#34;product_id&#34;]).show() # 51 employees.join(employee_projects, &#34;employee_id&#34;, &#34;left&#34;)\ .filter(col(&#34;project_id&#34;).isNull())\ .select(&#34;first_name&#34;, &#34;last_name&#34;).show() # 52 projects.join(employee_projects, &#34;project_id&#34;, &#34;left&#34;)\ .filter(col(&#34;employee_id&#34;).isNull())\ .select(&#34;project_name&#34;).show() # 53 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 54 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(count(&#34;employee_id&#34;).alias(&#34;num_employees&#34;)).show() # 55 orders.join(customers, (orders.customer_id == customers.customer_id) &amp; (orders.order_date == customers.last_purchase_date))\ .select(orders[&#34;*&#34;], customers.customer_name).show() # 56 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;); d = departments.alias(&#34;d&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .join(d, col(&#34;m.department_id&#34;) == col(&#34;d.department_id&#34;))\ .select(col(&#34;e.first_name&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager_name&#34;), col(&#34;d.department_name&#34;)).show() # 57 employees.join(salary_grades, (employees.salary &gt;= salary_grades.min_salary) &amp; (employees.salary &lt;= salary_grades.max_salary))\ .select(&#34;employee_id&#34;, &#34;salary_grade&#34;).show() # 58 employees.join(departments, &#34;department_id&#34;)\ .filter(col(&#34;location_city&#34;) == &#34;New York&#34;)\ .select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 59 employees.join(departments, &#34;department_id&#34;)\ .groupBy(&#34;department_name&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 60 table_a.join(table_b, table_a.product_id == table_b.item_id)\ .select(table_a.order_id, table_b.item_name).show() ðŸ§  Section 6: Subqueries (61â€“75) SQL -- 61 SELECT * FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 62 SELECT * FROM employees WHERE department_id IN ( SELECT department_id FROM departments WHERE location_city = &#39;San Francisco&#39; ); -- 63 SELECT d.department_name, s.avg_salary FROM ( SELECT department_id, AVG(salary) AS avg_salary FROM employees GROUP BY department_id ) AS s JOIN departments d ON s.department_id = d.department_id; -- 64 SELECT first_name, salary, (SELECT AVG(salary) FROM employees) AS company_avg_salary FROM employees; -- 65 SELECT * FROM employees e WHERE salary &gt; (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id); -- 66 SELECT d.department_name FROM departments d WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id AND e.salary &gt; 100000); -- 67 SELECT d.department_name FROM departments d WHERE NOT EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id); -- 68 SELECT * FROM departments WHERE department_id IN (SELECT DISTINCT department_id FROM employees); -- 69 SELECT * FROM employees e WHERE EXISTS (SELECT 1 FROM orders o WHERE o.employee_id = e.employee_id); -- 70 SELECT d.department_name, (SELECT SUM(salary) FROM employees e WHERE e.department_id = d.department_id) AS total_department_salary FROM departments d; -- 71 SELECT department_name FROM departments WHERE department_id = ( SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary) DESC LIMIT 1 ); -- 72 SELECT customer_name FROM customers WHERE customer_id IN (SELECT customer_id FROM orders WHERE product_id = 123); -- 73 SELECT COUNT(*) FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 74 SELECT customer_name FROM customers WHERE customer_id NOT IN (SELECT DISTINCT customer_id FROM orders); -- 75 SELECT e.first_name, e.salary, e.job_title FROM employees e WHERE e.salary &lt; (SELECT AVG(salary) FROM employees WHERE job_title = e.job_title); PySpark # 61 avg_sal = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.filter(col(&#34;salary&#34;) &gt; avg_sal).show() # 62 sf_depts = departments.filter(col(&#34;location_city&#34;) == &#34;San Francisco&#34;).select(&#34;department_id&#34;).distinct() df.join(sf_depts, &#34;department_id&#34;).show() # 63 avg_df = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) avg_df.join(departments, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;avg_salary&#34;).show() # 64 avg_val = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.select(&#34;first_name&#34;, &#34;salary&#34;, lit(avg_val).alias(&#34;company_avg_salary&#34;)).show() # 65 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;dept_avg&#34;)) df.join(dept_avg, &#34;department_id&#34;).filter(col(&#34;salary&#34;) &gt; col(&#34;dept_avg&#34;)).show() # 66 high_paid = df.filter(col(&#34;salary&#34;) &gt; 100000).select(&#34;department_id&#34;).distinct() departments.join(high_paid, &#34;department_id&#34;).select(&#34;department_name&#34;).distinct().show() # 67 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;, &#34;left_anti&#34;).select(&#34;department_name&#34;).show() # 68 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;).show() # 69 df.join(orders.select(&#34;employee_id&#34;).distinct(), &#34;employee_id&#34;).select(df[&#34;*&#34;]).distinct().show() # 70 dept_totals = df.groupBy(&#34;department_id&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_department_salary&#34;)) departments.join(dept_totals, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;total_department_salary&#34;).show() # 71 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) top_dept = dept_avg.orderBy(col(&#34;avg_salary&#34;).desc()).limit(1) departments.join(top_dept, &#34;department_id&#34;).select(&#34;department_name&#34;).show() # 72 buyers = orders.filter(col(&#34;product_id&#34;) == 123).select(&#34;customer_id&#34;).distinct() customers.join(buyers, &#34;customer_id&#34;).select(&#34;customer_name&#34;).show() # 73 df.filter(col(&#34;salary&#34;) &gt; avg_sal).count() # 74 customers.join(orders.select(&#34;customer_id&#34;).distinct(), &#34;customer_id&#34;, &#34;left_anti&#34;).select(&#34;customer_name&#34;).show() # 75 job_avg = df.groupBy(&#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;job_avg&#34;)) df.join(job_avg, &#34;job_title&#34;).filter(col(&#34;salary&#34;) &lt; col(&#34;job_avg&#34;)).select(&#34;first_name&#34;, &#34;salary&#34;, &#34;job_title&#34;).show() ðŸªŸ Section 7: Window Functions (76â€“85) SQL -- 76 SELECT first_name, department, salary, ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees; -- 77 SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank FROM employees; -- 78 SELECT first_name, department, salary, DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank FROM employees; -- 79 SELECT first_name, salary, NTILE(4) OVER (ORDER BY salary DESC) AS quartile FROM employees; -- 80 SELECT order_date, total_amount, LEAD(total_amount, 1) OVER (ORDER BY order_date) AS next_order_amount FROM orders; -- 81 SELECT order_date, total_amount, LAG(total_amount, 1, 0) OVER (ORDER BY order_date) AS previous_order_amount FROM orders; -- 82 SELECT order_date, total_amount, SUM(total_amount) OVER (ORDER BY order_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total FROM orders; -- 83 SELECT order_date, total_amount, AVG(total_amount) OVER (ORDER BY order_date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg FROM orders; -- 84 SELECT * FROM ( SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees ) AS ranked_employees WHERE rn &lt;= 3; -- 85 SELECT product_id, SUM(sales) AS product_sales, SUM(SUM(sales)) OVER () AS total_sales, (SUM(sales) / SUM(SUM(sales)) OVER ()) * 100 AS percentage_of_total FROM sales GROUP BY product_id; PySpark w_dept = Window.partitionBy(&#34;department&#34;).orderBy(col(&#34;salary&#34;).desc()) # 76 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, row_number().over(w_dept).alias(&#34;rn&#34;)).show() # 77 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, rank().over(w_dept).alias(&#34;rank&#34;)).show() # 78 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, dense_rank().over(w_dept).alias(&#34;dense_rank&#34;)).show() # 79 df.select(&#34;first_name&#34;, &#34;salary&#34;, ntile(4).over(Window.orderBy(col(&#34;salary&#34;).desc())).alias(&#34;quartile&#34;)).show() # 80 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lead(&#34;total_amount&#34;, 1).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;next_order_amount&#34;)).show() # 81 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lag(&#34;total_amount&#34;, 1, 0).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;previous_order_amount&#34;)).show() # 82 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, F.sum(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;) .rowsBetween(Window.unboundedPreceding, Window.currentRow)).alias(&#34;running_total&#34;)).show() # 83 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, avg(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;).rowsBetween(-2, Window.currentRow)).alias(&#34;moving_avg&#34;)).show() # 84 df.withColumn(&#34;rn&#34;, rank().over(w_dept)).filter(col(&#34;rn&#34;) &lt;= 3).drop(&#34;rn&#34;).show() # 85 prod_sales = sales.groupBy(&#34;product_id&#34;).agg(sum(&#34;sales&#34;).alias(&#34;product_sales&#34;)) prod_sales.withColumn(&#34;total_sales&#34;, sum(&#34;product_sales&#34;).over(Window.partitionBy()))\ .withColumn(&#34;percentage_of_total&#34;, (col(&#34;product_sales&#34;) / col(&#34;total_sales&#34;)) * 100)\ .select(&#34;product_id&#34;, &#34;product_sales&#34;, &#34;total_sales&#34;, &#34;percentage_of_total&#34;).show() ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100) SQL -- 86 WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary; -- 87 INSERT INTO employees (first_name, last_name, salary) VALUES (&#39;John&#39;, &#39;Doe&#39;, 60000); -- 88 UPDATE employees SET salary = salary * 1.05 WHERE department = &#39;IT&#39;; -- 89 DELETE FROM employees WHERE employee_id = 101; -- 90 TRUNCATE TABLE old_data; -- 91 SELECT first_name FROM employees UNION SELECT first_name FROM customers; -- 92 SELECT first_name FROM employees UNION ALL SELECT first_name FROM customers; -- 93 SELECT first_name, salary, CASE WHEN salary &gt; 100000 THEN &#39;High Earner&#39; WHEN salary BETWEEN 50000 AND 100000 THEN &#39;Mid-Range&#39; ELSE &#39;Junior&#39; END AS salary_level FROM employees; -- 94 SELECT department, COUNT(CASE WHEN salary &gt; 70000 THEN 1 END) AS high_salary_count, COUNT(CASE WHEN salary &lt;= 70000 THEN 1 END) AS low_salary_count FROM employees GROUP BY department; -- 95 SELECT CAST(order_date AS DATE) FROM orders; -- 96 SELECT COALESCE(email, &#39;No Email Provided&#39;) FROM employees; -- 97 SELECT NULLIF(salary, 0) FROM employees; -- 98 (Recursive CTE) WITH RECURSIVE subordinates AS ( SELECT employee_id, manager_id FROM employees WHERE employee_id = 1 UNION ALL SELECT e.employee_id, e.manager_id FROM employees e JOIN subordinates s ON e.manager_id = s.employee_id ) SELECT * FROM subordinates; -- 99 SELECT department, job_title, SUM(salary) FROM employees GROUP BY GROUPING SETS ((department), (job_title), ()); -- 100 SELECT department, job_title, SUM(salary) FROM employees GROUP BY ROLLUP(department, job_title); PySpark # 86 (Use SQL CTE via temp view) df.createOrReplaceTempView(&#34;employees&#34;) spark.sql(&#34;&#34;&#34; WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary &#34;&#34;&#34;).show() # 87 (Insert-like: union new rows) df_new = spark.createDataFrame([(&#34;John&#34;, &#34;Doe&#34;, 60000)], [&#34;first_name&#34;, &#34;last_name&#34;, &#34;salary&#34;]) df = df.unionByName(df_new) # 88 (Update-like) df = df.withColumn(&#34;salary&#34;, when(col(&#34;department&#34;) == &#34;IT&#34;, col(&#34;salary&#34;) * 1.05).otherwise(col(&#34;salary&#34;))) # 89 (Delete-like) df = df.filter(col(&#34;employee_id&#34;) != 101) # 90 (Truncate-like in-memory) df = df.limit(0) # for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;) # 91 UNION (distinct) df_union_distinct = df1.union(df2).distinct() # 92 UNION ALL df_union_all = df1.union(df2) # 93 CASE/WHEN df.select(&#34;first_name&#34;, &#34;salary&#34;, when(col(&#34;salary&#34;) &gt; 100000, &#34;High Earner&#34;) .when((col(&#34;salary&#34;) &gt;= 50000) &amp; (col(&#34;salary&#34;) &lt;= 100000), &#34;Mid-Range&#34;) .otherwise(&#34;Junior&#34;).alias(&#34;salary_level&#34;)).show() # 94 Pivot without true pivot df.groupBy(&#34;department&#34;).agg( count(when(col(&#34;salary&#34;) &gt; 70000, 1)).alias(&#34;high_salary_count&#34;), count(when(col(&#34;salary&#34;) &lt;= 70000, 1)).alias(&#34;low_salary_count&#34;) ).show() # 95 CAST orders.select(col(&#34;order_date&#34;).cast(&#34;date&#34;).alias(&#34;order_date&#34;)).show() # 96 COALESCE df.select(coalesce(col(&#34;email&#34;), lit(&#34;No Email Provided&#34;)).alias(&#34;email&#34;)).show() # 97 NULLIF(salary,0) =&gt; NULL when equal df.select(when(col(&#34;salary&#34;) == 0, lit(None)).otherwise(col(&#34;salary&#34;)).alias(&#34;salary_or_null&#34;)).show() # 98 Recursive CTE not native; iterative approach example (hierarchy traversal) # Start with seed seed = df.filter(col(&#34;employee_id&#34;) == 1).select(&#34;employee_id&#34;, &#34;manager_id&#34;) result = seed frontier = seed while True: step = df.select(&#34;employee_id&#34;, &#34;manager_id&#34;)\ .join(frontier, df.manager_id == frontier.employee_id, &#34;inner&#34;)\ .select(df.employee_id, df.manager_id).dropDuplicates() new_nodes = step.join(result, [&#34;employee_id&#34;, &#34;manager_id&#34;], &#34;left_anti&#34;) if new_nodes.rdd.isEmpty(): break result = result.unionByName(new_nodes).dropDuplicates() frontier = new_nodes # result contains recursive closure # 99 GROUPING SETS -&gt; cube with filters cube_df = df.cube(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)) # Keep only grouping sets: (department), (job_title), () from pyspark.sql.functions import grouping_id cube_df.filter( (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 1) | # (department,NULL) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 2) | # (NULL,job_title) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 3) # (NULL,NULL) ).show() # 100 ROLLUP df.rollup(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)).show() âœ… Notes Some SQL constructs (OFFSET, Recursive CTE) donâ€™t map 1:1 to PySpark; patterns above show practical equivalents. Replace .show() with .write.format(&#34;delta&#34;)... to persist as needed.">
    <meta property="og:url" content="http://localhost:1313/interviewprep/quick-ref/">
    <meta property="og:site_name" content="Data Engineering Notes">
    <meta property="og:title" content="SQL & PySpark Queries :: Data Engineering Notes">
    <meta property="og:description" content="This guide pairs each SQL example with a PySpark DataFrame API equivalent.
Assumptions: df is employees, and other tables are similarly named DataFrames (departments, orders, etc.).
Imports used in PySpark examples
from pyspark.sql import functions as F from pyspark.sql.functions import col, lit, when, lower, upper, count, sum, avg, max, min, row_number, rank, dense_rank, ntile, lead, lag, coalesce from pyspark.sql.window import Window ðŸ§© Section 1: Basic Queries (1â€“10) SQL -- 1 SELECT * FROM employees; -- 2 SELECT first_name, last_name, hire_date FROM employees; -- 3 SELECT COUNT(*) FROM employees; -- 4 SELECT COUNT(salary) FROM employees; -- 5 SELECT DISTINCT department FROM employees; -- 6 SELECT * FROM employees WHERE department = &#39;Sales&#39;; -- 7 SELECT * FROM employees WHERE department = &#39;Sales&#39; AND salary &gt; 60000; -- 8 SELECT * FROM employees WHERE department = &#39;Sales&#39; OR department = &#39;Marketing&#39;; -- 9 SELECT * FROM employees WHERE (department = &#39;Sales&#39; OR department = &#39;Marketing&#39;) AND salary &gt; 70000; -- 10 SELECT * FROM employees WHERE NOT department = &#39;IT&#39;; PySpark # 1 df.show() # 2 df.select(&#34;first_name&#34;, &#34;last_name&#34;, &#34;hire_date&#34;).show() # 3 df.count() # 4 df.select(F.count(&#34;salary&#34;)).show() # 5 df.select(&#34;department&#34;).distinct().show() # 6 df.filter(col(&#34;department&#34;) == &#34;Sales&#34;).show() # 7 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) &amp; (col(&#34;salary&#34;) &gt; 60000)).show() # 8 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)).show() # 9 df.filter(((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)) &amp; (col(&#34;salary&#34;) &gt; 70000)).show() # 10 df.filter(col(&#34;department&#34;) != &#34;IT&#34;).show() ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20) SQL -- 11 SELECT * FROM employees WHERE department IN (&#39;Sales&#39;, &#39;Marketing&#39;, &#39;IT&#39;); -- 12 SELECT * FROM employees WHERE department NOT IN (&#39;Sales&#39;, &#39;Marketing&#39;); -- 13 SELECT * FROM employees WHERE salary BETWEEN 50000 AND 75000; -- 14 SELECT * FROM employees WHERE first_name ILIKE &#39;%jo%&#39;; -- 15 SELECT * FROM employees WHERE last_name LIKE &#39;Smi%&#39;; -- 16 SELECT * FROM employees WHERE email LIKE &#39;%@gmail.com&#39;; -- 17 SELECT * FROM employees WHERE first_name LIKE &#39;_a%&#39;; -- 18 SELECT * FROM employees WHERE manager_id IS NULL; -- 19 SELECT * FROM employees WHERE manager_id IS NOT NULL; -- 20 SELECT * FROM employees WHERE hire_date BETWEEN &#39;2023-01-01&#39; AND &#39;2023-12-31&#39;; PySpark # 11 df.filter(col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;, &#34;IT&#34;)).show() # 12 df.filter(~col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;)).show() # 13 df.filter(col(&#34;salary&#34;).between(50000, 75000)).show() # 14 (case-insensitive search) df.filter(lower(col(&#34;first_name&#34;)).like(&#34;%jo%&#34;)).show() # 15 df.filter(col(&#34;last_name&#34;).startswith(&#34;Smi&#34;)).show() # 16 df.filter(col(&#34;email&#34;).endswith(&#34;@gmail.com&#34;)).show() # 17 (single char then &#39;a&#39;) df.filter(col(&#34;first_name&#34;).rlike(&#34;^.a.*&#34;)).show() # 18 df.filter(col(&#34;manager_id&#34;).isNull()).show() # 19 df.filter(col(&#34;manager_id&#34;).isNotNull()).show() # 20 df.filter(col(&#34;hire_date&#34;).between(&#34;2023-01-01&#34;, &#34;2023-12-31&#34;)).show() â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30) SQL -- 21 SELECT * FROM employees ORDER BY last_name ASC; -- 22 SELECT * FROM employees ORDER BY salary DESC; -- 23 SELECT * FROM employees ORDER BY department ASC, salary DESC; -- 24 SELECT * FROM employees ORDER BY salary DESC LIMIT 10; -- 25 SELECT * FROM employees ORDER BY hire_date DESC LIMIT 5; -- 26 SELECT DISTINCT department FROM employees ORDER BY department; -- 27 SELECT * FROM employees ORDER BY employee_id OFFSET 10 LIMIT 10; -- 28 SELECT * FROM employees ORDER BY salary DESC LIMIT 1; -- 29 SELECT DISTINCT salary FROM employees ORDER BY salary DESC LIMIT 1 OFFSET 1; -- 30 SELECT first_name, last_name, (salary * 0.1) AS bonus FROM employees ORDER BY bonus DESC; PySpark # 21 df.orderBy(col(&#34;last_name&#34;).asc()).show() # 22 df.orderBy(col(&#34;salary&#34;).desc()).show() # 23 df.orderBy(col(&#34;department&#34;).asc(), col(&#34;salary&#34;).desc()).show() # 24 df.orderBy(col(&#34;salary&#34;).desc()).limit(10).show() # 25 df.orderBy(col(&#34;hire_date&#34;).desc()).limit(5).show() # 26 df.select(&#34;department&#34;).distinct().orderBy(&#34;department&#34;).show() # 27 (rows 11â€“20): use ROW_NUMBER then filter w = Window.orderBy(&#34;employee_id&#34;) df.withColumn(&#34;rn&#34;, row_number().over(w)).filter((col(&#34;rn&#34;) &gt;= 11) &amp; (col(&#34;rn&#34;) &lt;= 20)).drop(&#34;rn&#34;).show() # 28 df.orderBy(col(&#34;salary&#34;).desc()).limit(1).show() # 29 (second-highest salary) â€“ two ways df.select(&#34;salary&#34;).distinct().orderBy(col(&#34;salary&#34;).desc()).limit(2).orderBy(col(&#34;salary&#34;).asc()).limit(1).show() # or using dense_rank w2 = Window.orderBy(col(&#34;salary&#34;).desc()) df.select(&#34;salary&#34;, dense_rank().over(w2).alias(&#34;dr&#34;)).filter(col(&#34;dr&#34;) == 2).select(&#34;salary&#34;).distinct().show() # 30 df.select(&#34;first_name&#34;, &#34;last_name&#34;, (col(&#34;salary&#34;) * 0.1).alias(&#34;bonus&#34;)).orderBy(col(&#34;bonus&#34;).desc()).show() ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40) SQL -- 31 SELECT department, COUNT(*) FROM employees GROUP BY department; -- 32 SELECT department, AVG(salary) FROM employees GROUP BY department; -- 33 SELECT department, SUM(salary) FROM employees GROUP BY department; -- 34 SELECT department, MAX(salary) FROM employees GROUP BY department; -- 35 SELECT department, MIN(salary) FROM employees GROUP BY department; -- 36 SELECT department, AVG(salary) FROM employees GROUP BY department HAVING AVG(salary) &gt; 65000; -- 37 SELECT department, COUNT(*) FROM employees GROUP BY department HAVING COUNT(*) &gt; 5; -- 38 SELECT department, AVG(salary) FROM employees WHERE hire_date &gt; &#39;2022-01-01&#39; GROUP BY department; -- 39 SELECT department, job_title, AVG(salary) FROM employees GROUP BY department, job_title; -- 40 SELECT department, MAX(salary) FROM employees GROUP BY department; PySpark # 31 df.groupBy(&#34;department&#34;).count().show() # 32 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 33 df.groupBy(&#34;department&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 34 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() # 35 df.groupBy(&#34;department&#34;).agg(min(&#34;salary&#34;).alias(&#34;min_salary&#34;)).show() # 36 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).filter(col(&#34;avg_salary&#34;) &gt; 65000).show() # 37 df.groupBy(&#34;department&#34;).count().filter(col(&#34;count&#34;) &gt; 5).show() # 38 df.filter(col(&#34;hire_date&#34;) &gt; &#34;2022-01-01&#34;).groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;)).show() # 39 df.groupBy(&#34;department&#34;, &#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 40 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() ðŸ”— Section 5: Joins (41â€“60) SQL -- 41 SELECT e.first_name, d.department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id; -- 42 SELECT e.first_name, d.department_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id; -- 43 SELECT e.first_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id WHERE d.department_id IS NULL; -- 44 SELECT e.first_name, d.department_name FROM employees e RIGHT JOIN departments d ON e.department_id = d.department_id; -- 45 SELECT e.first_name, d.department_name FROM employees e FULL OUTER JOIN departments d ON e.department_id = d.department_id; -- 46 SELECT e.first_name, p.project_name, d.department_name FROM employees e JOIN projects p ON e.employee_id = p.employee_id JOIN departments d ON e.department_id = d.department_id; -- 47 SELECT e.first_name AS employee, m.first_name AS manager FROM employees e JOIN employees m ON e.manager_id = m.employee_id; -- 48 SELECT o.order_id, c.customer_name FROM orders o JOIN customers c ON o.customer_zip_code = c.customer_zip_code; -- 49 SELECT * FROM employees CROSS JOIN departments; -- 50 SELECT p.* FROM products p LEFT JOIN sales s ON p.product_id = s.product_id WHERE s.sale_id IS NULL; -- 51 SELECT e.first_name, e.last_name FROM employees e LEFT JOIN employee_projects ep ON e.employee_id = ep.employee_id WHERE ep.project_id IS NULL; -- 52 SELECT p.project_name FROM projects p LEFT JOIN employee_projects ep ON p.project_id = ep.project_id WHERE ep.employee_id IS NULL; -- 53 SELECT d.department_name, SUM(e.salary) AS total_salary FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 54 SELECT d.department_name, COUNT(e.employee_id) AS num_employees FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 55 SELECT o.*, c.customer_name FROM orders o JOIN customers c ON o.customer_id = c.customer_id AND o.order_date = c.last_purchase_date; -- 56 SELECT e.first_name, m.first_name AS manager_name, d.department_name FROM employees e JOIN employees m ON e.manager_id = m.employee_id JOIN departments d ON m.department_id = d.department_id; -- 57 SELECT e.employee_id, h.salary_grade FROM employees e JOIN salary_grades h ON e.salary BETWEEN h.min_salary AND h.max_salary; -- 58 SELECT e.first_name, d.department_name FROM employees e JOIN departments d ON e.department_id = d.department_id WHERE d.location_city = &#39;New York&#39;; -- 59 SELECT d.department_name, AVG(e.salary) AS avg_salary FROM employees e JOIN departments d ON e.department_id = d.department_id GROUP BY d.department_name; -- 60 SELECT a.order_id, b.item_name FROM table_a a JOIN table_b b ON a.product_id = b.item_id; PySpark # 41 employees.join(departments, &#34;department_id&#34;, &#34;inner&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 42 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 43 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;)\ .filter(departments.department_id.isNull())\ .select(employees.first_name).show() # 44 employees.join(departments, &#34;department_id&#34;, &#34;right&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 45 employees.join(departments, &#34;department_id&#34;, &#34;outer&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 46 employees.join(projects, &#34;employee_id&#34;)\ .join(departments, &#34;department_id&#34;)\ .select(&#34;first_name&#34;, &#34;project_name&#34;, &#34;department_name&#34;).show() # 47 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .select(col(&#34;e.first_name&#34;).alias(&#34;employee&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager&#34;)).show() # 48 orders.join(customers, orders.customer_zip_code == customers.customer_zip_code)\ .select(&#34;order_id&#34;, &#34;customer_name&#34;).show() # 49 employees.crossJoin(departments).show() # 50 products.join(sales, &#34;product_id&#34;, &#34;left&#34;)\ .filter(col(&#34;sale_id&#34;).isNull())\ .select(&#34;product_id&#34;, *[c for c in products.columns if c != &#34;product_id&#34;]).show() # 51 employees.join(employee_projects, &#34;employee_id&#34;, &#34;left&#34;)\ .filter(col(&#34;project_id&#34;).isNull())\ .select(&#34;first_name&#34;, &#34;last_name&#34;).show() # 52 projects.join(employee_projects, &#34;project_id&#34;, &#34;left&#34;)\ .filter(col(&#34;employee_id&#34;).isNull())\ .select(&#34;project_name&#34;).show() # 53 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 54 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(count(&#34;employee_id&#34;).alias(&#34;num_employees&#34;)).show() # 55 orders.join(customers, (orders.customer_id == customers.customer_id) &amp; (orders.order_date == customers.last_purchase_date))\ .select(orders[&#34;*&#34;], customers.customer_name).show() # 56 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;); d = departments.alias(&#34;d&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .join(d, col(&#34;m.department_id&#34;) == col(&#34;d.department_id&#34;))\ .select(col(&#34;e.first_name&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager_name&#34;), col(&#34;d.department_name&#34;)).show() # 57 employees.join(salary_grades, (employees.salary &gt;= salary_grades.min_salary) &amp; (employees.salary &lt;= salary_grades.max_salary))\ .select(&#34;employee_id&#34;, &#34;salary_grade&#34;).show() # 58 employees.join(departments, &#34;department_id&#34;)\ .filter(col(&#34;location_city&#34;) == &#34;New York&#34;)\ .select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 59 employees.join(departments, &#34;department_id&#34;)\ .groupBy(&#34;department_name&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 60 table_a.join(table_b, table_a.product_id == table_b.item_id)\ .select(table_a.order_id, table_b.item_name).show() ðŸ§  Section 6: Subqueries (61â€“75) SQL -- 61 SELECT * FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 62 SELECT * FROM employees WHERE department_id IN ( SELECT department_id FROM departments WHERE location_city = &#39;San Francisco&#39; ); -- 63 SELECT d.department_name, s.avg_salary FROM ( SELECT department_id, AVG(salary) AS avg_salary FROM employees GROUP BY department_id ) AS s JOIN departments d ON s.department_id = d.department_id; -- 64 SELECT first_name, salary, (SELECT AVG(salary) FROM employees) AS company_avg_salary FROM employees; -- 65 SELECT * FROM employees e WHERE salary &gt; (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id); -- 66 SELECT d.department_name FROM departments d WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id AND e.salary &gt; 100000); -- 67 SELECT d.department_name FROM departments d WHERE NOT EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id); -- 68 SELECT * FROM departments WHERE department_id IN (SELECT DISTINCT department_id FROM employees); -- 69 SELECT * FROM employees e WHERE EXISTS (SELECT 1 FROM orders o WHERE o.employee_id = e.employee_id); -- 70 SELECT d.department_name, (SELECT SUM(salary) FROM employees e WHERE e.department_id = d.department_id) AS total_department_salary FROM departments d; -- 71 SELECT department_name FROM departments WHERE department_id = ( SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary) DESC LIMIT 1 ); -- 72 SELECT customer_name FROM customers WHERE customer_id IN (SELECT customer_id FROM orders WHERE product_id = 123); -- 73 SELECT COUNT(*) FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 74 SELECT customer_name FROM customers WHERE customer_id NOT IN (SELECT DISTINCT customer_id FROM orders); -- 75 SELECT e.first_name, e.salary, e.job_title FROM employees e WHERE e.salary &lt; (SELECT AVG(salary) FROM employees WHERE job_title = e.job_title); PySpark # 61 avg_sal = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.filter(col(&#34;salary&#34;) &gt; avg_sal).show() # 62 sf_depts = departments.filter(col(&#34;location_city&#34;) == &#34;San Francisco&#34;).select(&#34;department_id&#34;).distinct() df.join(sf_depts, &#34;department_id&#34;).show() # 63 avg_df = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) avg_df.join(departments, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;avg_salary&#34;).show() # 64 avg_val = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.select(&#34;first_name&#34;, &#34;salary&#34;, lit(avg_val).alias(&#34;company_avg_salary&#34;)).show() # 65 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;dept_avg&#34;)) df.join(dept_avg, &#34;department_id&#34;).filter(col(&#34;salary&#34;) &gt; col(&#34;dept_avg&#34;)).show() # 66 high_paid = df.filter(col(&#34;salary&#34;) &gt; 100000).select(&#34;department_id&#34;).distinct() departments.join(high_paid, &#34;department_id&#34;).select(&#34;department_name&#34;).distinct().show() # 67 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;, &#34;left_anti&#34;).select(&#34;department_name&#34;).show() # 68 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;).show() # 69 df.join(orders.select(&#34;employee_id&#34;).distinct(), &#34;employee_id&#34;).select(df[&#34;*&#34;]).distinct().show() # 70 dept_totals = df.groupBy(&#34;department_id&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_department_salary&#34;)) departments.join(dept_totals, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;total_department_salary&#34;).show() # 71 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) top_dept = dept_avg.orderBy(col(&#34;avg_salary&#34;).desc()).limit(1) departments.join(top_dept, &#34;department_id&#34;).select(&#34;department_name&#34;).show() # 72 buyers = orders.filter(col(&#34;product_id&#34;) == 123).select(&#34;customer_id&#34;).distinct() customers.join(buyers, &#34;customer_id&#34;).select(&#34;customer_name&#34;).show() # 73 df.filter(col(&#34;salary&#34;) &gt; avg_sal).count() # 74 customers.join(orders.select(&#34;customer_id&#34;).distinct(), &#34;customer_id&#34;, &#34;left_anti&#34;).select(&#34;customer_name&#34;).show() # 75 job_avg = df.groupBy(&#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;job_avg&#34;)) df.join(job_avg, &#34;job_title&#34;).filter(col(&#34;salary&#34;) &lt; col(&#34;job_avg&#34;)).select(&#34;first_name&#34;, &#34;salary&#34;, &#34;job_title&#34;).show() ðŸªŸ Section 7: Window Functions (76â€“85) SQL -- 76 SELECT first_name, department, salary, ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees; -- 77 SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank FROM employees; -- 78 SELECT first_name, department, salary, DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank FROM employees; -- 79 SELECT first_name, salary, NTILE(4) OVER (ORDER BY salary DESC) AS quartile FROM employees; -- 80 SELECT order_date, total_amount, LEAD(total_amount, 1) OVER (ORDER BY order_date) AS next_order_amount FROM orders; -- 81 SELECT order_date, total_amount, LAG(total_amount, 1, 0) OVER (ORDER BY order_date) AS previous_order_amount FROM orders; -- 82 SELECT order_date, total_amount, SUM(total_amount) OVER (ORDER BY order_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total FROM orders; -- 83 SELECT order_date, total_amount, AVG(total_amount) OVER (ORDER BY order_date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg FROM orders; -- 84 SELECT * FROM ( SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees ) AS ranked_employees WHERE rn &lt;= 3; -- 85 SELECT product_id, SUM(sales) AS product_sales, SUM(SUM(sales)) OVER () AS total_sales, (SUM(sales) / SUM(SUM(sales)) OVER ()) * 100 AS percentage_of_total FROM sales GROUP BY product_id; PySpark w_dept = Window.partitionBy(&#34;department&#34;).orderBy(col(&#34;salary&#34;).desc()) # 76 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, row_number().over(w_dept).alias(&#34;rn&#34;)).show() # 77 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, rank().over(w_dept).alias(&#34;rank&#34;)).show() # 78 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, dense_rank().over(w_dept).alias(&#34;dense_rank&#34;)).show() # 79 df.select(&#34;first_name&#34;, &#34;salary&#34;, ntile(4).over(Window.orderBy(col(&#34;salary&#34;).desc())).alias(&#34;quartile&#34;)).show() # 80 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lead(&#34;total_amount&#34;, 1).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;next_order_amount&#34;)).show() # 81 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lag(&#34;total_amount&#34;, 1, 0).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;previous_order_amount&#34;)).show() # 82 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, F.sum(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;) .rowsBetween(Window.unboundedPreceding, Window.currentRow)).alias(&#34;running_total&#34;)).show() # 83 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, avg(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;).rowsBetween(-2, Window.currentRow)).alias(&#34;moving_avg&#34;)).show() # 84 df.withColumn(&#34;rn&#34;, rank().over(w_dept)).filter(col(&#34;rn&#34;) &lt;= 3).drop(&#34;rn&#34;).show() # 85 prod_sales = sales.groupBy(&#34;product_id&#34;).agg(sum(&#34;sales&#34;).alias(&#34;product_sales&#34;)) prod_sales.withColumn(&#34;total_sales&#34;, sum(&#34;product_sales&#34;).over(Window.partitionBy()))\ .withColumn(&#34;percentage_of_total&#34;, (col(&#34;product_sales&#34;) / col(&#34;total_sales&#34;)) * 100)\ .select(&#34;product_id&#34;, &#34;product_sales&#34;, &#34;total_sales&#34;, &#34;percentage_of_total&#34;).show() ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100) SQL -- 86 WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary; -- 87 INSERT INTO employees (first_name, last_name, salary) VALUES (&#39;John&#39;, &#39;Doe&#39;, 60000); -- 88 UPDATE employees SET salary = salary * 1.05 WHERE department = &#39;IT&#39;; -- 89 DELETE FROM employees WHERE employee_id = 101; -- 90 TRUNCATE TABLE old_data; -- 91 SELECT first_name FROM employees UNION SELECT first_name FROM customers; -- 92 SELECT first_name FROM employees UNION ALL SELECT first_name FROM customers; -- 93 SELECT first_name, salary, CASE WHEN salary &gt; 100000 THEN &#39;High Earner&#39; WHEN salary BETWEEN 50000 AND 100000 THEN &#39;Mid-Range&#39; ELSE &#39;Junior&#39; END AS salary_level FROM employees; -- 94 SELECT department, COUNT(CASE WHEN salary &gt; 70000 THEN 1 END) AS high_salary_count, COUNT(CASE WHEN salary &lt;= 70000 THEN 1 END) AS low_salary_count FROM employees GROUP BY department; -- 95 SELECT CAST(order_date AS DATE) FROM orders; -- 96 SELECT COALESCE(email, &#39;No Email Provided&#39;) FROM employees; -- 97 SELECT NULLIF(salary, 0) FROM employees; -- 98 (Recursive CTE) WITH RECURSIVE subordinates AS ( SELECT employee_id, manager_id FROM employees WHERE employee_id = 1 UNION ALL SELECT e.employee_id, e.manager_id FROM employees e JOIN subordinates s ON e.manager_id = s.employee_id ) SELECT * FROM subordinates; -- 99 SELECT department, job_title, SUM(salary) FROM employees GROUP BY GROUPING SETS ((department), (job_title), ()); -- 100 SELECT department, job_title, SUM(salary) FROM employees GROUP BY ROLLUP(department, job_title); PySpark # 86 (Use SQL CTE via temp view) df.createOrReplaceTempView(&#34;employees&#34;) spark.sql(&#34;&#34;&#34; WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary &#34;&#34;&#34;).show() # 87 (Insert-like: union new rows) df_new = spark.createDataFrame([(&#34;John&#34;, &#34;Doe&#34;, 60000)], [&#34;first_name&#34;, &#34;last_name&#34;, &#34;salary&#34;]) df = df.unionByName(df_new) # 88 (Update-like) df = df.withColumn(&#34;salary&#34;, when(col(&#34;department&#34;) == &#34;IT&#34;, col(&#34;salary&#34;) * 1.05).otherwise(col(&#34;salary&#34;))) # 89 (Delete-like) df = df.filter(col(&#34;employee_id&#34;) != 101) # 90 (Truncate-like in-memory) df = df.limit(0) # for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;) # 91 UNION (distinct) df_union_distinct = df1.union(df2).distinct() # 92 UNION ALL df_union_all = df1.union(df2) # 93 CASE/WHEN df.select(&#34;first_name&#34;, &#34;salary&#34;, when(col(&#34;salary&#34;) &gt; 100000, &#34;High Earner&#34;) .when((col(&#34;salary&#34;) &gt;= 50000) &amp; (col(&#34;salary&#34;) &lt;= 100000), &#34;Mid-Range&#34;) .otherwise(&#34;Junior&#34;).alias(&#34;salary_level&#34;)).show() # 94 Pivot without true pivot df.groupBy(&#34;department&#34;).agg( count(when(col(&#34;salary&#34;) &gt; 70000, 1)).alias(&#34;high_salary_count&#34;), count(when(col(&#34;salary&#34;) &lt;= 70000, 1)).alias(&#34;low_salary_count&#34;) ).show() # 95 CAST orders.select(col(&#34;order_date&#34;).cast(&#34;date&#34;).alias(&#34;order_date&#34;)).show() # 96 COALESCE df.select(coalesce(col(&#34;email&#34;), lit(&#34;No Email Provided&#34;)).alias(&#34;email&#34;)).show() # 97 NULLIF(salary,0) =&gt; NULL when equal df.select(when(col(&#34;salary&#34;) == 0, lit(None)).otherwise(col(&#34;salary&#34;)).alias(&#34;salary_or_null&#34;)).show() # 98 Recursive CTE not native; iterative approach example (hierarchy traversal) # Start with seed seed = df.filter(col(&#34;employee_id&#34;) == 1).select(&#34;employee_id&#34;, &#34;manager_id&#34;) result = seed frontier = seed while True: step = df.select(&#34;employee_id&#34;, &#34;manager_id&#34;)\ .join(frontier, df.manager_id == frontier.employee_id, &#34;inner&#34;)\ .select(df.employee_id, df.manager_id).dropDuplicates() new_nodes = step.join(result, [&#34;employee_id&#34;, &#34;manager_id&#34;], &#34;left_anti&#34;) if new_nodes.rdd.isEmpty(): break result = result.unionByName(new_nodes).dropDuplicates() frontier = new_nodes # result contains recursive closure # 99 GROUPING SETS -&gt; cube with filters cube_df = df.cube(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)) # Keep only grouping sets: (department), (job_title), () from pyspark.sql.functions import grouping_id cube_df.filter( (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 1) | # (department,NULL) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 2) | # (NULL,job_title) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 3) # (NULL,NULL) ).show() # 100 ROLLUP df.rollup(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)).show() âœ… Notes Some SQL constructs (OFFSET, Recursive CTE) donâ€™t map 1:1 to PySpark; patterns above show practical equivalents. Replace .show() with .write.format(&#34;delta&#34;)... to persist as needed.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Interview Prep">
    <meta itemprop="name" content="SQL & PySpark Queries :: Data Engineering Notes">
    <meta itemprop="description" content="This guide pairs each SQL example with a PySpark DataFrame API equivalent.
Assumptions: df is employees, and other tables are similarly named DataFrames (departments, orders, etc.).
Imports used in PySpark examples
from pyspark.sql import functions as F from pyspark.sql.functions import col, lit, when, lower, upper, count, sum, avg, max, min, row_number, rank, dense_rank, ntile, lead, lag, coalesce from pyspark.sql.window import Window ðŸ§© Section 1: Basic Queries (1â€“10) SQL -- 1 SELECT * FROM employees; -- 2 SELECT first_name, last_name, hire_date FROM employees; -- 3 SELECT COUNT(*) FROM employees; -- 4 SELECT COUNT(salary) FROM employees; -- 5 SELECT DISTINCT department FROM employees; -- 6 SELECT * FROM employees WHERE department = &#39;Sales&#39;; -- 7 SELECT * FROM employees WHERE department = &#39;Sales&#39; AND salary &gt; 60000; -- 8 SELECT * FROM employees WHERE department = &#39;Sales&#39; OR department = &#39;Marketing&#39;; -- 9 SELECT * FROM employees WHERE (department = &#39;Sales&#39; OR department = &#39;Marketing&#39;) AND salary &gt; 70000; -- 10 SELECT * FROM employees WHERE NOT department = &#39;IT&#39;; PySpark # 1 df.show() # 2 df.select(&#34;first_name&#34;, &#34;last_name&#34;, &#34;hire_date&#34;).show() # 3 df.count() # 4 df.select(F.count(&#34;salary&#34;)).show() # 5 df.select(&#34;department&#34;).distinct().show() # 6 df.filter(col(&#34;department&#34;) == &#34;Sales&#34;).show() # 7 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) &amp; (col(&#34;salary&#34;) &gt; 60000)).show() # 8 df.filter((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)).show() # 9 df.filter(((col(&#34;department&#34;) == &#34;Sales&#34;) | (col(&#34;department&#34;) == &#34;Marketing&#34;)) &amp; (col(&#34;salary&#34;) &gt; 70000)).show() # 10 df.filter(col(&#34;department&#34;) != &#34;IT&#34;).show() ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20) SQL -- 11 SELECT * FROM employees WHERE department IN (&#39;Sales&#39;, &#39;Marketing&#39;, &#39;IT&#39;); -- 12 SELECT * FROM employees WHERE department NOT IN (&#39;Sales&#39;, &#39;Marketing&#39;); -- 13 SELECT * FROM employees WHERE salary BETWEEN 50000 AND 75000; -- 14 SELECT * FROM employees WHERE first_name ILIKE &#39;%jo%&#39;; -- 15 SELECT * FROM employees WHERE last_name LIKE &#39;Smi%&#39;; -- 16 SELECT * FROM employees WHERE email LIKE &#39;%@gmail.com&#39;; -- 17 SELECT * FROM employees WHERE first_name LIKE &#39;_a%&#39;; -- 18 SELECT * FROM employees WHERE manager_id IS NULL; -- 19 SELECT * FROM employees WHERE manager_id IS NOT NULL; -- 20 SELECT * FROM employees WHERE hire_date BETWEEN &#39;2023-01-01&#39; AND &#39;2023-12-31&#39;; PySpark # 11 df.filter(col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;, &#34;IT&#34;)).show() # 12 df.filter(~col(&#34;department&#34;).isin(&#34;Sales&#34;, &#34;Marketing&#34;)).show() # 13 df.filter(col(&#34;salary&#34;).between(50000, 75000)).show() # 14 (case-insensitive search) df.filter(lower(col(&#34;first_name&#34;)).like(&#34;%jo%&#34;)).show() # 15 df.filter(col(&#34;last_name&#34;).startswith(&#34;Smi&#34;)).show() # 16 df.filter(col(&#34;email&#34;).endswith(&#34;@gmail.com&#34;)).show() # 17 (single char then &#39;a&#39;) df.filter(col(&#34;first_name&#34;).rlike(&#34;^.a.*&#34;)).show() # 18 df.filter(col(&#34;manager_id&#34;).isNull()).show() # 19 df.filter(col(&#34;manager_id&#34;).isNotNull()).show() # 20 df.filter(col(&#34;hire_date&#34;).between(&#34;2023-01-01&#34;, &#34;2023-12-31&#34;)).show() â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30) SQL -- 21 SELECT * FROM employees ORDER BY last_name ASC; -- 22 SELECT * FROM employees ORDER BY salary DESC; -- 23 SELECT * FROM employees ORDER BY department ASC, salary DESC; -- 24 SELECT * FROM employees ORDER BY salary DESC LIMIT 10; -- 25 SELECT * FROM employees ORDER BY hire_date DESC LIMIT 5; -- 26 SELECT DISTINCT department FROM employees ORDER BY department; -- 27 SELECT * FROM employees ORDER BY employee_id OFFSET 10 LIMIT 10; -- 28 SELECT * FROM employees ORDER BY salary DESC LIMIT 1; -- 29 SELECT DISTINCT salary FROM employees ORDER BY salary DESC LIMIT 1 OFFSET 1; -- 30 SELECT first_name, last_name, (salary * 0.1) AS bonus FROM employees ORDER BY bonus DESC; PySpark # 21 df.orderBy(col(&#34;last_name&#34;).asc()).show() # 22 df.orderBy(col(&#34;salary&#34;).desc()).show() # 23 df.orderBy(col(&#34;department&#34;).asc(), col(&#34;salary&#34;).desc()).show() # 24 df.orderBy(col(&#34;salary&#34;).desc()).limit(10).show() # 25 df.orderBy(col(&#34;hire_date&#34;).desc()).limit(5).show() # 26 df.select(&#34;department&#34;).distinct().orderBy(&#34;department&#34;).show() # 27 (rows 11â€“20): use ROW_NUMBER then filter w = Window.orderBy(&#34;employee_id&#34;) df.withColumn(&#34;rn&#34;, row_number().over(w)).filter((col(&#34;rn&#34;) &gt;= 11) &amp; (col(&#34;rn&#34;) &lt;= 20)).drop(&#34;rn&#34;).show() # 28 df.orderBy(col(&#34;salary&#34;).desc()).limit(1).show() # 29 (second-highest salary) â€“ two ways df.select(&#34;salary&#34;).distinct().orderBy(col(&#34;salary&#34;).desc()).limit(2).orderBy(col(&#34;salary&#34;).asc()).limit(1).show() # or using dense_rank w2 = Window.orderBy(col(&#34;salary&#34;).desc()) df.select(&#34;salary&#34;, dense_rank().over(w2).alias(&#34;dr&#34;)).filter(col(&#34;dr&#34;) == 2).select(&#34;salary&#34;).distinct().show() # 30 df.select(&#34;first_name&#34;, &#34;last_name&#34;, (col(&#34;salary&#34;) * 0.1).alias(&#34;bonus&#34;)).orderBy(col(&#34;bonus&#34;).desc()).show() ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40) SQL -- 31 SELECT department, COUNT(*) FROM employees GROUP BY department; -- 32 SELECT department, AVG(salary) FROM employees GROUP BY department; -- 33 SELECT department, SUM(salary) FROM employees GROUP BY department; -- 34 SELECT department, MAX(salary) FROM employees GROUP BY department; -- 35 SELECT department, MIN(salary) FROM employees GROUP BY department; -- 36 SELECT department, AVG(salary) FROM employees GROUP BY department HAVING AVG(salary) &gt; 65000; -- 37 SELECT department, COUNT(*) FROM employees GROUP BY department HAVING COUNT(*) &gt; 5; -- 38 SELECT department, AVG(salary) FROM employees WHERE hire_date &gt; &#39;2022-01-01&#39; GROUP BY department; -- 39 SELECT department, job_title, AVG(salary) FROM employees GROUP BY department, job_title; -- 40 SELECT department, MAX(salary) FROM employees GROUP BY department; PySpark # 31 df.groupBy(&#34;department&#34;).count().show() # 32 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 33 df.groupBy(&#34;department&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 34 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() # 35 df.groupBy(&#34;department&#34;).agg(min(&#34;salary&#34;).alias(&#34;min_salary&#34;)).show() # 36 df.groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).filter(col(&#34;avg_salary&#34;) &gt; 65000).show() # 37 df.groupBy(&#34;department&#34;).count().filter(col(&#34;count&#34;) &gt; 5).show() # 38 df.filter(col(&#34;hire_date&#34;) &gt; &#34;2022-01-01&#34;).groupBy(&#34;department&#34;).agg(avg(&#34;salary&#34;)).show() # 39 df.groupBy(&#34;department&#34;, &#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 40 df.groupBy(&#34;department&#34;).agg(max(&#34;salary&#34;).alias(&#34;max_salary&#34;)).show() ðŸ”— Section 5: Joins (41â€“60) SQL -- 41 SELECT e.first_name, d.department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id; -- 42 SELECT e.first_name, d.department_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id; -- 43 SELECT e.first_name FROM employees e LEFT JOIN departments d ON e.department_id = d.department_id WHERE d.department_id IS NULL; -- 44 SELECT e.first_name, d.department_name FROM employees e RIGHT JOIN departments d ON e.department_id = d.department_id; -- 45 SELECT e.first_name, d.department_name FROM employees e FULL OUTER JOIN departments d ON e.department_id = d.department_id; -- 46 SELECT e.first_name, p.project_name, d.department_name FROM employees e JOIN projects p ON e.employee_id = p.employee_id JOIN departments d ON e.department_id = d.department_id; -- 47 SELECT e.first_name AS employee, m.first_name AS manager FROM employees e JOIN employees m ON e.manager_id = m.employee_id; -- 48 SELECT o.order_id, c.customer_name FROM orders o JOIN customers c ON o.customer_zip_code = c.customer_zip_code; -- 49 SELECT * FROM employees CROSS JOIN departments; -- 50 SELECT p.* FROM products p LEFT JOIN sales s ON p.product_id = s.product_id WHERE s.sale_id IS NULL; -- 51 SELECT e.first_name, e.last_name FROM employees e LEFT JOIN employee_projects ep ON e.employee_id = ep.employee_id WHERE ep.project_id IS NULL; -- 52 SELECT p.project_name FROM projects p LEFT JOIN employee_projects ep ON p.project_id = ep.project_id WHERE ep.employee_id IS NULL; -- 53 SELECT d.department_name, SUM(e.salary) AS total_salary FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 54 SELECT d.department_name, COUNT(e.employee_id) AS num_employees FROM departments d LEFT JOIN employees e ON d.department_id = e.department_id GROUP BY d.department_name; -- 55 SELECT o.*, c.customer_name FROM orders o JOIN customers c ON o.customer_id = c.customer_id AND o.order_date = c.last_purchase_date; -- 56 SELECT e.first_name, m.first_name AS manager_name, d.department_name FROM employees e JOIN employees m ON e.manager_id = m.employee_id JOIN departments d ON m.department_id = d.department_id; -- 57 SELECT e.employee_id, h.salary_grade FROM employees e JOIN salary_grades h ON e.salary BETWEEN h.min_salary AND h.max_salary; -- 58 SELECT e.first_name, d.department_name FROM employees e JOIN departments d ON e.department_id = d.department_id WHERE d.location_city = &#39;New York&#39;; -- 59 SELECT d.department_name, AVG(e.salary) AS avg_salary FROM employees e JOIN departments d ON e.department_id = d.department_id GROUP BY d.department_name; -- 60 SELECT a.order_id, b.item_name FROM table_a a JOIN table_b b ON a.product_id = b.item_id; PySpark # 41 employees.join(departments, &#34;department_id&#34;, &#34;inner&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 42 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 43 employees.join(departments, &#34;department_id&#34;, &#34;left&#34;)\ .filter(departments.department_id.isNull())\ .select(employees.first_name).show() # 44 employees.join(departments, &#34;department_id&#34;, &#34;right&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 45 employees.join(departments, &#34;department_id&#34;, &#34;outer&#34;).select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 46 employees.join(projects, &#34;employee_id&#34;)\ .join(departments, &#34;department_id&#34;)\ .select(&#34;first_name&#34;, &#34;project_name&#34;, &#34;department_name&#34;).show() # 47 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .select(col(&#34;e.first_name&#34;).alias(&#34;employee&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager&#34;)).show() # 48 orders.join(customers, orders.customer_zip_code == customers.customer_zip_code)\ .select(&#34;order_id&#34;, &#34;customer_name&#34;).show() # 49 employees.crossJoin(departments).show() # 50 products.join(sales, &#34;product_id&#34;, &#34;left&#34;)\ .filter(col(&#34;sale_id&#34;).isNull())\ .select(&#34;product_id&#34;, *[c for c in products.columns if c != &#34;product_id&#34;]).show() # 51 employees.join(employee_projects, &#34;employee_id&#34;, &#34;left&#34;)\ .filter(col(&#34;project_id&#34;).isNull())\ .select(&#34;first_name&#34;, &#34;last_name&#34;).show() # 52 projects.join(employee_projects, &#34;project_id&#34;, &#34;left&#34;)\ .filter(col(&#34;employee_id&#34;).isNull())\ .select(&#34;project_name&#34;).show() # 53 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_salary&#34;)).show() # 54 departments.join(employees, &#34;department_id&#34;, &#34;left&#34;)\ .groupBy(&#34;department_name&#34;).agg(count(&#34;employee_id&#34;).alias(&#34;num_employees&#34;)).show() # 55 orders.join(customers, (orders.customer_id == customers.customer_id) &amp; (orders.order_date == customers.last_purchase_date))\ .select(orders[&#34;*&#34;], customers.customer_name).show() # 56 e = employees.alias(&#34;e&#34;); m = employees.alias(&#34;m&#34;); d = departments.alias(&#34;d&#34;) e.join(m, col(&#34;e.manager_id&#34;) == col(&#34;m.employee_id&#34;))\ .join(d, col(&#34;m.department_id&#34;) == col(&#34;d.department_id&#34;))\ .select(col(&#34;e.first_name&#34;), col(&#34;m.first_name&#34;).alias(&#34;manager_name&#34;), col(&#34;d.department_name&#34;)).show() # 57 employees.join(salary_grades, (employees.salary &gt;= salary_grades.min_salary) &amp; (employees.salary &lt;= salary_grades.max_salary))\ .select(&#34;employee_id&#34;, &#34;salary_grade&#34;).show() # 58 employees.join(departments, &#34;department_id&#34;)\ .filter(col(&#34;location_city&#34;) == &#34;New York&#34;)\ .select(&#34;first_name&#34;, &#34;department_name&#34;).show() # 59 employees.join(departments, &#34;department_id&#34;)\ .groupBy(&#34;department_name&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)).show() # 60 table_a.join(table_b, table_a.product_id == table_b.item_id)\ .select(table_a.order_id, table_b.item_name).show() ðŸ§  Section 6: Subqueries (61â€“75) SQL -- 61 SELECT * FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 62 SELECT * FROM employees WHERE department_id IN ( SELECT department_id FROM departments WHERE location_city = &#39;San Francisco&#39; ); -- 63 SELECT d.department_name, s.avg_salary FROM ( SELECT department_id, AVG(salary) AS avg_salary FROM employees GROUP BY department_id ) AS s JOIN departments d ON s.department_id = d.department_id; -- 64 SELECT first_name, salary, (SELECT AVG(salary) FROM employees) AS company_avg_salary FROM employees; -- 65 SELECT * FROM employees e WHERE salary &gt; (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id); -- 66 SELECT d.department_name FROM departments d WHERE EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id AND e.salary &gt; 100000); -- 67 SELECT d.department_name FROM departments d WHERE NOT EXISTS (SELECT 1 FROM employees e WHERE e.department_id = d.department_id); -- 68 SELECT * FROM departments WHERE department_id IN (SELECT DISTINCT department_id FROM employees); -- 69 SELECT * FROM employees e WHERE EXISTS (SELECT 1 FROM orders o WHERE o.employee_id = e.employee_id); -- 70 SELECT d.department_name, (SELECT SUM(salary) FROM employees e WHERE e.department_id = d.department_id) AS total_department_salary FROM departments d; -- 71 SELECT department_name FROM departments WHERE department_id = ( SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary) DESC LIMIT 1 ); -- 72 SELECT customer_name FROM customers WHERE customer_id IN (SELECT customer_id FROM orders WHERE product_id = 123); -- 73 SELECT COUNT(*) FROM employees WHERE salary &gt; (SELECT AVG(salary) FROM employees); -- 74 SELECT customer_name FROM customers WHERE customer_id NOT IN (SELECT DISTINCT customer_id FROM orders); -- 75 SELECT e.first_name, e.salary, e.job_title FROM employees e WHERE e.salary &lt; (SELECT AVG(salary) FROM employees WHERE job_title = e.job_title); PySpark # 61 avg_sal = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.filter(col(&#34;salary&#34;) &gt; avg_sal).show() # 62 sf_depts = departments.filter(col(&#34;location_city&#34;) == &#34;San Francisco&#34;).select(&#34;department_id&#34;).distinct() df.join(sf_depts, &#34;department_id&#34;).show() # 63 avg_df = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) avg_df.join(departments, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;avg_salary&#34;).show() # 64 avg_val = df.select(avg(&#34;salary&#34;).alias(&#34;avg&#34;)).first()[&#34;avg&#34;] df.select(&#34;first_name&#34;, &#34;salary&#34;, lit(avg_val).alias(&#34;company_avg_salary&#34;)).show() # 65 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;dept_avg&#34;)) df.join(dept_avg, &#34;department_id&#34;).filter(col(&#34;salary&#34;) &gt; col(&#34;dept_avg&#34;)).show() # 66 high_paid = df.filter(col(&#34;salary&#34;) &gt; 100000).select(&#34;department_id&#34;).distinct() departments.join(high_paid, &#34;department_id&#34;).select(&#34;department_name&#34;).distinct().show() # 67 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;, &#34;left_anti&#34;).select(&#34;department_name&#34;).show() # 68 departments.join(df.select(&#34;department_id&#34;).distinct(), &#34;department_id&#34;).show() # 69 df.join(orders.select(&#34;employee_id&#34;).distinct(), &#34;employee_id&#34;).select(df[&#34;*&#34;]).distinct().show() # 70 dept_totals = df.groupBy(&#34;department_id&#34;).agg(sum(&#34;salary&#34;).alias(&#34;total_department_salary&#34;)) departments.join(dept_totals, &#34;department_id&#34;).select(&#34;department_name&#34;, &#34;total_department_salary&#34;).show() # 71 dept_avg = df.groupBy(&#34;department_id&#34;).agg(avg(&#34;salary&#34;).alias(&#34;avg_salary&#34;)) top_dept = dept_avg.orderBy(col(&#34;avg_salary&#34;).desc()).limit(1) departments.join(top_dept, &#34;department_id&#34;).select(&#34;department_name&#34;).show() # 72 buyers = orders.filter(col(&#34;product_id&#34;) == 123).select(&#34;customer_id&#34;).distinct() customers.join(buyers, &#34;customer_id&#34;).select(&#34;customer_name&#34;).show() # 73 df.filter(col(&#34;salary&#34;) &gt; avg_sal).count() # 74 customers.join(orders.select(&#34;customer_id&#34;).distinct(), &#34;customer_id&#34;, &#34;left_anti&#34;).select(&#34;customer_name&#34;).show() # 75 job_avg = df.groupBy(&#34;job_title&#34;).agg(avg(&#34;salary&#34;).alias(&#34;job_avg&#34;)) df.join(job_avg, &#34;job_title&#34;).filter(col(&#34;salary&#34;) &lt; col(&#34;job_avg&#34;)).select(&#34;first_name&#34;, &#34;salary&#34;, &#34;job_title&#34;).show() ðŸªŸ Section 7: Window Functions (76â€“85) SQL -- 76 SELECT first_name, department, salary, ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees; -- 77 SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank FROM employees; -- 78 SELECT first_name, department, salary, DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank FROM employees; -- 79 SELECT first_name, salary, NTILE(4) OVER (ORDER BY salary DESC) AS quartile FROM employees; -- 80 SELECT order_date, total_amount, LEAD(total_amount, 1) OVER (ORDER BY order_date) AS next_order_amount FROM orders; -- 81 SELECT order_date, total_amount, LAG(total_amount, 1, 0) OVER (ORDER BY order_date) AS previous_order_amount FROM orders; -- 82 SELECT order_date, total_amount, SUM(total_amount) OVER (ORDER BY order_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total FROM orders; -- 83 SELECT order_date, total_amount, AVG(total_amount) OVER (ORDER BY order_date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg FROM orders; -- 84 SELECT * FROM ( SELECT first_name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rn FROM employees ) AS ranked_employees WHERE rn &lt;= 3; -- 85 SELECT product_id, SUM(sales) AS product_sales, SUM(SUM(sales)) OVER () AS total_sales, (SUM(sales) / SUM(SUM(sales)) OVER ()) * 100 AS percentage_of_total FROM sales GROUP BY product_id; PySpark w_dept = Window.partitionBy(&#34;department&#34;).orderBy(col(&#34;salary&#34;).desc()) # 76 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, row_number().over(w_dept).alias(&#34;rn&#34;)).show() # 77 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, rank().over(w_dept).alias(&#34;rank&#34;)).show() # 78 df.select(&#34;first_name&#34;, &#34;department&#34;, &#34;salary&#34;, dense_rank().over(w_dept).alias(&#34;dense_rank&#34;)).show() # 79 df.select(&#34;first_name&#34;, &#34;salary&#34;, ntile(4).over(Window.orderBy(col(&#34;salary&#34;).desc())).alias(&#34;quartile&#34;)).show() # 80 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lead(&#34;total_amount&#34;, 1).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;next_order_amount&#34;)).show() # 81 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, lag(&#34;total_amount&#34;, 1, 0).over(Window.orderBy(&#34;order_date&#34;)).alias(&#34;previous_order_amount&#34;)).show() # 82 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, F.sum(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;) .rowsBetween(Window.unboundedPreceding, Window.currentRow)).alias(&#34;running_total&#34;)).show() # 83 orders.select(&#34;order_date&#34;, &#34;total_amount&#34;, avg(&#34;total_amount&#34;).over(Window.orderBy(&#34;order_date&#34;).rowsBetween(-2, Window.currentRow)).alias(&#34;moving_avg&#34;)).show() # 84 df.withColumn(&#34;rn&#34;, rank().over(w_dept)).filter(col(&#34;rn&#34;) &lt;= 3).drop(&#34;rn&#34;).show() # 85 prod_sales = sales.groupBy(&#34;product_id&#34;).agg(sum(&#34;sales&#34;).alias(&#34;product_sales&#34;)) prod_sales.withColumn(&#34;total_sales&#34;, sum(&#34;product_sales&#34;).over(Window.partitionBy()))\ .withColumn(&#34;percentage_of_total&#34;, (col(&#34;product_sales&#34;) / col(&#34;total_sales&#34;)) * 100)\ .select(&#34;product_id&#34;, &#34;product_sales&#34;, &#34;total_sales&#34;, &#34;percentage_of_total&#34;).show() ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100) SQL -- 86 WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary; -- 87 INSERT INTO employees (first_name, last_name, salary) VALUES (&#39;John&#39;, &#39;Doe&#39;, 60000); -- 88 UPDATE employees SET salary = salary * 1.05 WHERE department = &#39;IT&#39;; -- 89 DELETE FROM employees WHERE employee_id = 101; -- 90 TRUNCATE TABLE old_data; -- 91 SELECT first_name FROM employees UNION SELECT first_name FROM customers; -- 92 SELECT first_name FROM employees UNION ALL SELECT first_name FROM customers; -- 93 SELECT first_name, salary, CASE WHEN salary &gt; 100000 THEN &#39;High Earner&#39; WHEN salary BETWEEN 50000 AND 100000 THEN &#39;Mid-Range&#39; ELSE &#39;Junior&#39; END AS salary_level FROM employees; -- 94 SELECT department, COUNT(CASE WHEN salary &gt; 70000 THEN 1 END) AS high_salary_count, COUNT(CASE WHEN salary &lt;= 70000 THEN 1 END) AS low_salary_count FROM employees GROUP BY department; -- 95 SELECT CAST(order_date AS DATE) FROM orders; -- 96 SELECT COALESCE(email, &#39;No Email Provided&#39;) FROM employees; -- 97 SELECT NULLIF(salary, 0) FROM employees; -- 98 (Recursive CTE) WITH RECURSIVE subordinates AS ( SELECT employee_id, manager_id FROM employees WHERE employee_id = 1 UNION ALL SELECT e.employee_id, e.manager_id FROM employees e JOIN subordinates s ON e.manager_id = s.employee_id ) SELECT * FROM subordinates; -- 99 SELECT department, job_title, SUM(salary) FROM employees GROUP BY GROUPING SETS ((department), (job_title), ()); -- 100 SELECT department, job_title, SUM(salary) FROM employees GROUP BY ROLLUP(department, job_title); PySpark # 86 (Use SQL CTE via temp view) df.createOrReplaceTempView(&#34;employees&#34;) spark.sql(&#34;&#34;&#34; WITH department_avg AS ( SELECT department_id, AVG(salary) AS avg_dept_salary FROM employees GROUP BY department_id ) SELECT e.first_name, e.salary, da.avg_dept_salary FROM employees e JOIN department_avg da ON e.department_id = da.department_id WHERE e.salary &gt; da.avg_dept_salary &#34;&#34;&#34;).show() # 87 (Insert-like: union new rows) df_new = spark.createDataFrame([(&#34;John&#34;, &#34;Doe&#34;, 60000)], [&#34;first_name&#34;, &#34;last_name&#34;, &#34;salary&#34;]) df = df.unionByName(df_new) # 88 (Update-like) df = df.withColumn(&#34;salary&#34;, when(col(&#34;department&#34;) == &#34;IT&#34;, col(&#34;salary&#34;) * 1.05).otherwise(col(&#34;salary&#34;))) # 89 (Delete-like) df = df.filter(col(&#34;employee_id&#34;) != 101) # 90 (Truncate-like in-memory) df = df.limit(0) # for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;) # 91 UNION (distinct) df_union_distinct = df1.union(df2).distinct() # 92 UNION ALL df_union_all = df1.union(df2) # 93 CASE/WHEN df.select(&#34;first_name&#34;, &#34;salary&#34;, when(col(&#34;salary&#34;) &gt; 100000, &#34;High Earner&#34;) .when((col(&#34;salary&#34;) &gt;= 50000) &amp; (col(&#34;salary&#34;) &lt;= 100000), &#34;Mid-Range&#34;) .otherwise(&#34;Junior&#34;).alias(&#34;salary_level&#34;)).show() # 94 Pivot without true pivot df.groupBy(&#34;department&#34;).agg( count(when(col(&#34;salary&#34;) &gt; 70000, 1)).alias(&#34;high_salary_count&#34;), count(when(col(&#34;salary&#34;) &lt;= 70000, 1)).alias(&#34;low_salary_count&#34;) ).show() # 95 CAST orders.select(col(&#34;order_date&#34;).cast(&#34;date&#34;).alias(&#34;order_date&#34;)).show() # 96 COALESCE df.select(coalesce(col(&#34;email&#34;), lit(&#34;No Email Provided&#34;)).alias(&#34;email&#34;)).show() # 97 NULLIF(salary,0) =&gt; NULL when equal df.select(when(col(&#34;salary&#34;) == 0, lit(None)).otherwise(col(&#34;salary&#34;)).alias(&#34;salary_or_null&#34;)).show() # 98 Recursive CTE not native; iterative approach example (hierarchy traversal) # Start with seed seed = df.filter(col(&#34;employee_id&#34;) == 1).select(&#34;employee_id&#34;, &#34;manager_id&#34;) result = seed frontier = seed while True: step = df.select(&#34;employee_id&#34;, &#34;manager_id&#34;)\ .join(frontier, df.manager_id == frontier.employee_id, &#34;inner&#34;)\ .select(df.employee_id, df.manager_id).dropDuplicates() new_nodes = step.join(result, [&#34;employee_id&#34;, &#34;manager_id&#34;], &#34;left_anti&#34;) if new_nodes.rdd.isEmpty(): break result = result.unionByName(new_nodes).dropDuplicates() frontier = new_nodes # result contains recursive closure # 99 GROUPING SETS -&gt; cube with filters cube_df = df.cube(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)) # Keep only grouping sets: (department), (job_title), () from pyspark.sql.functions import grouping_id cube_df.filter( (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 1) | # (department,NULL) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 2) | # (NULL,job_title) (grouping_id(&#34;department&#34;, &#34;job_title&#34;) == 3) # (NULL,NULL) ).show() # 100 ROLLUP df.rollup(&#34;department&#34;, &#34;job_title&#34;).agg(sum(&#34;salary&#34;).alias(&#34;sum_salary&#34;)).show() âœ… Notes Some SQL constructs (OFFSET, Recursive CTE) donâ€™t map 1:1 to PySpark; patterns above show practical equivalents. Replace .show() with .write.format(&#34;delta&#34;)... to persist as needed.">
    <meta itemprop="wordCount" content="2527">
    <title>SQL &amp; PySpark Queries :: Data Engineering Notes</title>
    <link href="/interviewprep/quick-ref/index.md" rel="alternate" type="text/markdown" title="SQL &amp; PySpark Queries :: Data Engineering Notes">
    <link href="/interviewprep/quick-ref/index.print.html" rel="alternate" type="text/html" title="SQL &amp; PySpark Queries :: Data Engineering Notes">
    <link href="/images/favicon.ico?1761501432" rel="icon" type="image/x-icon" sizes="any">
    <link href="/css/auto-complete/auto-complete.min.css?1761501432" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1761501432" defer></script>
    <script src="/js/search-lunr.js?1761501432" defer></script>
    <script src="/js/search.js?1761501432" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1761501432";
    </script>
    <script src="/js/lunr/lunr.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1761501432" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761501432" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761501432" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1761501432" rel="stylesheet">
    <link href="/css/theme.css?1761501432" rel="stylesheet">
    <link href="/css/format-html.css?1761501432" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/interviewprep\/quick-ref\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'auto', 'zen-light', 'zen-dark' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 1000rem;
}
</style>
  </head>
  <body class="mobile-support html" data-url="/interviewprep/quick-ref/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#-section-1-basic-queries-110">ðŸ§© Section 1: Basic Queries (1â€“10)</a>
      <ul>
        <li><a href="#sql">SQL</a></li>
        <li><a href="#pyspark">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-2-filtering--pattern-matching-1120">ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20)</a>
      <ul>
        <li><a href="#sql-1">SQL</a></li>
        <li><a href="#pyspark-1">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-3-sorting--limiting-2130">â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30)</a>
      <ul>
        <li><a href="#sql-2">SQL</a></li>
        <li><a href="#pyspark-2">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-4-aggregation--grouping-3140">ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40)</a>
      <ul>
        <li><a href="#sql-3">SQL</a></li>
        <li><a href="#pyspark-3">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-5-joins-4160">ðŸ”— Section 5: Joins (41â€“60)</a>
      <ul>
        <li><a href="#sql-4">SQL</a></li>
        <li><a href="#pyspark-4">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-6-subqueries-6175">ðŸ§  Section 6: Subqueries (61â€“75)</a>
      <ul>
        <li><a href="#sql-5">SQL</a></li>
        <li><a href="#pyspark-5">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-7-window-functions-7685">ðŸªŸ Section 7: Window Functions (76â€“85)</a>
      <ul>
        <li><a href="#sql-6">SQL</a></li>
        <li><a href="#pyspark-6">PySpark</a></li>
      </ul>
    </li>
    <li><a href="#-section-8-ctes--data-manipulation-86100">ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100)</a>
      <ul>
        <li><a href="#sql-7">SQL</a></li>
        <li><a href="#pyspark-7">PySpark</a></li>
        <li><a href="#-notes">âœ… Notes</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class="a11y-only"><a itemprop="item" href="/"><span itemprop="name">Data Engineering Notes</span></a><meta itemprop="position" content="1">&nbsp;/&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/interviewprep/"><span itemprop="name">Interview Prep</span></a><meta itemprop="position" content="2">&nbsp;/&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">SQL &amp; PySpark Queries</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-edit" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://github.com/jampalabharath/relearn/tree/main/content/InterviewPrep/Quick-Ref.md" rel="external" target="_blank" title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a>
            </div>
            <div class="topbar-button topbar-button-markdown" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/quick-ref/index.md" title="Show Markdown"><i class="fa-fw fab fa-markdown"></i></a>
            </div>
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/quick-ref/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/sql3/" title="SQL cheat sheet (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><span class="topbar-control"><i class="fa-fw fas fa-chevron-right"></i></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable interviewprep" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="sql--pyspark-queries">SQL &amp; PySpark Queries</h1>

<p>This guide pairs each <strong>SQL</strong> example with a <strong>PySpark DataFrame API</strong> equivalent.<br>
Assumptions: <code>df</code> is <code>employees</code>, and other tables are similarly named DataFrames (<code>departments</code>, <code>orders</code>, etc.).</p>
<blockquote>
<p><strong>Imports used in PySpark examples</strong></p></blockquote>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">row_number</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">ntile</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">coalesce</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span></span></span></code></pre></div>
<hr>
<h2 id="-section-1-basic-queries-110">ðŸ§© Section 1: Basic Queries (1â€“10)</h2>
<h3 id="sql">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 5</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 6</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 7</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 8</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 9</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 10</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;IT&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-2-filtering--pattern-matching-1120">ðŸ”Ž Section 2: Filtering &amp; Pattern Matching (11â€“20)</h2>
<h3 id="sql-1">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">75000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">ILIKE</span><span class="w"> </span><span class="s1">&#39;%jo%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 15
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Smi%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@gmail.com&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 17
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;_a%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">&#39;2023-12-31&#39;</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-1">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 11</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="s2">&#34;Sales&#34;</span><span class="p">,</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">,</span> <span class="s2">&#34;IT&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 12</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="s2">&#34;Sales&#34;</span><span class="p">,</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 13</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">75000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 14  (case-insensitive search)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">lower</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&#34;%jo%&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 15</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;Smi&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 16</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;@gmail.com&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 17  (single char then &#39;a&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rlike</span><span class="p">(</span><span class="s2">&#34;^.a.*&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 18</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;manager_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 19</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;manager_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 20</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="s2">&#34;2023-01-01&#34;</span><span class="p">,</span> <span class="s2">&#34;2023-12-31&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-3-sorting--limiting-2130">â†•ï¸ Section 3: Sorting &amp; Limiting (21â€“30)</h2>
<h3 id="sql-2">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 21
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 22
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 23
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 25
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 26
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 27
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 29
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bonus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">bonus</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-2">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 21</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 22</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 23</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 24</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 25</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 26</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 27  (rows 11â€“20): use ROW_NUMBER then filter</span>
</span></span><span class="line"><span class="cl"><span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 28</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 29  (second-highest salary) â€“ two ways</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># or using dense_rank</span>
</span></span><span class="line"><span class="cl"><span class="n">w2</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dr&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;dr&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 30</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-4-aggregation--grouping-3140">ðŸ“Š Section 4: Aggregation &amp; Grouping (31â€“40)</h2>
<h3 id="sql-3">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 31
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 33
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 34
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 35
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 36
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">65000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 37
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2022-01-01&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 39
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-3">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 31</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 32</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 33</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 34</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;max_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 35</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;min_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 36</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65000</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 37</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 38</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&#34;2022-01-01&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 39</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 40</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;max_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-5-joins-4160">ðŸ”— Section 5: Joins (41â€“60)</h2>
<h3 id="sql-4">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 41
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 43
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 44
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 45
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 46
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 47
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 48
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 49
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 50
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">sale_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 51
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 52
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 53
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 54
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 55
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">last_purchase_date</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 56
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 57
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">salary_grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">salary_grades</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">min_salary</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">max_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 58
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;New York&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 59
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 60
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">table_a</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">table_b</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_id</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-4">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 41</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;inner&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 42</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 43</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">departments</span><span class="o">.</span><span class="n">department_id</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 44</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;right&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 45</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;outer&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 46</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;project_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 47</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">);</span> <span class="n">m</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;m&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.manager_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.employee_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;employee&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;manager&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 48</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">orders</span><span class="o">.</span><span class="n">customer_zip_code</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_zip_code</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_id&#34;</span><span class="p">,</span> <span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 49</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">departments</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 50</span>
</span></span><span class="line"><span class="cl"><span class="n">products</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;sale_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">products</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&#34;product_id&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 51</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employee_projects</span><span class="p">,</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;project_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 52</span>
</span></span><span class="line"><span class="cl"><span class="n">projects</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employee_projects</span><span class="p">,</span> <span class="s2">&#34;project_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;project_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 53</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employees</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 54</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employees</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;num_employees&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 55</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">order_date</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">last_purchase_date</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">],</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 56</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">);</span> <span class="n">m</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;m&#34;</span><span class="p">);</span> <span class="n">d</span> <span class="o">=</span> <span class="n">departments</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;d&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.manager_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.employee_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.department_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;d.department_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.first_name&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;manager_name&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;d.department_name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 57</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">salary_grades</span><span class="p">,</span> <span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">salary</span> <span class="o">&gt;=</span> <span class="n">salary_grades</span><span class="o">.</span><span class="n">min_salary</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;=</span> <span class="n">salary_grades</span><span class="o">.</span><span class="n">max_salary</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;salary_grade&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 58</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;location_city&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;New York&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 59</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 60</span>
</span></span><span class="line"><span class="cl"><span class="n">table_a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_b</span><span class="p">,</span> <span class="n">table_a</span><span class="o">.</span><span class="n">product_id</span> <span class="o">==</span> <span class="n">table_b</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">       <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table_a</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">table_b</span><span class="o">.</span><span class="n">item_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-6-subqueries-6175">ðŸ§  Section 6: Subqueries (61â€“75)</h2>
<h3 id="sql-5">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 61
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 62
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;San Francisco&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 63
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">company_avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 65
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 66
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 67
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 68
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 69
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_department_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 71
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 72
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 73
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 74
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 75
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">job_title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="p">);</span></span></span></code></pre></div>
<h3 id="pyspark-5">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 61</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_sal</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="s2">&#34;avg&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">avg_sal</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 62</span>
</span></span><span class="line"><span class="cl"><span class="n">sf_depts</span> <span class="o">=</span> <span class="n">departments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;location_city&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;San Francisco&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sf_depts</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 63</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 64</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_val</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="s2">&#34;avg&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="n">avg_val</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;company_avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 65</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dept_avg&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept_avg</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;dept_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 66</span>
</span></span><span class="line"><span class="cl"><span class="n">high_paid</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">high_paid</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 67</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 68</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 69</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 70</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_totals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_department_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept_totals</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;total_department_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 71</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">top_dept</span> <span class="o">=</span> <span class="n">dept_avg</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top_dept</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 72</span>
</span></span><span class="line"><span class="cl"><span class="n">buyers</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">customers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buyers</span><span class="p">,</span> <span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 73</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">avg_sal</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 74</span>
</span></span><span class="line"><span class="cl"><span class="n">customers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;customer_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 75</span>
</span></span><span class="line"><span class="cl"><span class="n">job_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;job_avg&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_avg</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;job_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-7-window-functions-7685">ðŸªŸ Section 7: Window Functions (76â€“85)</h2>
<h3 id="sql-6">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 76
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 77
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">DENSE_RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dense_rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 79
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">NTILE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">quartile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LEAD</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">next_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 81
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LAG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 82
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">running_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 83
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">moving_avg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 84
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ranked_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 85
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">product_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percentage_of_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-6">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w_dept</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 76</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 77</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;rank&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 78</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dense_rank&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 79</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">ntile</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;quartile&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 80</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">lead</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;next_order_amount&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 81</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">lag</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;previous_order_amount&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 82</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;running_total&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 83</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">avg</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;moving_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 84</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 85</span>
</span></span><span class="line"><span class="cl"><span class="n">prod_sales</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">prod_sales</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;total_sales&#34;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">()))</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;percentage_of_total&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">)</span> <span class="o">/</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;total_sales&#34;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="s2">&#34;product_sales&#34;</span><span class="p">,</span> <span class="s2">&#34;total_sales&#34;</span><span class="p">,</span> <span class="s2">&#34;percentage_of_total&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-8-ctes--data-manipulation-86100">ðŸ§® Section 8: CTEs &amp; Data Manipulation (86â€“100)</h2>
<h3 id="sql-7">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 86
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="n">da</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 87
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 88
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 89
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 90
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">old_data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 91
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 92
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 93
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;High Earner&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Mid-Range&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Junior&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salary_level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 94
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">high_salary_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">low_salary_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 95
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 96
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">COALESCE</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No Email Provided&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 97
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 98 (Recursive CTE)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">subordinates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 99
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">((</span><span class="n">department</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">job_title</span><span class="p">),</span><span class="w"> </span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 100
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">ROLLUP</span><span class="p">(</span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">);</span></span></span></code></pre></div>
<h3 id="pyspark-7">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 86  (Use SQL CTE via temp view)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&#34;employees&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">WITH department_avg AS (
</span></span></span><span class="line"><span class="cl"><span class="s2">  SELECT department_id, AVG(salary) AS avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">  FROM employees GROUP BY department_id
</span></span></span><span class="line"><span class="cl"><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">SELECT e.first_name, e.salary, da.avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">FROM employees e
</span></span></span><span class="line"><span class="cl"><span class="s2">JOIN department_avg da ON e.department_id = da.department_id
</span></span></span><span class="line"><span class="cl"><span class="s2">WHERE e.salary &gt; da.avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 87  (Insert-like: union new rows)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_new</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s2">&#34;John&#34;</span><span class="p">,</span> <span class="s2">&#34;Doe&#34;</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)],</span> <span class="p">[</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 88  (Update-like)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;IT&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 89  (Delete-like)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">101</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 90  (Truncate-like in-memory)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 91  UNION (distinct)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_union_distinct</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 92  UNION ALL</span>
</span></span><span class="line"><span class="cl"><span class="n">df_union_all</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 93  CASE/WHEN</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&#34;High Earner&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100000</span><span class="p">),</span> <span class="s2">&#34;Mid-Range&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="s2">&#34;Junior&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;salary_level&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 94  Pivot without true pivot</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;high_salary_count&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;low_salary_count&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 95  CAST</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 96  COALESCE</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;No Email Provided&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 97  NULLIF(salary,0) =&gt; NULL when equal</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;salary_or_null&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 98  Recursive CTE not native; iterative approach example (hierarchy traversal)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Start with seed</span>
</span></span><span class="line"><span class="cl"><span class="n">seed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl"><span class="n">frontier</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">step</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frontier</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">manager_id</span> <span class="o">==</span> <span class="n">frontier</span><span class="o">.</span><span class="n">employee_id</span><span class="p">,</span> <span class="s2">&#34;inner&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">employee_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">manager_id</span><span class="p">)</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">],</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">new_nodes</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">frontier</span> <span class="o">=</span> <span class="n">new_nodes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># result contains recursive closure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 99  GROUPING SETS -&gt; cube with filters</span>
</span></span><span class="line"><span class="cl"><span class="n">cube_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cube</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;sum_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Keep only grouping sets: (department), (job_title), ()</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">grouping_id</span>
</span></span><span class="line"><span class="cl"><span class="n">cube_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># (department,NULL)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># (NULL,job_title)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>    <span class="c1"># (NULL,NULL)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 100  ROLLUP</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;sum_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h3 id="-notes">âœ… Notes</h3>
<ul>
<li>Some SQL constructs (OFFSET, Recursive CTE) donâ€™t map 1:1 to PySpark; patterns above show practical equivalents.</li>
<li>Replace <code>.show()</code> with <code>.write.format(&quot;delta&quot;)...</code> to persist as needed.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<head>
  <style>
    #R-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: auto;
    }

    #R-logo img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }

    #R-logo img:hover {
      transform: scale(1.05);
    }

    #R-logo .logo-title {
  margin-left: 0.5rem;   
  font-size: 1.2rem;     
  line-height: 1;        
  display: flex;
  align-items: center;   
}
  </style>
</head>



<a id="R-logo" class="R-default" href="/">
  <img src="/images/logo.png" alt="brand logo">
  <span class="logo-title">Relearn</span>
</a>
        </div>
        <search><form action="/search/" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/sql/"><input type="checkbox" id="R-section-6b91b02647756f9b5e29b003bccc4db0" aria-controls="R-subsections-6b91b02647756f9b5e29b003bccc4db0"><label for="R-section-6b91b02647756f9b5e29b003bccc4db0"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu SQL</span></label><a class="padding" href="/sql/">SQL<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-6b91b02647756f9b5e29b003bccc4db0" class="collapsible-menu">
            <li class="" data-nav-id="/sql/select/"><a class="padding" href="/sql/select/">SELECT Query<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/ddl/"><a class="padding" href="/sql/ddl/">DDL<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/dml/"><a class="padding" href="/sql/dml/">DML<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/filter/"><a class="padding" href="/sql/filter/">Filtering Data<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/joins/"><a class="padding" href="/sql/joins/">Joins<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/set-operations/"><a class="padding" href="/sql/set-operations/">Set Operations<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/string-functions/"><a class="padding" href="/sql/string-functions/">String Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/number-functions/"><a class="padding" href="/sql/number-functions/">Number Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/date-time1/"><a class="padding" href="/sql/date-time1/">Date &amp; Time Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/date-time2/"><a class="padding" href="/sql/date-time2/">Date &amp; Time Formats<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/null-functions/"><a class="padding" href="/sql/null-functions/">NULL Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/case-statement/"><a class="padding" href="/sql/case-statement/">CASE Statement<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/aggregate-functions/"><a class="padding" href="/sql/aggregate-functions/">Aggregate Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-functions/"><a class="padding" href="/sql/window-functions/">Window Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window_aggregations/"><a class="padding" href="/sql/window_aggregations/">Window Aggregate Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-ranking/"><a class="padding" href="/sql/window-ranking/">Window Ranking Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-value-functions/"><a class="padding" href="/sql/window-value-functions/">Window Value Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/subqueries/"><a class="padding" href="/sql/subqueries/">Subquery Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/cte/"><a class="padding" href="/sql/cte/">Common Table Expressions (CTEs)<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/views/"><a class="padding" href="/sql/views/">Views<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/temporary-tables/"><a class="padding" href="/sql/temporary-tables/">Temporary Tables<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/stored-procedures/"><a class="padding" href="/sql/stored-procedures/">Stored Procedures<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/triggers/"><a class="padding" href="/sql/triggers/">Triggers<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/indexes/"><a class="padding" href="/sql/indexes/">Indexes<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/partitions/"><a class="padding" href="/sql/partitions/">Partitioning<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/performance-optimization/"><a class="padding" href="/sql/performance-optimization/">Performance Tips<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/ai-and-sql/"><a class="padding" href="/sql/ai-and-sql/">AI and SQL<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="" data-nav-id="/azure_data_factory/"><a class="padding" href="/azure_data_factory/">ADF<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/"><input type="checkbox" id="R-section-be307a2f2d32c2a195add2e28563a24e" aria-controls="R-subsections-be307a2f2d32c2a195add2e28563a24e"><label for="R-section-be307a2f2d32c2a195add2e28563a24e"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu ADB</span></label><a class="padding" href="/azure_data_bricks/">ADB<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-be307a2f2d32c2a195add2e28563a24e" class="collapsible-menu">
            <li class="" data-nav-id="/azure_data_bricks/spark/"><a class="padding" href="/azure_data_bricks/spark/">Spark<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/df-creation/"><a class="padding" href="/azure_data_bricks/df-creation/">DF Basics<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/df-operations/"><a class="padding" href="/azure_data_bricks/df-operations/">DF Operations<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/functions/"><a class="padding" href="/azure_data_bricks/functions/">Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/date/"><a class="padding" href="/azure_data_bricks/date/">Date Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/nulls/"><a class="padding" href="/azure_data_bricks/nulls/">Handling Nulls<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/aggregations/"><a class="padding" href="/azure_data_bricks/aggregations/">Aggregate functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/joins/"><a class="padding" href="/azure_data_bricks/joins/">Joins<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/when/"><a class="padding" href="/azure_data_bricks/when/">When|Cast|Union<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/window-functions/"><a class="padding" href="/azure_data_bricks/window-functions/">Window Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/explode/"><a class="padding" href="/azure_data_bricks/explode/">Explode<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/pivot/"><a class="padding" href="/azure_data_bricks/pivot/">Pivot<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/comparisons/"><a class="padding" href="/azure_data_bricks/comparisons/">Comparisons<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="" data-nav-id="/practice/"><input type="checkbox" id="R-section-21344c0a5719731e2ce7649deede330a" aria-controls="R-subsections-21344c0a5719731e2ce7649deede330a"><label for="R-section-21344c0a5719731e2ce7649deede330a"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu Practice Sets</span></label><a class="padding" href="/practice/">Practice Sets<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-21344c0a5719731e2ce7649deede330a" class="collapsible-menu">
            <li class="" data-nav-id="/practice/leetcode-sql/"><a class="padding" href="/practice/leetcode-sql/">SQL LeetCode<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/practice/pyspark1/"><a class="padding" href="/practice/pyspark1/">Pyspark 1<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="parent " data-nav-id="/interviewprep/"><input type="checkbox" id="R-section-4c46d08ac015ee7f150578d25f17ee2b" aria-controls="R-subsections-4c46d08ac015ee7f150578d25f17ee2b" checked><label for="R-section-4c46d08ac015ee7f150578d25f17ee2b"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu Interview Prep</span></label><a class="padding" href="/interviewprep/">Interview Prep<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-4c46d08ac015ee7f150578d25f17ee2b" class="collapsible-menu">
            <li class="" data-nav-id="/interviewprep/adf1/"><a class="padding" href="/interviewprep/adf1/">ADF 1<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/pipeline1/"><a class="padding" href="/interviewprep/pipeline1/">Data Pipeline<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql1/"><a class="padding" href="/interviewprep/sql1/">SQL Theory<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql2/"><a class="padding" href="/interviewprep/sql2/">100 SQL Queries<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql3/"><a class="padding" href="/interviewprep/sql3/">SQL cheat sheet<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="active " data-nav-id="/interviewprep/quick-ref/"><a class="padding" href="/interviewprep/quick-ref/">SQL &amp; PySpark Queries<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
            <li class="R-variantswitcher">
              <div class="padding menu-control">
                <i class="fa-fw fas fa-paint-brush"></i>
                <span>&nbsp;</span>
                <div class="control-style">
                  <label class="a11y-only" for="R-select-variant">Theme</label>
                  <select id="R-select-variant">
                    <option id="R-select-variant-auto" value="auto" selected>Auto</option>
                    <option id="R-select-variant-zen-light" value="zen-light">Zen Light</option>
                    <option id="R-select-variant-zen-dark" value="zen-dark">Zen Dark</option>
                  </select>
                </div>
                <div class="clear"></div>
              </div>
              <script>window.relearn.markVariant();</script>
            </li>
            <li class="R-historyclearer">
              <div class="padding menu-control">
                <i class="fa-fw fas fa-history"></i>
                <span>&nbsp;</span>
                <div class="control-style">
                  <button>Clear History</button>
                </div>
                <div class="clear"></div>
              </div>
            </li>
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/clipboard/clipboard.min.js?1761501432" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1761501432" defer></script>
    <script src="/js/theme.js?1761501432" defer></script>
  </body>
</html>
