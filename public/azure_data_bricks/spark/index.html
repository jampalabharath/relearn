<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="description" content="What is Spark? Spark is an open source unified computing engine with a set of libraries for parallel data processing on a computer cluster.
It supports widely used programming languages such as:
Scala Python Java R It processes data in memory (RAM), which makes it 100 times faster than traditional Hadoop MapReduce.
flowchart TDsubgraph DriverProgram[Driver Program]SS[SparkSession]SC[SparkContext]SS --&gt; SCendCM[Cluster Manager]subgraph Worker1[Worker Node]subgraph Executor1[Executor]T1[Task]T2[Task]C1[Cache]endendsubgraph Worker2[Worker Node]subgraph Executor2[Executor]T3[Task]T4[Task]C2[Cache]endendSC --&gt; CMCM --&gt; Executor1CM --&gt; Executor2SC --&gt; Executor1SC --&gt; Executor2Executor1 --&gt; T1Executor1 --&gt; T2Executor1 --&gt; C1Executor2 --&gt; T3Executor2 --&gt; T4Executor2 --&gt; C2 Spark Components Following represents Spark components at a high level:">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Spark :: Data Engineering Notes">
    <meta name="twitter:description" content="What is Spark? Spark is an open source unified computing engine with a set of libraries for parallel data processing on a computer cluster.
It supports widely used programming languages such as:
Scala Python Java R It processes data in memory (RAM), which makes it 100 times faster than traditional Hadoop MapReduce.
flowchart TDsubgraph DriverProgram[Driver Program]SS[SparkSession]SC[SparkContext]SS --&gt; SCendCM[Cluster Manager]subgraph Worker1[Worker Node]subgraph Executor1[Executor]T1[Task]T2[Task]C1[Cache]endendsubgraph Worker2[Worker Node]subgraph Executor2[Executor]T3[Task]T4[Task]C2[Cache]endendSC --&gt; CMCM --&gt; Executor1CM --&gt; Executor2SC --&gt; Executor1SC --&gt; Executor2Executor1 --&gt; T1Executor1 --&gt; T2Executor1 --&gt; C1Executor2 --&gt; T3Executor2 --&gt; T4Executor2 --&gt; C2 Spark Components Following represents Spark components at a high level:">
    <meta property="og:url" content="http://localhost:1313/azure_data_bricks/spark/">
    <meta property="og:site_name" content="Data Engineering Notes">
    <meta property="og:title" content="Spark :: Data Engineering Notes">
    <meta property="og:description" content="What is Spark? Spark is an open source unified computing engine with a set of libraries for parallel data processing on a computer cluster.
It supports widely used programming languages such as:
Scala Python Java R It processes data in memory (RAM), which makes it 100 times faster than traditional Hadoop MapReduce.
flowchart TDsubgraph DriverProgram[Driver Program]SS[SparkSession]SC[SparkContext]SS --&gt; SCendCM[Cluster Manager]subgraph Worker1[Worker Node]subgraph Executor1[Executor]T1[Task]T2[Task]C1[Cache]endendsubgraph Worker2[Worker Node]subgraph Executor2[Executor]T3[Task]T4[Task]C2[Cache]endendSC --&gt; CMCM --&gt; Executor1CM --&gt; Executor2SC --&gt; Executor1SC --&gt; Executor2Executor1 --&gt; T1Executor1 --&gt; T2Executor1 --&gt; C1Executor2 --&gt; T3Executor2 --&gt; T4Executor2 --&gt; C2 Spark Components Following represents Spark components at a high level:">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Azure Data Bricks">
    <meta itemprop="name" content="Spark :: Data Engineering Notes">
    <meta itemprop="description" content="What is Spark? Spark is an open source unified computing engine with a set of libraries for parallel data processing on a computer cluster.
It supports widely used programming languages such as:
Scala Python Java R It processes data in memory (RAM), which makes it 100 times faster than traditional Hadoop MapReduce.
flowchart TDsubgraph DriverProgram[Driver Program]SS[SparkSession]SC[SparkContext]SS --&gt; SCendCM[Cluster Manager]subgraph Worker1[Worker Node]subgraph Executor1[Executor]T1[Task]T2[Task]C1[Cache]endendsubgraph Worker2[Worker Node]subgraph Executor2[Executor]T3[Task]T4[Task]C2[Cache]endendSC --&gt; CMCM --&gt; Executor1CM --&gt; Executor2SC --&gt; Executor1SC --&gt; Executor2Executor1 --&gt; T1Executor1 --&gt; T2Executor1 --&gt; C1Executor2 --&gt; T3Executor2 --&gt; T4Executor2 --&gt; C2 Spark Components Following represents Spark components at a high level:">
    <meta itemprop="wordCount" content="6464">
    <title>Spark :: Data Engineering Notes</title>
    <link href="/azure_data_bricks/spark/index.md" rel="alternate" type="text/markdown" title="Spark :: Data Engineering Notes">
    <link href="/azure_data_bricks/spark/index.print.html" rel="alternate" type="text/html" title="Spark :: Data Engineering Notes">
    <link href="/images/favicon.ico?1761498837" rel="icon" type="image/x-icon" sizes="any">
    <link href="/css/auto-complete/auto-complete.min.css?1761498837" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1761498837" defer></script>
    <script src="/js/search-lunr.js?1761498837" defer></script>
    <script src="/js/search.js?1761498837" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1761498837";
    </script>
    <script src="/js/lunr/lunr.min.js?1761498837" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1761498837" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1761498837" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1761498837" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761498837" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761498837" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1761498837" rel="stylesheet">
    <link href="/css/theme.css?1761498837" rel="stylesheet">
    <link href="/css/format-html.css?1761498837" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/azure_data_bricks\/spark\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'auto', 'zen-light', 'zen-dark' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 1000rem;
}
</style>
  </head>
  <body class="mobile-support html" data-url="/azure_data_bricks/spark/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#what-is-spark">What is Spark?</a>
      <ul>
        <li><a href="#spark-components">Spark Components</a></li>
      </ul>
    </li>
    <li><a href="#how-spark-works">How Spark Works</a>
      <ul>
        <li><a href="#1-drivers-and-executors">1. Drivers and Executors</a></li>
        <li><a href="#2-jobs-stages-and-tasks">2. Jobs, Stages, and Tasks</a></li>
      </ul>
    </li>
    <li><a href="#what-is-partition">What is Partition?</a></li>
    <li><a href="#what-is-transformation">What is Transformation?</a></li>
    <li><a href="#what-are-actions">What are Actions?</a>
      <ul>
        <li><a href="#spark-prefers-lazy-evaluation">Spark prefers Lazy Evaluation</a></li>
        <li><a href="#shuffle-in-spark">Shuffle in Spark</a></li>
      </ul>
    </li>
    <li><a href="#what-is-spark-session">What is Spark Session?</a>
      <ul>
        <li><a href="#structured-api---dataframes">Structured API - DataFrames</a></li>
        <li><a href="#structured-api-execution-plan">Structured API Execution Plan</a></li>
        <li><a href="#1-logial-planning">1. <strong>Logial Planning</strong></a></li>
        <li><a href="#2-physical-planning">2. <strong>Physical Planning</strong></a></li>
        <li><a href="#3-dag-directed-acyclic-graph">3. DAG (Directed Acyclic Graph)</a></li>
        <li><a href="#summary-flow">Summary Flow</a></li>
      </ul>
    </li>
    <li><a href="#creating-a-spark-session-in-pyspark">Creating a Spark Session in PySpark</a>
      <ul>
        <li><a href="#example">Example</a></li>
      </ul>
    </li>
    <li><a href="#creating-dataframes-in-pyspark">Creating DataFrames in PySpark</a>
      <ul>
        <li><a href="#1-from-in-memory-data">1. From In-Memory Data</a></li>
        <li><a href="#2-from-file">2. From File</a></li>
      </ul>
    </li>
    <li><a href="#01-spark-session">01 Spark Session</a></li>
    <li><a href="#02-basic-transformations-1">02 Basic Transformations 1</a></li>
    <li><a href="#03-basic-transformations-2">03 Basic Transformations 2</a></li>
    <li><a href="#04-string-and-dates">04 String And Dates</a></li>
    <li><a href="#05-sort-union-aggregation">05 Sort Union Aggregation</a></li>
    <li><a href="#06-unique-data-and-window">06 Unique Data And Window</a></li>
    <li><a href="#07-joins-and-data-partitions">07 Joins And Data Partitions</a></li>
    <li><a href="#08-reading-from-csv-files">08 Reading From Csv Files</a></li>
    <li><a href="#09-reading-complex-data-formats">09 Reading Complex Data Formats</a></li>
    <li><a href="#10-read-json-files">10 Read Json Files</a></li>
    <li><a href="#11-writing-data">11 Writing Data</a></li>
    <li><a href="#12-understand-cluster">12 Understand Cluster</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#understand-cluster-python">Understand Cluster (Python)</a></li>
  </ul>

  <ul>
    <li><a href="#14-understand-dag-plan">14 Understand Dag Plan</a></li>
    <li><a href="#15-optimizing-shuffles">15 Optimizing Shuffles</a></li>
    <li><a href="#16-spark-caching-techiniques">16 Spark Caching Techiniques</a></li>
    <li><a href="#17-distributed-shared-variables">17 Distributed Shared Variables</a></li>
    <li><a href="#18-optimizing-joins">18 Optimizing Joins</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#19-dynamic-allocation">19 Dynamic Allocation</a></li>
    <li><a href="#20-skewness-and-spillage">20 Skewness And Spillage</a></li>
    <li><a href="#21-aqe-spark">21 Aqe Spark</a></li>
    <li><a href="#22-spark-sql">22 Spark Sql</a></li>
    <li><a href="#23-delta-lake">23 Delta Lake</a></li>
    <li><a href="#24-data-scanning-and-partitioning">24 Data Scanning And Partitioning</a></li>
    <li><a href="#25-delta-lake-optimization-and-z-ordering">25 Delta Lake Optimization And Z Ordering</a></li>
    <li><a href="#26-run-concurrent-tasks">26 Run Concurrent Tasks</a></li>
    <li><a href="#27-spark-memory-and-oom">27 Spark Memory And Oom</a></li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class="a11y-only"><a itemprop="item" href="/"><span itemprop="name">Data Engineering Notes</span></a><meta itemprop="position" content="1">&nbsp;/&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/azure_data_bricks/"><span itemprop="name">ADB</span></a><meta itemprop="position" content="2">&nbsp;/&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Spark</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-edit" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://github.com/jampalabharath/relearn/tree/main/content/Azure_Data_Bricks/Spark.md" rel="external" target="_blank" title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a>
            </div>
            <div class="topbar-button topbar-button-markdown" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/azure_data_bricks/spark/index.md" title="Show Markdown"><i class="fa-fw fab fa-markdown"></i></a>
            </div>
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/azure_data_bricks/spark/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/azure_data_bricks/" title="Azure Data Bricks (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/azure_data_bricks/df-creation/" title="DF Basics (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable azure_data_bricks" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="spark">Spark</h1>

<h2 id="what-is-spark">What is Spark?</h2>
<p><strong>Spark</strong> is an open source unified computing engine with a set of libraries for <strong>parallel data processing</strong> on a computer cluster.</p>
<p>It supports widely used programming languages such as:</p>
<ul>
<li><strong>Scala</strong></li>
<li><strong>Python</strong></li>
<li><strong>Java</strong></li>
<li><strong>R</strong></li>
</ul>
<p>It processes data in <strong>memory (RAM)</strong>, which makes it 100 times faster than traditional Hadoop MapReduce.</p>
<pre class="mermaid align-center ">flowchart TD
    subgraph DriverProgram[Driver Program]
        SS[SparkSession]
        SC[SparkContext]
        SS --&gt; SC
    end

    CM[Cluster Manager]

    subgraph Worker1[Worker Node]
        subgraph Executor1[Executor]
            T1[Task]
            T2[Task]
            C1[Cache]
        end
    end

    subgraph Worker2[Worker Node]
        subgraph Executor2[Executor]
            T3[Task]
            T4[Task]
            C2[Cache]
        end
    end

    SC --&gt; CM
    CM --&gt; Executor1
    CM --&gt; Executor2
    SC --&gt; Executor1
    SC --&gt; Executor2
    Executor1 --&gt; T1
    Executor1 --&gt; T2
    Executor1 --&gt; C1
    Executor2 --&gt; T3
    Executor2 --&gt; T4
    Executor2 --&gt; C2</pre>
<h3 id="spark-components">Spark Components</h3>
<p>Following represents Spark components at a high level:</p>
<ul>
<li>Low Level API â€“ RDD &amp; Distributed Variables</li>
<li>Structured API â€“ DataFrames, Datasets, and SQL</li>
<li>Libraries and Ecosystem â€“ Structured Streaming and Advanced Analytics</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: center">LAYER STRUCTURE</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">Libraries &amp; Ecosystem</td>
      </tr>
      <tr>
          <td style="text-align: center">Structured API</td>
      </tr>
      <tr>
          <td style="text-align: center">Low Level API</td>
      </tr>
  </tbody>
</table>
<h2 id="how-spark-works">How Spark Works</h2>
<h3 id="1-drivers-and-executors">1. Drivers and Executors</h3>
<ul>
<li><strong>Driver</strong>: The brain of a Spark application. It translates your code into a logical execution plan and coordinates work.</li>
<li><strong>Executors</strong>: The workers. They run on cluster nodes, do the actual computation, and store data in memory/disk.</li>
</ul>
<p>Think of the <strong>Driver as a manager</strong> and <strong>Executors as employees</strong> doing the tasks.</p>
<hr>
<h3 id="2-jobs-stages-and-tasks">2. Jobs, Stages, and Tasks</h3>
<ul>
<li><strong>Job</strong>: Triggered when you call an action (like <code>.collect()</code> or <code>.save()</code>). A job = big unit of work.</li>
<li><strong>Stage</strong>: Spark splits the job into smaller parts based on shuffle boundaries (data movement points).</li>
<li><strong>Task</strong>: The smallest unit. Each stage is broken into many tasks, one per partition of data.</li>
</ul>
<p>ðŸ‘‰ Flow: <strong>Job â†’ Stages â†’ Tasks â†’ Results</strong></p>
<pre class="mermaid align-center ">  flowchart LR
    JOB[JOB]
    STAGE1[STAGE]
    STAGE2[STAGE]
    TASK1[TASK]
    TASK2[TASK]
    TASK3[TASK]
    
    JOB --&gt; STAGE1
    JOB --&gt; STAGE2
    STAGE1 --&gt; TASK1
    STAGE1 --&gt; TASK2
    STAGE2 --&gt; TASK3</pre>
<h2 id="what-is-partition">What is Partition?</h2>
<p>To allow every executor to work in parallel, Spark breaks down the data into chunks called partitions.</p>
<h2 id="what-is-transformation">What is Transformation?</h2>
<p>The <strong>instruction</strong> or <strong>code</strong> to modify and transform data is known as Transformation.</p>
<p><strong>Examples</strong>: select,where,groupBy etc.</p>
<p>Transformation helps in building the <strong>logical plan</strong>.</p>
<p>Two Types:</p>
<ul>
<li><strong>Narrow Transformation</strong></li>
<li><strong>Wide Transformation</strong></li>
</ul>
<h2 id="what-are-actions">What are Actions?</h2>
<p>To <strong>trigger the execution</strong> we need to call an <strong>Action</strong>.</p>
<p>This basically executes the plan created by Transformation.</p>
<p>Actions are of three types:</p>
<ul>
<li><strong>View data</strong> in console</li>
<li><strong>Collect data</strong> to native language</li>
<li><strong>Write data</strong> to output data sources</li>
</ul>
<h3 id="spark-prefers-lazy-evaluation">Spark prefers Lazy Evaluation</h3>
<p><strong>Transformations are lazy</strong> â†’ Spark doesnâ€™t execute them immediately; it just builds a logical plan (DAG).
<strong>Execution happens only on actions</strong> â†’ When an action (collect, count, save) is called, Spark optimizes the DAG and runs it.</p>
<h3 id="shuffle-in-spark">Shuffle in Spark</h3>
<ul>
<li><strong>When</strong>: Happens during <strong>wide transformations</strong> (<code>groupByKey</code>, <code>reduceByKey</code>, <code>join</code>, etc.).</li>
<li><strong>What</strong>: Data is <strong>redistributed across the cluster</strong> so records with the same key end up in the same partition.</li>
<li><strong>Impact</strong>: A <strong>new stage</strong> is created in the DAG because shuffle requires data movement across executors.</li>
</ul>
<blockquote>
<p>Shuffling occurs because wide transformations require <strong>related data (e.g., same keys)</strong> to be co-located in the <strong>same partition</strong>, which necessitates <strong>repartitioning</strong> and <strong>redistributing</strong> data across nodes.</p></blockquote>

<details open class=" box cstyle notices note">
  <summary class="box-label" tabindex="-1">
    <i class="fa-fw fas fa-exclamation-circle"></i> 
    Note
  </summary>
  <div class="box-content">
<p>In Spark, <strong>actions (like count, collect, saveAsTextFile) create a job and trigger its execution, wide transformations (such as groupByKey, reduceByKey, join) introduce shuffle boundaries by redistributing data across partitions, and these boundaries split the job into stages, where tasks are scheduled and executed in parallel on cluster nodes.</strong></p>
  </div>
</details>
<h2 id="what-is-spark-session">What is Spark Session?</h2>
<ul>
<li>The Driver Process is known as Spark Session.</li>
<li>It is the entry point for a Spark execution.</li>
<li>The Spark Session instance executes the code in the cluster.</li>
<li>The relation is one-to-one, i.e., for one Spark Application, there will be one Spark Session instance.</li>
</ul>
<h3 id="structured-api---dataframes">Structured API - DataFrames</h3>
<ul>
<li>DataFrame is the most common Structured API, represented like a table.</li>
<li>The table is represented in form of Rows and Columns.</li>
<li>DataFrame has schema, which is the metadata for the columns.</li>
<li>Data in DataFrames are in partitions.</li>
<li>DataFrames are immutable.</li>
</ul>

<details open class=" box cstyle notices note">
  <summary class="box-label" tabindex="-1">
    <i class="fa-fw fas fa-exclamation-circle"></i> 
    Note
  </summary>
  <div class="box-content">
<p>DataFrames are <strong>immutable</strong>, meaning every transformation creates a <strong>new DataFrame</strong> without altering the original one.</p>
  </div>
</details>
<h3 id="structured-api-execution-plan">Structured API Execution Plan</h3>
<h3 id="1-logial-planning">1. <strong>Logial Planning</strong></h3>
<p>The Spark <strong>Driver</strong> first converts your code (Transformations/Actions) into a <strong>logical plan</strong>.
Represents <strong>what</strong> needs to be done without worrying about <strong>how</strong> it will be executed.</p>
<pre class="mermaid align-center ">flowchart LR
    A[Unresolved Logical Plan] --&gt; B[Resolved Logical Plan]
    B --&gt; C[Catalyst Optimizer]
    C --&gt; D[Optimized Logical Plan]</pre>
<h3 id="2-physical-planning">2. <strong>Physical Planning</strong></h3>
<p>Spark converts the <strong>logical plan</strong> into a <strong>physical plan</strong>, deciding <strong>how</strong> to execute it (which operations run where, partitioning, joins, etc.).
Optimizes for performance (e.g., choosing sort merge join vs broadcast join).</p>
<pre class="mermaid align-center ">flowchart LR
    A[Optimized Logical Plan] --&gt; B[Multiple Physical Plans]
    B --&gt; C[Cost Optimizer]
    C --&gt; D[Best Physical Plan]
    D --&gt; E[Sent to Cluster for Execution]</pre>
<h3 id="3-dag-directed-acyclic-graph">3. DAG (Directed Acyclic Graph)</h3>
<p>Spark breaks the physical plan into a <strong>DAG of stages</strong>.
Shows <strong>dependencies between stages</strong> and ensures tasks are executed in the correct order.</p>
<p><strong>Flow</strong>: DAG â†’ Stages â†’ Tasks â†’ Execution</p>
<hr>
<h3 id="summary-flow">Summary Flow</h3>
<pre class="mermaid align-center ">flowchart LR
    A[User Code] --&gt; B[Logical Plan] --&gt; C[Physical Plan] --&gt; D[DAG of Stages] --&gt; E[Tasks executed by Executors]</pre>
<h2 id="creating-a-spark-session-in-pyspark">Creating a Spark Session in PySpark</h2>
<p>A <strong>SparkSession</strong> is the entry point to using PySpark. It allows interaction with Sparkâ€™s functionalities (DataFrame, SQL, etc.).</p>
<h3 id="example">Example</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Spark Introduction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
<ul>
<li><code>SparkSession.builder</code>: used to configure the session.</li>
<li><code>.appName(&quot;...&quot;)</code>: sets the application name.</li>
<li><code>.master(&quot;local[*]&quot;)</code>: runs Spark locally using all CPU cores.</li>
<li><code>.getOrCreate()</code>: returns an existing session or creates a new one.</li>
</ul>
<p><strong>Note</strong>:In Databricks, you donâ€™t need to create a SparkSession manually. A spark session is already available by default, so you can directly use spark.read, spark.sql, etc.</p>
<h2 id="creating-dataframes-in-pyspark">Creating DataFrames in PySpark</h2>
<h3 id="1-from-in-memory-data">1. From In-Memory Data</h3>
<p>You can create a DataFrame directly from Python objects (lists, tuples, dicts).</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&#34;Alice&#34;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="p">(</span><span class="s2">&#34;Bob&#34;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="s2">&#34;Charlie&#34;</span><span class="p">,</span> <span class="mi">35</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Name&#34;</span><span class="p">,</span> <span class="s2">&#34;Age&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h3 id="2-from-file">2. From File</h3>
<p>You can load data from CSV, JSON, Parquet, etc.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="s2">&#34;path/to/file.csv&#34;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="s2">&#34;path/to/file.json&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="01-spark-session">01 Spark Session</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Spark Introduction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check number of partitions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show data (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write our first Transformation (EMP salary &gt; 50000)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;salary &gt; 50000&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Validate number of Partitions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write data as CSV output (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/1/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<h2 id="02-basic-transformations-1">02 Basic Transformations 1</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Basic Transformation - I&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Schema for emp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">schema</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Small Example for Schema</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span>
</span></span><span class="line"><span class="cl"><span class="n">schema_string</span> <span class="o">=</span> <span class="s2">&#34;name string, age int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema_spark</span> <span class="o">=</span>  <span class="n">StructType</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">StructField</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">StructField</span><span class="p">(</span><span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Columns and expression</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="p">[</span><span class="s2">&#34;salary&#34;</span><span class="p">]</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># SELECT columns</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, age, salary from emp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_filtered</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">),</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">),</span> <span class="n">emp</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">emp</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># SHOW Dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_filtered</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Using expr for select</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id as emp_id, name, cast(age as int) as age, salary from emp_filtered</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_casted</span> <span class="o">=</span> <span class="n">emp_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&#34;employee_id as emp_id&#34;</span><span class="p">),</span> <span class="n">emp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;cast(age as int) as age&#34;</span><span class="p">),</span> <span class="n">emp</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># SHOW Dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_casted</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_casted_1</span> <span class="o">=</span> <span class="n">emp_filtered</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&#34;employee_id as emp_id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;cast(age as int) as age&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_casted_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_casted</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Filter emp based on Age &gt; 30</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select emp_id, name, age, salary from emp_casted where age &gt; 30</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">emp_casted</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;emp_id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;age &gt; 30&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># SHOW Dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data back as CSV (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/2/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema_str</span> <span class="o">=</span> <span class="s2">&#34;name string, age int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">_parse_datatype_string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema_spark</span> <span class="o">=</span> <span class="n">_parse_datatype_string</span><span class="p">(</span><span class="n">schema_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema_spark</span></span></span></code></pre></div>
<h2 id="03-basic-transformations-2">03 Basic Transformations 2</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Basic Transformation - II&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Print Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Casting Column</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, age, cast(salary as double) as salary from emp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">cast</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_casted</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;double&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_casted</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Adding Columns</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, age, salary, (salary * 0.2) as tax from emp_casted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_taxed</span> <span class="o">=</span> <span class="n">emp_casted</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;tax&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_taxed</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Literals</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, age, salary, tax, 1 as columnOne, &#39;two&#39; as columnTwo from emp_taxed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">lit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_new_cols</span> <span class="o">=</span> <span class="n">emp_taxed</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;columnOne&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;columnTwo&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_new_cols</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Renaming Columns</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id as emp_id, name, age, salary, tax, columnOne, columnTwo from emp_new_cols</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_1</span> <span class="o">=</span> <span class="n">emp_new_cols</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;emp_id&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Column names with Spaces</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id as emp_id, name, age, salary, tax, columnOne, columnTwo as `Column Two` from emp_new_cols</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_2</span> <span class="o">=</span> <span class="n">emp_new_cols</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;columnTwo&#34;</span><span class="p">,</span> <span class="s2">&#34;Column Two&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Remove Column</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_dropped</span> <span class="o">=</span> <span class="n">emp_new_cols</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;columnTwo&#34;</span><span class="p">,</span> <span class="s2">&#34;columnOne&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_dropped</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Filter data </span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id as emp_id, name, age, salary, tax, columnOne from emp_col_dropped where tax &gt; 1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_filtered</span> <span class="o">=</span> <span class="n">emp_dropped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;tax &gt; 10000&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_filtered</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># LIMIT data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id as emp_id, name, age, salary, tax, columnOne from emp_filtered limit 5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_limit</span> <span class="o">=</span> <span class="n">emp_filtered</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_limit</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Add multiple columns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;tax&#34;</span> <span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;oneNumber&#34;</span> <span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;columnTwo&#34;</span> <span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;two&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumns</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="04-string-and-dates">04 String And Dates</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Working with Strings &amp; Dates&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Print Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Case When</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, age, salary, gender,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># case when gender = &#39;Male&#39; then &#39;M&#39; when gender = &#39;Female&#39; then &#39;F&#39; else null end as new_gender, hire_date from emp</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">when</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_gender_fixed</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;new_gender&#34;</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;gender&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Male&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;gender&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Female&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">)</span>
</span></span><span class="line"><span class="cl">                            
</span></span><span class="line"><span class="cl"><span class="n">emp_gender_fixed_1</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;new_gender&#34;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;case when gender = &#39;Male&#39; then &#39;M&#39; when gender = &#39;Female&#39; then &#39;F&#39; else null end&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_gender_fixed_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Replace in Strings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select employee_id, name, replace(name, &#39;J&#39;, &#39;Z&#39;) as new_name, age, salary, gender, new_gender, hire_date from emp_gender_fixed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">regexp_replace</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_name_fixed</span> <span class="o">=</span> <span class="n">emp_gender_fixed</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;new_name&#34;</span><span class="p">,</span> <span class="n">regexp_replace</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">),</span> <span class="s2">&#34;J&#34;</span><span class="p">,</span> <span class="s2">&#34;Z&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_name_fixed</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Convert Date</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select *,  to_date(hire_date, &#39;YYYY-MM-DD&#39;) as hire_date from emp_name_fixed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_date</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_date_fix</span> <span class="o">=</span> <span class="n">emp_name_fixed</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">,</span> <span class="n">to_date</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">),</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_date_fix</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Add Date Columns</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Add current_date, current_timestamp, extract year from hire_date</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">current_date</span><span class="p">,</span> <span class="n">current_timestamp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_dated</span> <span class="o">=</span> <span class="n">emp_date_fix</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;date_now&#34;</span><span class="p">,</span> <span class="n">current_date</span><span class="p">())</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;timestamp_now&#34;</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">())</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_dated</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Drop Null gender records</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_1</span> <span class="o">=</span> <span class="n">emp_dated</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Fix Null values</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select *, nvl(&#39;new_gender&#39;, &#39;O&#39;) as new_gender from emp_dated</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">coalesce</span><span class="p">,</span> <span class="n">lit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_null_df</span> <span class="o">=</span> <span class="n">emp_dated</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;new_gender&#34;</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;new_gender&#34;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;O&#34;</span><span class="p">)))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_null_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Drop old columns and Fix new column names</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">emp_null_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;new_name&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;new_gender&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write data as CSV</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/4/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Convert date into String and extract date information</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">date_format</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_fixed</span> <span class="o">=</span> <span class="n">emp_final</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;date_year&#34;</span><span class="p">,</span> <span class="n">date_format</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp_now&#34;</span><span class="p">),</span> <span class="s2">&#34;z&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_fixed</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="05-sort-union-aggregation">05 Sort Union Aggregation</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Sort Union &amp; Aggregation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_1</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data_1</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data_2</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Print Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_1</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># UNION and UNION ALL</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select * from emp_data_1 UNION select * from emp_data_2</span>
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">emp_data_1</span><span class="o">.</span><span class="n">unionAll</span><span class="p">(</span><span class="n">emp_data_2</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Sort the emp data based on desc Salary</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select * from emp order by salary desc</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">desc</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_sorted</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_sorted</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Aggregation</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select dept_id, count(employee_id) as total_dept_count from emp_sorted group by dept_id </span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_count</span> <span class="o">=</span> <span class="n">emp_sorted</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_dept_count&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_count</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Aggregation</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select dept_id, sum(salary) as total_dept_salary from emp_sorted group by dept_id </span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">sum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_sum</span> <span class="o">=</span> <span class="n">emp_sorted</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_dept_salary&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_sum</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Aggregation with having clause</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select dept_id, avg(salary) as avg_dept_salary from emp_sorted  group by dept_id having avg(salary) &gt; 50000</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">avg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_avg</span> <span class="o">=</span> <span class="n">emp_sorted</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_dept_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;avg_dept_salary &gt; 50000&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_avg</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP - unionByName</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In case the column sequence is different</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2_other</span> <span class="o">=</span> <span class="n">emp_data_2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;hire_date&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data_1</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_data_2_other</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_fixed</span> <span class="o">=</span> <span class="n">emp_data_1</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">emp_data_2_other</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_fixed</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="06-unique-data-and-window">06 Unique Data And Window</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Unique data &amp; Window Functions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Print Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get unique data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select distinct emp.* from emp</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_unique</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_unique</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Unique of department_ids</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select distinct department_id from emp</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_dept_id</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_dept_id</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Window Functions</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select *, max(salary) over(partition by department_id order by salary desc) as max_salary from emp_unique</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">max</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">desc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">max_func</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_1</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;max_salary&#34;</span><span class="p">,</span> <span class="n">max_func</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Window Functions - 2nd highest salary of each department</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select *, row_number() over(partition by department_id order by salary desc) as rn from emp_unique where rn = 2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">row_number</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">window_spec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window_spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_2</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;rn = 2&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Window function using expr</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select *, row_number() over(partition by department_id order by salary desc) as rn from emp_unique where rn = 2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_3</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;row_number() over(partition by department_id order by salary desc)&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;rn = 2&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_3</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Databricks community cloud</span></span></span></code></pre></div>
<h2 id="07-joins-and-data-partitions">07 Joins And Data Partitions</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Joins and Data Partitions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;101&#34;</span><span class="p">,</span> <span class="s2">&#34;Sales&#34;</span><span class="p">,</span> <span class="s2">&#34;NYC&#34;</span><span class="p">,</span> <span class="s2">&#34;US&#34;</span><span class="p">,</span> <span class="s2">&#34;1000000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;102&#34;</span><span class="p">,</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">,</span> <span class="s2">&#34;LA&#34;</span><span class="p">,</span> <span class="s2">&#34;US&#34;</span><span class="p">,</span> <span class="s2">&#34;900000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;103&#34;</span><span class="p">,</span> <span class="s2">&#34;Finance&#34;</span><span class="p">,</span> <span class="s2">&#34;London&#34;</span><span class="p">,</span> <span class="s2">&#34;UK&#34;</span><span class="p">,</span> <span class="s2">&#34;1200000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;104&#34;</span><span class="p">,</span> <span class="s2">&#34;Engineering&#34;</span><span class="p">,</span> <span class="s2">&#34;Beijing&#34;</span><span class="p">,</span> <span class="s2">&#34;China&#34;</span><span class="p">,</span> <span class="s2">&#34;1500000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;105&#34;</span><span class="p">,</span> <span class="s2">&#34;Human Resources&#34;</span><span class="p">,</span> <span class="s2">&#34;Tokyo&#34;</span><span class="p">,</span> <span class="s2">&#34;Japan&#34;</span><span class="p">,</span> <span class="s2">&#34;800000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;106&#34;</span><span class="p">,</span> <span class="s2">&#34;Research and Development&#34;</span><span class="p">,</span> <span class="s2">&#34;Perth&#34;</span><span class="p">,</span> <span class="s2">&#34;Australia&#34;</span><span class="p">,</span> <span class="s2">&#34;1100000&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;107&#34;</span><span class="p">,</span> <span class="s2">&#34;Customer Service&#34;</span><span class="p">,</span> <span class="s2">&#34;Sydney&#34;</span><span class="p">,</span> <span class="s2">&#34;Australia&#34;</span><span class="p">,</span> <span class="s2">&#34;950000&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept_schema</span> <span class="o">=</span> <span class="s2">&#34;department_id string, department_name string, city string, country string, budget string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp &amp; dept DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dept</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dept_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">dept_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp dataframe (ACTION)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dept</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Print Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dept</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get number of partitions for emp</span>
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get number of partitions for dept</span>
</span></span><span class="line"><span class="cl"><span class="n">dept</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Repartition of data using repartition &amp; coalesce</span>
</span></span><span class="line"><span class="cl"><span class="n">emp_partitioned</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_partitioned</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Find the partition info for partitions and reparition</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">spark_partition_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_1</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;partition_num&#34;</span><span class="p">,</span> <span class="n">spark_partition_id</span><span class="p">())</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># INNER JOIN datasets</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select e.emp_name, d.department_name, d.department_id, e.salary </span>
</span></span><span class="line"><span class="cl"><span class="c1"># from emp e inner join dept d on emp.department_id = dept.department_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;d&#34;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;inner&#34;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;e.name&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;e.salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># LEFT OUTER JOIN datasets</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select e.emp_name, d.department_name, d.department_id, e.salary </span>
</span></span><span class="line"><span class="cl"><span class="c1"># from emp e left outer join dept d on emp.department_id = dept.department_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;d&#34;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;e.name&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;e.salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the final dataset</span>
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;e.name&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;d.department_id&#34;</span><span class="p">,</span><span class="s2">&#34;e.salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/7/emp_joined.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Joins with cascading conditions</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Join with Department_id and only for departments 101 or 102</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Join with not null/null conditions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_final</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                   <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span> <span class="o">==</span> <span class="s2">&#34;101&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span> <span class="o">==</span> <span class="s2">&#34;102&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">salary</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                   <span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="08-reading-from-csv-files">08 Reading From Csv Files</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Reading from CSV Files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read a csv file into dataframe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;inferSchema&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Reading with Schema</span>
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id int, department_id int, name string, age int, gender string, salary double, hire_date date&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_schema</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_schema</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Handle BAD records - PERMISSIVE (Default mode)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id int, department_id int, name string, age int, gender string, salary double, hire_date date, bad_record string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_p</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;columnNameOfCorruptRecord&#34;</span><span class="p">,</span> <span class="s2">&#34;bad_record&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp_new.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_p</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_p</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Handle BAD records - DROPMALFORMED</span>
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id int, department_id int, name string, age int, gender string, salary double, hire_date date&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_m</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;mode&#34;</span><span class="p">,</span> <span class="s2">&#34;DROPMALFORMED&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp_new.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_m</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_m</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Handle BAD records - FAILFAST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id int, department_id int, name string, age int, gender string, salary double, hire_date date&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_m</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;mode&#34;</span><span class="p">,</span> <span class="s2">&#34;FAILFAST&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp_new.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_m</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_m</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># BONUS TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Multiple options</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_options</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;header&#34;</span> <span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;inferSchema&#34;</span> <span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;mode&#34;</span> <span class="p">:</span> <span class="s2">&#34;PERMISSIVE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="o">**</span><span class="n">_options</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/emp.csv&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="09-reading-complex-data-formats">09 Reading Complex Data Formats</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Reading Complex Data Formats&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Parquet Sales data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_parquet</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_total_parquet/*.parquet&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_parquet</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_parquet</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read ORC Sales data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_orc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;orc&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_total_orc/*.orc&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_orc</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_orc</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Benefits of Columnar Storage</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Lets create a simple Python decorator - {get_time} to get the execution timings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you dont know about Python decorators - check out : https://www.geeksforgeeks.org/decorators-in-python/</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">inner_get_time</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Execution time: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">}</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">inner_get_time</span><span class="p">())</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@get_time</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">x</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_data.parquet&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@get_time</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">x</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_data.parquet&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;trx_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># BONUS TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># RECURSIVE READ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales_recursive</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span><span class="n">__</span> <span class="n">sales_1</span>\<span class="mf">1.</span><span class="n">parquet</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span><span class="n">__</span> <span class="n">sales_1</span>\<span class="n">sales_2</span>\<span class="mf">2.</span><span class="n">parquet</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_recursive/sales_1/1.parquet&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_recursive/sales_1/sales_2/2.parquet&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;recursiveFileLookup&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/sales_recursive/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="10-read-json-files">10 Read Json Files</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Reading and Parsing JSON Files/Data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Single line JSON file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_single</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;json&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/order_singleline.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_single</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_single</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Multiline JSON file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_multi</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;json&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;multiLine&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/order_multiline.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_multi</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_multi</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;text&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/order_singleline.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># With Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;customer_id string, order_id string, contact array&lt;long&gt;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_schema</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;json&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/order_singleline.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_schema</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">root</span>
</span></span><span class="line"><span class="cl"> <span class="o">|--</span> <span class="n">contact</span><span class="p">:</span> <span class="n">array</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>    <span class="o">|--</span> <span class="n">element</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|--</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|--</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|--</span> <span class="n">order_line_items</span><span class="p">:</span> <span class="n">array</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>    <span class="o">|--</span> <span class="n">element</span><span class="p">:</span> <span class="n">struct</span> <span class="p">(</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>    <span class="o">|</span>    <span class="o">|--</span> <span class="n">amount</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>    <span class="o">|</span>    <span class="o">|--</span> <span class="n">item_id</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>    <span class="o">|</span>    <span class="o">|--</span> <span class="n">qty</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;contact array&lt;string&gt;, customer_id string, order_id string, order_line_items array&lt;struct&lt;amount double, item_id string, qty long&gt;&gt;&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_schema_new</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;json&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/order_singleline.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_schema_new</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_schema_new</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Function from_json to read from a column</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;contact array&lt;string&gt;, customer_id string, order_id string, order_line_items array&lt;struct&lt;amount double, item_id string, qty long&gt;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">from_json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_expanded</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;parsed&#34;</span><span class="p">,</span> <span class="n">from_json</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">_schema</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_expanded</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_expanded</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Function to_json to parse a JSON string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_unparsed</span> <span class="o">=</span> <span class="n">df_expanded</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;unparsed&#34;</span><span class="p">,</span> <span class="n">to_json</span><span class="p">(</span><span class="n">df_expanded</span><span class="o">.</span><span class="n">parsed</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_unparsed</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_unparsed</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;unparsed&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get values from Parsed JSON</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_1</span> <span class="o">=</span> <span class="n">df_expanded</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;parsed.*&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">explode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_2</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;expanded_line_items&#34;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="s2">&#34;order_line_items&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_3</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;contact&#34;</span><span class="p">,</span> <span class="s2">&#34;customer_id&#34;</span><span class="p">,</span> <span class="s2">&#34;order_id&#34;</span><span class="p">,</span> <span class="s2">&#34;expanded_line_items.*&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_3</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Explode Array fields</span>
</span></span><span class="line"><span class="cl"><span class="n">df_final</span> <span class="o">=</span> <span class="n">df_3</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;contact_expanded&#34;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="s2">&#34;contact&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_final</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;contact&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="11-writing-data">11 Writing Data</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Writing data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark available cores with defaultParallism in Spark UI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">defaultParallelism</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Emp Data &amp; Schema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;001&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;John Doe&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;002&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;Jane Smith&#34;</span><span class="p">,</span><span class="s2">&#34;25&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;45000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;003&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Bob Brown&#34;</span><span class="p">,</span><span class="s2">&#34;35&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;55000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-05-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;004&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Alice Lee&#34;</span><span class="p">,</span><span class="s2">&#34;28&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;48000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;005&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jack Chan&#34;</span><span class="p">,</span><span class="s2">&#34;40&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;60000&#34;</span><span class="p">,</span><span class="s2">&#34;2013-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;006&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Jill Wong&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;52000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;007&#34;</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">,</span><span class="s2">&#34;James Johnson&#34;</span><span class="p">,</span><span class="s2">&#34;42&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;70000&#34;</span><span class="p">,</span><span class="s2">&#34;2012-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;008&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Kate Kim&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;51000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-10-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;009&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Tom Tan&#34;</span><span class="p">,</span><span class="s2">&#34;33&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;58000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;010&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Lisa Lee&#34;</span><span class="p">,</span><span class="s2">&#34;27&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;47000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;011&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;David Park&#34;</span><span class="p">,</span><span class="s2">&#34;38&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;65000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-11-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;012&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;Susan Chen&#34;</span><span class="p">,</span><span class="s2">&#34;31&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;54000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-02-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;013&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Brian Kim&#34;</span><span class="p">,</span><span class="s2">&#34;45&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;75000&#34;</span><span class="p">,</span><span class="s2">&#34;2011-07-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;014&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Emily Lee&#34;</span><span class="p">,</span><span class="s2">&#34;26&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;46000&#34;</span><span class="p">,</span><span class="s2">&#34;2019-01-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;015&#34;</span><span class="p">,</span><span class="s2">&#34;106&#34;</span><span class="p">,</span><span class="s2">&#34;Michael Lee&#34;</span><span class="p">,</span><span class="s2">&#34;37&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;63000&#34;</span><span class="p">,</span><span class="s2">&#34;2014-09-30&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;016&#34;</span><span class="p">,</span><span class="s2">&#34;107&#34;</span><span class="p">,</span><span class="s2">&#34;Kelly Zhang&#34;</span><span class="p">,</span><span class="s2">&#34;30&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;49000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-04-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;017&#34;</span><span class="p">,</span><span class="s2">&#34;105&#34;</span><span class="p">,</span><span class="s2">&#34;George Wang&#34;</span><span class="p">,</span><span class="s2">&#34;34&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;57000&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-15&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;018&#34;</span><span class="p">,</span><span class="s2">&#34;104&#34;</span><span class="p">,</span><span class="s2">&#34;Nancy Liu&#34;</span><span class="p">,</span><span class="s2">&#34;29&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;50000&#34;</span><span class="p">,</span><span class="s2">&#34;2017-06-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;019&#34;</span><span class="p">,</span><span class="s2">&#34;103&#34;</span><span class="p">,</span><span class="s2">&#34;Steven Chen&#34;</span><span class="p">,</span><span class="s2">&#34;36&#34;</span><span class="p">,</span><span class="s2">&#34;Male&#34;</span><span class="p">,</span><span class="s2">&#34;62000&#34;</span><span class="p">,</span><span class="s2">&#34;2015-08-01&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s2">&#34;020&#34;</span><span class="p">,</span><span class="s2">&#34;102&#34;</span><span class="p">,</span><span class="s2">&#34;Grace Kim&#34;</span><span class="p">,</span><span class="s2">&#34;32&#34;</span><span class="p">,</span><span class="s2">&#34;Female&#34;</span><span class="p">,</span><span class="s2">&#34;53000&#34;</span><span class="p">,</span><span class="s2">&#34;2018-11-01&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create emp DataFrame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">emp_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">emp_schema</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get number of partitions and show data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data in parquet format</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/11/2/emp.parquet&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View data partition information</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">spark_partition_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;partition_id&#34;</span><span class="p">,</span> <span class="n">spark_partition_id</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/11/3/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data with Partition to output location</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/11/4/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write Modes - append, overwrite, ignore and error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;error&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/11/3/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Bonus TIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># What if we need to write only 1 output file to share with DownStream?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;data/output/11/5/emp.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<h2 id="12-understand-cluster">12 Understand Cluster</h2>
<h6 id="to-setup-pyspark-cluster-with-2-worker-1-master-and-1-history-server">To setup PySpark Cluster with 2 worker, 1 master and 1 history server</h6>
<p>Follow the below instructions carefully ðŸ‘‡ðŸ»</p>
<ul>
<li>Clone or Download the docker images repository from <code>https://github.com/subhamkharwal/docker-images</code></li>
<li>Open CMD prompt (on Windows) or Terminal (on Mac) and move the cloned/downloaded folder</li>
<li>Change to folder <code>pyspark-cluster-with-jupyter</code> and run command <code>docker compose up</code></li>
<li>The above command would setup a group of containers with 1 Jupyter Lab, 1 Master node, 2 worker nodes and 1 history server</li>
<li>Run all the containers, go into the logs of Jupyter Lab container in Docker Desktop and copy the token from the URL which looks like <code>http://127.0.0.1:8888/lab?token=c23436751add815d6fce10071c3958aac7b4f8ebbcf05255</code></li>
<li>Open Jupyter Lab on url <code>https://localhost:8888</code>, paste the token and setup a new password.</li>
<li>[IMPORTANT] Make sure to place your file to read or write your files to location <code>/data/&lt;your path&gt;</code> in order to work with cluster. (/data is important, this path is mounted across the cluster to access files or data)</li>
<li>To see all your data files after execution, run the below command</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">%%sh
</span></span><span class="line"><span class="cl">ls -ltr /data/</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Cluster Execution&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://17e348267994:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.instances&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create a sample data frame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data of the data frame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;/data/output/15/3/range.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Stop Spark Settion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="understand-cluster-python">Understand Cluster (Python)</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">##### To setup PySpark Cluster with 2 worker, 1 master and 1 history server
</span></span></span><span class="line"><span class="cl"><span class="s1">Follow the below instructions carefully ðŸ‘‡ðŸ»
</span></span></span><span class="line"><span class="cl"><span class="s1">- Clone or Download the docker images repository from `https://github.com/subhamkharwal/docker-images`
</span></span></span><span class="line"><span class="cl"><span class="s1">- Open CMD prompt (on Windows) or Terminal (on Mac) and move the cloned/downloaded folder
</span></span></span><span class="line"><span class="cl"><span class="s1">- Change to folder `pyspark-cluster-with-jupyter` and run command `docker compose up`
</span></span></span><span class="line"><span class="cl"><span class="s1">- The above command would setup a group of containers with 1 Jupyter Lab, 1 Master node, 2 worker nodes and 1 history server
</span></span></span><span class="line"><span class="cl"><span class="s1">- Run all the containers, go into the logs of Jupyter Lab container in Docker Desktop and copy the token from the URL which looks like `http://127.0.0.1:8888/lab?token=c23436751add815d6fce10071c3958aac7b4f8ebbcf05255`
</span></span></span><span class="line"><span class="cl"><span class="s1">- Open Jupyter Lab on url `https://localhost:8888`, paste the token and setup a new password.
</span></span></span><span class="line"><span class="cl"><span class="s1">- [IMPORTANT] Make sure to place your file to read or write your files to location `/data/&lt;your path&gt;` in order to work with cluster. (/data is important, this path is mounted across the cluster to access files or data)
</span></span></span><span class="line"><span class="cl"><span class="s1">- To see all your data files after execution, run the below command
</span></span></span><span class="line"><span class="cl"><span class="s1">```shell
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">%%</span><span class="s1">sh
</span></span></span><span class="line"><span class="cl"><span class="s1">ls -ltr /data/</span></span></span></code></pre></div>
<p>&rsquo;''</p>
<h1 id="spark-session">Spark Session</h1>
<p>from pyspark.sql import SparkSession</p>
<p>spark = (
SparkSession
.builder
.appName(&ldquo;Cluster Execution&rdquo;)
.getOrCreate()
)</p>
<p>df = spark.range(10)</p>
<p>df.write.format(&ldquo;csv&rdquo;).option(&ldquo;header&rdquo;, True).save(&quot;/data/output/15/6/range.csv&quot;)</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>## 13 User Defined Functions

```python
# Spark Session
from pyspark.sql import SparkSession

spark = (
    SparkSession
    .builder
    .appName(&#34;User Defined Functions&#34;)
    .master(&#34;spark://17e348267994:7077&#34;)
    .config(&#34;spark.executor.cores&#34;, 2)
    .config(&#34;spark.cores.max&#34;, 6)
    .config(&#34;spark.executor.memory&#34;, &#34;512M&#34;)
    .getOrCreate()
)

spark</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read employee data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_schema</span> <span class="o">=</span> <span class="s2">&#34;employee_id string, department_id string, name string, age string, gender string, salary string, hire_date string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">emp_schema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/output/3/emp.csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create a function to generate 10% of Salary as Bonus</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bonus</span><span class="p">(</span><span class="n">salary</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Register as UDF</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bonus_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">bonus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&#34;bonus_sql_udf&#34;</span><span class="p">,</span> <span class="n">bonus</span><span class="p">,</span> <span class="s2">&#34;double&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create new column as bonus using UDF</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;bonus_sql_udf(salary)&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create new column as bonus without UDF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&#34;salary * 0.1&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Stop Spark Session</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="14-understand-dag-plan">14 Understand Dag Plan</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Understand Plans and DAG&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check default Parallism</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">defaultParallelism</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create dataframes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_2</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Re-partition data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_3</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_4</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_4</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join the dataframes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">df_3</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_4</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Get the sum of ids</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_sum</span> <span class="o">=</span> <span class="n">df_joined</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&#34;sum(id) as total_sum&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View data</span>
</span></span><span class="line"><span class="cl"><span class="n">df_sum</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Explain plan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_sum</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Union the data again to see the skipped stages</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_union</span> <span class="o">=</span> <span class="n">df_sum</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df_4</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_union</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Explain plan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_union</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># DataFrame to RDD</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_1</span><span class="o">.</span><span class="n">rdd</span></span></span></code></pre></div>
<h2 id="15-optimizing-shuffles">15 Optimizing Shuffles</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Optimizing Shuffles&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://17e348267994:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check Spark defaultParallelism</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">defaultParallelism</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read EMP CSV file with 10M records</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/employee_records.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Find out avg salary as per dept</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">avg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_avg</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_sal&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write data for performance Benchmarking</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_avg</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check Spark Shuffle Partition setting</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;spark.sql.shuffle.partitions&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.shuffle.partitions&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">spark_partition_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;partition_id&#34;</span><span class="p">,</span> <span class="n">spark_partition_id</span><span class="p">())</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;partition_id = 0&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read the partitioned data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_part</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/emp_partitioned.csv/&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_avg</span> <span class="o">=</span> <span class="n">emp_part</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_sal&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_avg</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="16-spark-caching-techiniques">16 Spark Caching Techiniques</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Understand Caching&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Sales CSV Data - 752MB Size ~ 7.2M Records</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;transacted_at string, trx_id string, retailer_id string, description string, amount double, city_id string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;data/input/new_sales.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;amount &gt; 300&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Cache DataFrame (cache or persist)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_cache</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;amount &gt; 100&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_cache</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;amount &gt; 50&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># MEMORY_ONLY, MEMORY_AND_DISK, MEMORY_ONLY_SER, MEMORY_AND_DISK_SER, DISK_ONLY, MEMORY_ONLY_2, MEMORY_AND_DISK_2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pyspark</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_persist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">pyspark</span><span class="o">.</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">MEMORY_ONLY_2</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_persist</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Remove Cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="17-distributed-shared-variables">17 Distributed Shared Variables</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Distributed Shared Variables&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://17e348267994:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read EMP CSV data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/employee_records.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Variable (Lookup)</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;Department 1&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Department 2&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">3</span> <span class="p">:</span> <span class="s1">&#39;Department 3&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">4</span> <span class="p">:</span> <span class="s1">&#39;Department 4&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="mi">5</span> <span class="p">:</span> <span class="s1">&#39;Department 5&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">6</span> <span class="p">:</span> <span class="s1">&#39;Department 6&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">7</span> <span class="p">:</span> <span class="s1">&#39;Department 7&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">8</span> <span class="p">:</span> <span class="s1">&#39;Department 8&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">9</span> <span class="p">:</span> <span class="s1">&#39;Department 9&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">              <span class="mi">10</span> <span class="p">:</span> <span class="s1">&#39;Department 10&#39;</span><span class="p">}</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Broadcast the variable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">broadcast_dept_names</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">dept_names</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check the value of the variable</span>
</span></span><span class="line"><span class="cl"><span class="n">broadcast_dept_names</span><span class="o">.</span><span class="n">value</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create UDF to return Department name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span><span class="p">,</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@udf</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_dept_names</span><span class="p">(</span><span class="n">dept_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">broadcast_dept_names</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dept_id</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;dept_name&#34;</span><span class="p">,</span> <span class="n">get_dept_names</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Calculate total salary of Department 6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">sum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;department_id = 6&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Accumulators</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept_sal</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">accumulator</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use foreach</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_salary</span><span class="p">(</span><span class="n">department_id</span><span class="p">,</span> <span class="n">salary</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">department_id</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dept_sal</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="n">calculate_salary</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">salary</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View total value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept_sal</span><span class="o">.</span><span class="n">value</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Stop Spark Session</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="18-optimizing-joins">18 Optimizing Joins</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Optimizing Joins&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://17e348267994:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<h5 id="join-big-and-small-table---sortmerge-vs-broadcast-join">Join Big and Small table - SortMerge vs BroadCast Join</h5>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read EMP CSV data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/employee_records.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read DEPT CSV data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_dept_schema</span> <span class="o">=</span> <span class="s2">&#34;department_id int, department_name string, description string, city string, state string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_dept_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/department_data.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Datasets</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">broadcast</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">dept</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<h5 id="join-big-and-big-table---sortmerge-without-buckets">Join Big and Big table - SortMerge without Buckets</h5>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Sales data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales_schema</span> <span class="o">=</span> <span class="s2">&#34;transacted_at string, trx_id string, retailer_id string, description string, amount double, city_id string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">sales_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/new_sales.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read City data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city_schema</span> <span class="o">=</span> <span class="s2">&#34;city_id string, city string, state string, state_abv string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">city_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/datasets/cities.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_sales_joined</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">sales</span><span class="o">.</span><span class="n">city_id</span><span class="o">==</span><span class="n">city</span><span class="o">.</span><span class="n">city_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_sales_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Explain Plan</span></span></span></code></pre></div>
<h6 id="write-sales-and-city-data-in-buckets">Write Sales and City data in Buckets</h6>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write Sales data in Buckets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;city_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/input/datasets/sales_bucket.csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;sales_bucket&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write City data in Buckets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;city_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/input/datasets/city_bucket.csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;city_bucket&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check tables</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;show tables in default&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h5 id="join-sales-and-city-data---sortmerge-with-bucket">Join Sales and City data - SortMerge with Bucket</h5>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Sales table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales_bucket</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&#34;sales_bucket&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read City table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city_bucket</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&#34;city_bucket&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join datasets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined_bucket</span> <span class="o">=</span> <span class="n">sales_bucket</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city_bucket</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">sales_bucket</span><span class="o">.</span><span class="n">city_id</span><span class="o">==</span><span class="n">city_bucket</span><span class="o">.</span><span class="n">city_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write dataset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined_bucket</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined_bucket</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View how tasks are reading Bucket data</span></span></span></code></pre></div>
<h5 id="points-to-note">Points to note</h5>
<h2 id="19-dynamic-allocation">19 Dynamic Allocation</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Dynamic Allocation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://197e20b418a6:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.enabled&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.minExecutors&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.maxExecutors&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.initialExecutors&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.shuffleTracking.enabled&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.executorIdleTimeout&#34;</span><span class="p">,</span> <span class="s2">&#34;60s&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.dynamicAllocation.cachedExecutorIdleTimeout&#34;</span><span class="p">,</span> <span class="s2">&#34;60s&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Sales data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales_schema</span> <span class="o">=</span> <span class="s2">&#34;transacted_at string, trx_id string, retailer_id string, description string, amount double, city_id string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sales</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">sales_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/new_sales.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read City data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city_schema</span> <span class="o">=</span> <span class="s2">&#34;city_id string, city string, state string, state_abv string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">city</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">city_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/cities.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_sales_joined</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">sales</span><span class="o">.</span><span class="n">city_id</span><span class="o">==</span><span class="n">city</span><span class="o">.</span><span class="n">city_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_sales_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Difference between Scale UP in Databricks and Dynamic Allocation</span></span></span></code></pre></div>
<h2 id="20-skewness-and-spillage">20 Skewness And Spillage</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Optimizing Skewness and Spillage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://197e20b418a6:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Employee data</span>
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/employee_records_skewed.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read DEPT CSV data</span>
</span></span><span class="line"><span class="cl"><span class="n">_dept_schema</span> <span class="o">=</span> <span class="s2">&#34;department_id int, department_name string, description string, city string, state string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_dept_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/department_data.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Datasets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#Explain Plan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check the partition details to understand distribution</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">spark_partition_id</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">lit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">part_df</span> <span class="o">=</span> <span class="n">df_joined</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;partition_num&#34;</span><span class="p">,</span> <span class="n">spark_partition_id</span><span class="p">())</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;partition_num&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">part_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Verify Employee data based on department_id</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Set shuffle partitions to a lesser number - 16</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.shuffle.partitions&#34;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Let prepare the salt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UDF to return a random number every time and add to Employee as salt</span>
</span></span><span class="line"><span class="cl"><span class="nd">@udf</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">salt_udf</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Salt Data Frame to add to department</span>
</span></span><span class="line"><span class="cl"><span class="n">salt_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">salt_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Salted Employee</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">lit</span><span class="p">,</span> <span class="n">concat</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">salted_emp</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;salted_dept_id&#34;</span><span class="p">,</span> <span class="n">concat</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">),</span> <span class="n">salt_udf</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">salted_emp</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>                                                     </span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Salted Department</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">salted_dept</span> <span class="o">=</span> <span class="n">dept</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">salt_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;cross&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;salted_dept_id&#34;</span><span class="p">,</span> <span class="n">concat</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">),</span> <span class="s2">&#34;id&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">salted_dept</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;department_id = 9&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Lets make the salted join now</span>
</span></span><span class="line"><span class="cl"><span class="n">salted_joined_df</span> <span class="o">=</span> <span class="n">salted_emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">salted_dept</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">salted_emp</span><span class="o">.</span><span class="n">salted_dept_id</span><span class="o">==</span><span class="n">salted_dept</span><span class="o">.</span><span class="n">salted_dept_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">salted_joined_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check the partition details to understand distribution</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">spark_partition_id</span><span class="p">,</span> <span class="n">count</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">part_df</span> <span class="o">=</span> <span class="n">salted_joined_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;partition_num&#34;</span><span class="p">,</span> <span class="n">spark_partition_id</span><span class="p">())</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;partition_num&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">part_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="21-aqe-spark">21 Aqe Spark</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;AQE in Spark&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://197e20b418a6:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Employee data</span>
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/employee_records_skewed.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read DEPT CSV data</span>
</span></span><span class="line"><span class="cl"><span class="n">_dept_schema</span> <span class="o">=</span> <span class="s2">&#34;department_id int, department_name string, description string, city string, state string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_dept_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/department_data.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Datasets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#Explain Plan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Coalescing post-shuffle partitions - remove un-necessary shuffle partitions</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Skewed join optimization (balance partitions size) - join smaller partitions and split bigger partition</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Fix partition sizes to avoid Skew</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.advisoryPartitionSizeInBytes&#34;</span><span class="p">,</span> <span class="s2">&#34;8MB&#34;</span><span class="p">)</span> <span class="c1">#Default value: 64MB</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes&#34;</span><span class="p">,</span> <span class="s2">&#34;10MB&#34;</span><span class="p">)</span> <span class="c1">#Default value: 256MB</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Converting sort-merge join to broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="s2">&#34;10MB&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join Datasets - without specifying specific broadcast table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_joined</span> <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">department_id</span><span class="o">==</span><span class="n">dept</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;left_outer&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_joined</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;noop&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="22-spark-sql">22 Spark Sql</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Spark SQL&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;local[*]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">enableHiveSupport</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.sql.warehouse.dir&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/output/spark-warehouse&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Employee data</span>
</span></span><span class="line"><span class="cl"><span class="n">_schema</span> <span class="o">=</span> <span class="s2">&#34;first_name string, last_name string, job_title string, dob string, email string, phone string, salary double, department_id int&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/employee_records_skewed.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read DEPT CSV data</span>
</span></span><span class="line"><span class="cl"><span class="n">_dept_schema</span> <span class="o">=</span> <span class="s2">&#34;department_id int, department_name string, description string, city string, state string, country string&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">_dept_schema</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/department_data.csv&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Catalog (Metadata) - in-memory/hive</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;spark.sql.catalogImplementation&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show databases</span>
</span></span><span class="line"><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;show databases&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">db</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;show tables in default&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Register dataframes are temp views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&#34;emp_view&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dept</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&#34;dept_view&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show tables/view in catalog</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View data from table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_filtered</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select * from emp_view
</span></span></span><span class="line"><span class="cl"><span class="s2">    where department_id = 1
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_filtered</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create a new column dob_year and register as temp view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select e.*, date_format(dob, &#39;yyyy&#39;) as dob_year from emp_view e
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_temp</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&#34;emp_temp_view&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;select * from emp_temp_view&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Join emp and dept - HINTs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    select /*+ BROADCAST(d) */
</span></span></span><span class="line"><span class="cl"><span class="s2">    e.* , d.department_name
</span></span></span><span class="line"><span class="cl"><span class="s2">    from emp_view e left outer join dept_view d
</span></span></span><span class="line"><span class="cl"><span class="s2">    on e.department_id = d.department_id
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show emp data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data as Table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_final</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;emp_final&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read the data from Table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emp_new</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;select * from emp_final&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_new</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Persist metadata</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Show details of metadata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;describe extended emp_final&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<h2 id="23-delta-lake">23 Delta Lake</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Default Catalog for Databricks</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;spark.sql.catalogImplementation&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span> <span class="n">databases</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read Sales parquet data</span>
</span></span><span class="line"><span class="cl"><span class="n">df_sales</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&#34;/data/input/sales_data.parquet&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View data</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">df_sales</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write data as hive table</span>
</span></span><span class="line"><span class="cl"><span class="n">df_sales</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/output/sales_parquet_1/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;sales_parquet&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View files</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_parquet_1/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span> <span class="n">tables</span> <span class="ow">in</span> <span class="n">default</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">describe</span> <span class="n">extended</span> <span class="n">sales_parquet</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">update</span> <span class="n">default</span><span class="o">.</span><span class="n">sales_parquet</span> <span class="nb">set</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">where</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="s1">&#39;1734117021&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write Sales data as Delta Table</span>
</span></span><span class="line"><span class="cl"><span class="n">df_sales</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;delta&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/output/sales_delta_1/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;sales_delta&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span> <span class="n">tables</span> <span class="ow">in</span> <span class="n">default</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">describe</span> <span class="n">extended</span> <span class="n">sales_delta</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View files for delta</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_delta_1/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_delta_1/_delta_log/00000000000000000001.json&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">describe</span> <span class="n">history</span> <span class="n">sales_delta</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">update</span> <span class="n">default</span><span class="o">.</span><span class="n">sales_delta</span> <span class="nb">set</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">where</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="s1">&#39;1734117021&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">default.sales_delta</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read a particular version - pyspark api</span>
</span></span><span class="line"><span class="cl"><span class="n">df_sales_delta</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&#34;sales_delta@v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">df_sales_delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;trx_id = &#39;1734117021&#39;&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">sales_delta</span><span class="nd">@v0</span> <span class="n">where</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="s1">&#39;1734117021&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_new</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;select *, current_timestamp() as time_now from sales_delta@v0 where trx_id = &#39;1734117021&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Append data to existing delta table</span>
</span></span><span class="line"><span class="cl"><span class="n">df_new</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;delta&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;append&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;mergeSchema&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/output/sales_delta_1/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;sales_delta&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># View data</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Reading Delta Table using Delta libraries</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">delta</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&#34;sales_delta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">history</span><span class="p">())</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Converting a Parquet to Delta - Check and Convert</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DeltaTable</span><span class="o">.</span><span class="n">isDeltaTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&#34;/data/output/sales_delta_1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DeltaTable</span><span class="o">.</span><span class="n">convertToDelta</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&#34;parquet.`/data/output/sales_parquet_1`&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Validate</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_parquet_1&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">describe</span> <span class="n">extended</span> <span class="n">sales_parquet</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CONVERT</span> <span class="n">TO</span> <span class="n">DELTA</span> <span class="n">sales_parquet</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">RESTORE</span> <span class="n">TABLE</span> <span class="n">sales_delta</span> <span class="n">TO</span> <span class="n">VERSION</span> <span class="n">AS</span> <span class="n">OF</span> <span class="mi">1</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">sales_delta</span> <span class="n">where</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="s1">&#39;1734117021&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.databricks.delta.retentionDurationCheck.enabled&#34;</span><span class="p">,</span><span class="s2">&#34;false&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&#34;sales_delta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dt</span><span class="o">.</span><span class="n">vacuum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_delta_1&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">sales_delta</span><span class="nd">@v0</span> <span class="n">where</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="s1">&#39;1734117021&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Converting back to Parquet</span></span></span></code></pre></div>
<h2 id="24-data-scanning-and-partitioning">24 Data Scanning And Partitioning</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Demo dataset from Databricks</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/databricks-datasets/nyctaxi/tables/nyctaxi_yellow/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/input/nyctaxi/parquet/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check the count and verify data scanning</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data copied at location - &#34;/data/input/nyctaxi/parquet/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">df_parquet</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&#34;/data/input/nyctaxi/parquet/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">df_parquet</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Check filter data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># select count(1) from nyctaxi where vendor_id = &#39;VTS&#39; and trip_distance &gt; 1.8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_parquet</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;vendor_id = &#39;VTS&#39; and trip_distance &gt; 1.8&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data in partitioned format</span>
</span></span><span class="line"><span class="cl"><span class="n">df_parquet</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&#34;vendor_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/input/nyctaxi/partitioned/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;nyctaxi_partitioned&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/input/nyctaxi/partitioned/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df_partitioned</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&#34;/data/input/nyctaxi/partitioned/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df_partitioned</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34;vendor_id = &#39;VTS&#39; and trip_distance &gt; 1.8&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">nyctaxi_partitioned</span> <span class="n">where</span> <span class="n">vendor_id</span> <span class="o">=</span> <span class="s1">&#39;VTS&#39;</span> <span class="ow">and</span> <span class="n">trip_distance</span> <span class="o">&gt;</span> <span class="mf">1.8</span></span></span></code></pre></div>
<h2 id="25-delta-lake-optimization-and-z-ordering">25 Delta Lake Optimization And Z Ordering</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Dataset</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/databricks-datasets/definitive-guide/data/retail-data/all/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">fs</span> <span class="n">head</span> <span class="n">dbfs</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">sales</span><span class="o">/</span><span class="n">sales</span><span class="o">.</span><span class="n">csv</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write the data in form of delta table</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&#34;/data/input/sales/sales.csv&#34;</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;delta&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&#34;country&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="s2">&#34;/data/output/sales_delta_partitioned/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;sales_delta_partitioned&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">sales_delta</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Data at delta location</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_delta/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&#34;/data/output/sales_delta_partitioned/Country=Australia/&#34;</span><span class="p">))</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">sales_delta_partitioned</span> <span class="n">where</span> <span class="n">InvoiceNo</span> <span class="o">=</span> <span class="s1">&#39;576394&#39;</span> <span class="ow">and</span> <span class="n">country</span> <span class="o">=</span> <span class="s1">&#39;Australia&#39;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span> <span class="kn">from</span> <span class="nn">sales_delta</span>
</span></span><span class="line"><span class="cl"><span class="n">group</span> <span class="n">by</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span> <span class="n">by</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.databricks.delta.optimize.maxFileSize&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl"><span class="n">OPTIMIZE</span> <span class="n">sales_delta_partitioned</span> <span class="n">where</span> <span class="n">country</span> <span class="o">=</span> <span class="s1">&#39;Australia&#39;</span> <span class="n">ZORDER</span> <span class="n">BY</span> <span class="p">(</span><span class="n">InvoiceNo</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span> <span class="kn">from</span> <span class="nn">sales_delta</span>
</span></span><span class="line"><span class="cl"><span class="n">group</span> <span class="n">by</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span> <span class="n">by</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">select</span> <span class="n">country</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">),</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span> <span class="kn">from</span> <span class="nn">sales_delta</span>
</span></span><span class="line"><span class="cl"><span class="n">group</span> <span class="n">by</span> <span class="n">country</span><span class="p">,</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">file_name</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span> <span class="n">by</span> <span class="n">country</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">invoiceno</span><span class="p">)</span></span></span></code></pre></div>
<h2 id="26-run-concurrent-tasks">26 Run Concurrent Tasks</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Run Concurrent/Parallel task in Spark&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://197e20b418a6:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_country_data</span><span class="p">(</span><span class="n">_country</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Read Cities data</span>
</span></span><span class="line"><span class="cl">        <span class="n">df_cities</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">spark</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">read</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;/data/input/cities.csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Fiter data</span>
</span></span><span class="line"><span class="cl">        <span class="n">df_final</span> <span class="o">=</span> <span class="n">df_cities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;lower(country) = lower(&#39;</span><span class="si">{</span><span class="n">_country</span><span class="si">}</span><span class="s2">&#39;)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Write data</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">df_final</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">write</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;overwrite&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;/data/output/countries/</span><span class="si">{</span><span class="n">_country</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Data Extracted for </span><span class="si">{</span><span class="n">_country</span><span class="si">}</span><span class="s2"> at: [/data/output/countries/</span><span class="si">{</span><span class="n">_country</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use For loops to execute the jobs</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set start time</span>
</span></span><span class="line"><span class="cl"><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run all extracts through for-loop</span>
</span></span><span class="line"><span class="cl"><span class="n">_countries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;India&#39;</span><span class="p">,</span> <span class="s1">&#39;Iran&#39;</span><span class="p">,</span> <span class="s1">&#39;Ghana&#39;</span><span class="p">,</span> <span class="s1">&#39;Australia&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_country</span> <span class="ow">in</span> <span class="n">_countries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">extract_country_data</span><span class="p">(</span><span class="n">_country</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># End time</span>
</span></span><span class="line"><span class="cl"><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Total time taken</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;total time = </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds&#34;</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use threads to run the queries in concurrently/parallely</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">concurrent.futures</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set start time</span>
</span></span><span class="line"><span class="cl"><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_countries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;India&#39;</span><span class="p">,</span> <span class="s1">&#39;Iran&#39;</span><span class="p">,</span> <span class="s1">&#39;Ghana&#39;</span><span class="p">,</span> <span class="s1">&#39;Australia&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">extract_country_data</span><span class="p">,</span> <span class="n">_country</span><span class="p">)</span> <span class="k">for</span> <span class="n">_country</span> <span class="ow">in</span> <span class="n">_countries</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="c1"># End time</span>
</span></span><span class="line"><span class="cl"><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Total time taken</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;total time = </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds&#34;</span><span class="p">)</span></span></span></code></pre></div>
<h2 id="27-spark-memory-and-oom">27 Spark Memory And Oom</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Spark Session</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">builder</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&#34;Spark Memory Management&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&#34;spark://b7db50cd9f83:7077&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.cores.max&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.cores&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&#34;spark.executor.memory&#34;</span><span class="p">,</span> <span class="s2">&#34;512MB&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span></span></span></code></pre></div>
<p><strong>Spark Memory Calculation Per Executor</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># JVM On-Heap Usable memory (89% of executor memory)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Subtracting Reserve Memory (300MB)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Total Spark Memory (Unified Memory - Storage + Execution Memory) (60% default) spark.memory.fraction = 0.6</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># User / Undefined Memory (Not controlled by Spark) (remaining 40% default)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Storage Memory (spark.memory.storageFraction = 0.5)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Execution Memory </span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Execution Memory per core</span></span></span></code></pre></div>
<p><strong>Out Of Memory Error Demo on Executors</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Disable AQE and Broadcast join</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.adaptive.coalescePartitions.enabled&#34;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;spark.sql.autoBroadcastJoinThreshold&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">sh</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span> <span class="o">-</span><span class="n">ltrh</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">datasets</span><span class="o">/</span><span class="n">oom_example</span><span class="o">/</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Read file</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Cache data</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Explode data to count words</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Write with noop format for simulation</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<head>
  <style>
    #R-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: auto;
    }

    #R-logo img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }

    #R-logo img:hover {
      transform: scale(1.05);
    }

    #R-logo .logo-title {
  margin-left: 0.5rem;   
  font-size: 1.2rem;     
  line-height: 1;        
  display: flex;
  align-items: center;   
}
  </style>
</head>



<a id="R-logo" class="R-default" href="/">
  <img src="/images/logo.png" alt="brand logo">
  <span class="logo-title">Relearn</span>
</a>
        </div>
        <search><form action="/search/" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/sql/"><input type="checkbox" id="R-section-6b91b02647756f9b5e29b003bccc4db0" aria-controls="R-subsections-6b91b02647756f9b5e29b003bccc4db0"><label for="R-section-6b91b02647756f9b5e29b003bccc4db0"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu SQL</span></label><a class="padding" href="/sql/">SQL<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-6b91b02647756f9b5e29b003bccc4db0" class="collapsible-menu">
            <li class="" data-nav-id="/sql/select/"><a class="padding" href="/sql/select/">SELECT Query<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/ddl/"><a class="padding" href="/sql/ddl/">DDL<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/dml/"><a class="padding" href="/sql/dml/">DML<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/filter/"><a class="padding" href="/sql/filter/">Filtering Data<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/joins/"><a class="padding" href="/sql/joins/">Joins<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/set-operations/"><a class="padding" href="/sql/set-operations/">Set Operations<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/string-functions/"><a class="padding" href="/sql/string-functions/">String Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/number-functions/"><a class="padding" href="/sql/number-functions/">Number Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/date-time1/"><a class="padding" href="/sql/date-time1/">Date &amp; Time Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/date-time2/"><a class="padding" href="/sql/date-time2/">Date &amp; Time Formats<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/null-functions/"><a class="padding" href="/sql/null-functions/">NULL Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/case-statement/"><a class="padding" href="/sql/case-statement/">CASE Statement<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/aggregate-functions/"><a class="padding" href="/sql/aggregate-functions/">Aggregate Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-functions/"><a class="padding" href="/sql/window-functions/">Window Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window_aggregations/"><a class="padding" href="/sql/window_aggregations/">Window Aggregate Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-ranking/"><a class="padding" href="/sql/window-ranking/">Window Ranking Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/window-value-functions/"><a class="padding" href="/sql/window-value-functions/">Window Value Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/subqueries/"><a class="padding" href="/sql/subqueries/">Subquery Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/cte/"><a class="padding" href="/sql/cte/">Common Table Expressions (CTEs)<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/views/"><a class="padding" href="/sql/views/">Views<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/temporary-tables/"><a class="padding" href="/sql/temporary-tables/">Temporary Tables<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/stored-procedures/"><a class="padding" href="/sql/stored-procedures/">Stored Procedures<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/triggers/"><a class="padding" href="/sql/triggers/">Triggers<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/indexes/"><a class="padding" href="/sql/indexes/">Indexes<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/partitions/"><a class="padding" href="/sql/partitions/">Partitioning<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/performance-optimization/"><a class="padding" href="/sql/performance-optimization/">Performance Tips<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/sql/ai-and-sql/"><a class="padding" href="/sql/ai-and-sql/">AI and SQL<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="" data-nav-id="/azure_data_factory/"><a class="padding" href="/azure_data_factory/">ADF<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="parent " data-nav-id="/azure_data_bricks/"><input type="checkbox" id="R-section-be307a2f2d32c2a195add2e28563a24e" aria-controls="R-subsections-be307a2f2d32c2a195add2e28563a24e" checked><label for="R-section-be307a2f2d32c2a195add2e28563a24e"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu ADB</span></label><a class="padding" href="/azure_data_bricks/">ADB<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-be307a2f2d32c2a195add2e28563a24e" class="collapsible-menu">
            <li class="active " data-nav-id="/azure_data_bricks/spark/"><a class="padding" href="/azure_data_bricks/spark/">Spark<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/df-creation/"><a class="padding" href="/azure_data_bricks/df-creation/">DF Basics<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/df-operations/"><a class="padding" href="/azure_data_bricks/df-operations/">DF Operations<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/functions/"><a class="padding" href="/azure_data_bricks/functions/">Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/date/"><a class="padding" href="/azure_data_bricks/date/">Date Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/nulls/"><a class="padding" href="/azure_data_bricks/nulls/">Handling Nulls<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/aggregations/"><a class="padding" href="/azure_data_bricks/aggregations/">Aggregate functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/joins/"><a class="padding" href="/azure_data_bricks/joins/">Joins<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/when/"><a class="padding" href="/azure_data_bricks/when/">When|Cast|Union<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/window-functions/"><a class="padding" href="/azure_data_bricks/window-functions/">Window Functions<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/explode/"><a class="padding" href="/azure_data_bricks/explode/">Explode<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/pivot/"><a class="padding" href="/azure_data_bricks/pivot/">Pivot<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/azure_data_bricks/comparisons/"><a class="padding" href="/azure_data_bricks/comparisons/">Comparisons<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="" data-nav-id="/practice/"><input type="checkbox" id="R-section-21344c0a5719731e2ce7649deede330a" aria-controls="R-subsections-21344c0a5719731e2ce7649deede330a"><label for="R-section-21344c0a5719731e2ce7649deede330a"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu Practice Sets</span></label><a class="padding" href="/practice/">Practice Sets<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-21344c0a5719731e2ce7649deede330a" class="collapsible-menu">
            <li class="" data-nav-id="/practice/leetcode-sql/"><a class="padding" href="/practice/leetcode-sql/">SQL LeetCode<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/practice/pyspark1/"><a class="padding" href="/practice/pyspark1/">Pyspark 1<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
            <li class="" data-nav-id="/interviewprep/"><input type="checkbox" id="R-section-4c46d08ac015ee7f150578d25f17ee2b" aria-controls="R-subsections-4c46d08ac015ee7f150578d25f17ee2b"><label for="R-section-4c46d08ac015ee7f150578d25f17ee2b"><i class="fa-fw fas fa-chevron-right"></i><span class="a11y-only">Submenu Interview Prep</span></label><a class="padding" href="/interviewprep/">Interview Prep<i class="fa-fw fas fa-check read-icon"></i></a><ul id="R-subsections-4c46d08ac015ee7f150578d25f17ee2b" class="collapsible-menu">
            <li class="" data-nav-id="/interviewprep/adf1/"><a class="padding" href="/interviewprep/adf1/">ADF 1<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/pipeline1/"><a class="padding" href="/interviewprep/pipeline1/">Data Pipeline<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql1/"><a class="padding" href="/interviewprep/sql1/">SQL Theory<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql2/"><a class="padding" href="/interviewprep/sql2/">100 SQL Queries<i class="fa-fw fas fa-check read-icon"></i></a></li>
            <li class="" data-nav-id="/interviewprep/sql3/"><a class="padding" href="/interviewprep/sql3/">100 SQL Queries<i class="fa-fw fas fa-check read-icon"></i></a></li></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
            <li class="R-variantswitcher">
              <div class="padding menu-control">
                <i class="fa-fw fas fa-paint-brush"></i>
                <span>&nbsp;</span>
                <div class="control-style">
                  <label class="a11y-only" for="R-select-variant">Theme</label>
                  <select id="R-select-variant">
                    <option id="R-select-variant-auto" value="auto" selected>Auto</option>
                    <option id="R-select-variant-zen-light" value="zen-light">Zen Light</option>
                    <option id="R-select-variant-zen-dark" value="zen-dark">Zen Dark</option>
                  </select>
                </div>
                <div class="clear"></div>
              </div>
              <script>window.relearn.markVariant();</script>
            </li>
            <li class="R-historyclearer">
              <div class="padding menu-control">
                <i class="fa-fw fas fa-history"></i>
                <span>&nbsp;</span>
                <div class="control-style">
                  <button>Clear History</button>
                </div>
                <div class="clear"></div>
              </div>
            </li>
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/js-yaml/js-yaml.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-color.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-drag.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-ease.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-selection.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-timer.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-transition.min.js?1761498837" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1761498837" defer></script>
    <script src="/js/mermaid/mermaid.min.js?1761498837" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{}");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1761498837" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1761498837" defer></script>
    <script src="/js/theme.js?1761498837" defer></script>
  </body>
</html>
