<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Interview Prep :: Data Engineering Notes">
    <meta property="og:url" content="http://localhost:1313/interviewprep/">
    <meta property="og:site_name" content="Data Engineering Notes">
    <meta property="og:title" content="Interview Prep :: Data Engineering Notes">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Interview Prep :: Data Engineering Notes">
    <title>Interview Prep :: Data Engineering Notes</title>
    <link href="http://localhost:1313/interviewprep/" rel="canonical" type="text/html" title="Interview Prep :: Data Engineering Notes">
    <link href="/interviewprep/index.xml" rel="alternate" type="application/rss+xml" title="Interview Prep :: Data Engineering Notes">
    <link href="/interviewprep/index.md" rel="alternate" type="text/markdown" title="Interview Prep :: Data Engineering Notes">
    <link href="/images/favicon.ico?1761501432" rel="icon" type="image/x-icon" sizes="any">
    <link href="/css/auto-complete/auto-complete.min.css?1761501432" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1761501432" defer></script>
    <script src="/js/search-lunr.js?1761501432" defer></script>
    <script src="/js/search.js?1761501432" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1761501432";
    </script>
    <script src="/js/lunr/lunr.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1761501432" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1761501432" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761501432" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1761501432" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1761501432" rel="stylesheet">
    <link href="/css/theme.css?1761501432" rel="stylesheet">
    <link href="/css/format-print.css?1761501432" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/interviewprep\/';
      window.relearn.relBasePath='..';
      window.relearn.relBaseUri='..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'auto', 'zen-light', 'zen-dark' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 1000rem;
}
</style>
  </head>
  <body class="mobile-support print" data-url="/interviewprep/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class="a11y-only"><a itemprop="item" href="/"><span itemprop="name">Data Engineering Notes</span></a><meta itemprop="position" content="1">&nbsp;/&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Interview Prep</span><meta itemprop="position" content="2"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-edit" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://github.com/jampalabharath/relearn/tree/main/content/InterviewPrep/_index.md" rel="external" target="_blank" title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a>
            </div>
            <div class="topbar-button topbar-button-markdown" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/index.md" title="Show Markdown"><i class="fa-fw fab fa-markdown"></i></a>
            </div>
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/practice/pyspark1/" title="Pyspark 1 (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/interviewprep/adf1/" title="ADF 1 (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable chapter" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="chapter narrow">
  <header class="headline">
  </header>
<div class="article-subheading">Chapter 5</div>

<h1 id="interview-prep">Interview Prep</h1>


  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Interview Prep</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="adf-1">ADF 1</h1>

<h2 id="1-what-are-the-different-types-of-integration-runtimesir-in-adf-and-when-should-you-use-each">1. What are the different types of Integration runtimes(IR) in ADF, and when should you use each?</h2>
<p><strong>Integration runtime (IR)</strong> is a compute engine that provides computational resources to perform <strong>data movement, transformation, and orchestration</strong> in ADF.</p>
<h3 id="types-of-integration-runtimes">Types of Integration Runtimes</h3>
<ol>
<li>
<p><strong>Azure IR</strong></p>
<ul>
<li>Use when performing <strong>data movement, transformation, and orchestration entirely within the cloud</strong>.</li>
</ul>
</li>
<li>
<p><strong>Self-Hosted IR</strong></p>
<ul>
<li>Use when <strong>any source or destination is an on-premises system</strong>.</li>
<li>Required to <strong>pull data from on-prem systems</strong>.</li>
</ul>
</li>
<li>
<p><strong>Azure SSIS IR</strong></p>
<ul>
<li>Specifically built to <strong>lift and shift Microsoft SSIS packages</strong>.</li>
</ul>
</li>
</ol>
<h3 id="managing-integration-runtimes-in-adf">Managing Integration Runtimes in ADF</h3>
<ul>
<li>Navigate to <strong>ADF -&gt; Manage tab -&gt; Integration Runtimes</strong>.</li>
<li><strong>AutoResolveIntegrationRuntime</strong> is present by default.</li>
</ul>
<h3 id="creating-a-new-ir">Creating a New IR</h3>
<ol>
<li>Click on <strong>Add</strong>.</li>
<li>Choose the type of IR: <strong>Self-Hosted</strong>, <strong>SSIS</strong>, or <strong>Airflow</strong>.</li>
</ol>
<h2 id="2-platform-for-creating-azure-self-hosted-ir">2. Platform for Creating Azure Self-Hosted IR</h2>
<ul>
<li><strong>Self-Hosted IR</strong> requires compute <strong>outside of Azure</strong>, so you can use:
<ul>
<li>A <strong>local machine</strong></li>
<li>A <strong>hosted virtual machine</strong></li>
</ul>
</li>
</ul>
<h2 id="3-handling-schema-drift-in-adf">3. Handling Schema Drift in ADF</h2>
<p>When dealing with <strong>evolving datasets</strong>, e.g., a new column appears in the source not present in the destination:</p>
<ul>
<li>Use <strong>Mapping Dataflows</strong> to apply transformations.</li>
</ul>
<h3 id="options-in-mapping-dataflows">Options in Mapping Dataflows</h3>
<ol>
<li>
<p><strong>Schema Drift</strong></p>
<ul>
<li>Available when creating the <strong>source dataset</strong> in Mapping Dataflows.</li>
<li>Allows handling evolving schemas without errors.</li>
<li>Example: If a 5th column appears in the source, it will be written to the destination, with <strong>NULL for existing records</strong>.</li>
</ul>
</li>
<li>
<p><strong>Auto Mapping</strong></p>
<ul>
<li>Automatically maps columns between source and destination, eliminating manual schema mapping.</li>
</ul>
</li>
</ol>
<h3 id="recommended-approach">Recommended Approach</h3>
<ul>
<li><strong>Combine Schema Drift and Auto Mapping</strong> to handle evolving datasets seamlessly.</li>
</ul>
<h2 id="4-how-would-you-load-multiple-data-files-from-rest-apis-using-single-copy-activity">4. How would you load multiple data files from REST APIs using SINGLE copy activity?</h2>
<h3 id="steps">Steps</h3>
<ol>
<li>
<p><strong>Create a new pipeline</strong></p>
<ul>
<li>Go to <strong>Author tab → Create a new pipeline</strong> (name it <code>pipAPI</code>).</li>
</ul>
</li>
<li>
<p><strong>Add a ForEach activity</strong></p>
<ul>
<li>Drag a <strong>ForEach</strong> activity into the pipeline.</li>
</ul>
</li>
<li>
<p><strong>Configure ForEach parameters</strong></p>
<ul>
<li>In the <strong>Parameters</strong> tab of the ForEach activity, create a parameter:
<ul>
<li><strong>Name:</strong> <code>loop_value</code></li>
<li><strong>Type:</strong> <code>Array</code></li>
<li><strong>Default Value:</strong>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nt">&#34;fname&#34;</span><span class="p">:</span> <span class="s2">&#34;x.csv&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nt">&#34;fname&#34;</span><span class="p">:</span> <span class="s2">&#34;y.csv&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nt">&#34;fname&#34;</span><span class="p">:</span> <span class="s2">&#34;z.csv&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span></span></span></code></pre></div>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Set the ForEach items</strong></p>
<ul>
<li>Go to the <strong>Settings</strong> tab → under <strong>Items</strong>, add dynamic content:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">@pipeline().parameters.loop_value</span></span></code></pre></div>
</li>
</ul>
</li>
<li>
<p><strong>Add a Copy Data activity inside ForEach</strong></p>
<ul>
<li>Drag a <strong>Copy Data</strong> activity inside the ForEach loop.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="source-configuration">Source Configuration</h3>
<ol start="6">
<li>
<p><strong>Create Source Dataset</strong></p>
<ul>
<li>Create a dataset <code>ds_api</code> with:
<ul>
<li><strong>Datastore:</strong> HTTP</li>
<li><strong>Data format:</strong> CSV</li>
</ul>
</li>
<li>Choose or create a linked service <code>ls_api</code>:
<ul>
<li><strong>Integration Runtime:</strong> AutoResolveIR</li>
<li><strong>Base URL:</strong> <code>https://raw.githubuserdata.com/</code></li>
<li><strong>Authentication type:</strong> Anonymous</li>
<li>Test and create the connection.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Parameterize the Source Dataset</strong></p>
<ul>
<li>Go to the <strong>Parameters</strong> tab:
<ul>
<li>Add parameter:
<ul>
<li><strong>Name:</strong> <code>p_filenm</code></li>
<li><strong>Type:</strong> String</li>
<li><strong>Default value:</strong> <code>@item().fname</code></li>
</ul>
</li>
</ul>
</li>
<li>Go to the <strong>Connection</strong> tab → under <strong>Relative URL</strong>, add dynamic content:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">anshikagit/ADF/refs/heads/main/Data/@{dataset().p_filenm}</span></span></code></pre></div>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="sink-configuration">Sink Configuration</h3>
<ol start="8">
<li>
<p><strong>Create Sink Dataset</strong></p>
<ul>
<li>Create a dataset <code>ds_adls</code> with:
<ul>
<li><strong>Datastore:</strong> ADLS Gen2</li>
<li><strong>Data format:</strong> CSV</li>
</ul>
</li>
<li>Choose or create a linked service <code>ls_adls</code>:
<ul>
<li><strong>Integration Runtime:</strong> AutoResolveIR</li>
<li><strong>Storage account name:</strong> ansadfstrg11</li>
<li>Test and create the connection.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Parameterize the Sink Dataset</strong></p>
<ul>
<li>Go to the <strong>Parameters</strong> tab:
<ul>
<li>Add parameters:
<ul>
<li><strong>p_folder:</strong> string</li>
<li><strong>p_file:</strong> string</li>
</ul>
</li>
<li>Default values:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">@item().fname</span></span></code></pre></div>
</li>
</ul>
</li>
<li>In the <strong>Connection</strong> tab, under <strong>File path</strong>, add dynamic content:
<ul>
<li><strong>Directory:</strong> <code>@dataset().p_folder</code></li>
<li><strong>Filename:</strong> <code>@dataset().p_file.csv</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<ol start="10">
<li><strong>Run the Pipeline</strong>
<ul>
<li>Click <strong>Debug</strong> to execute the pipeline and verify multiple file copies from REST API to ADLS Gen2.</li>
</ul>
</li>
</ol>
<h2 id="5-how-would-you-design-a-fault-tolerant-adf-pipeline-to-process-billions-of-records-daily">5. How would you design a fault tolerant ADF pipeline to process billions of records daily?</h2>
<p>To handle large-scale data processing (billions of records per day) in <strong>Azure Data Factory (ADF)</strong> efficiently and reliably, the following mechanisms can be leveraged:</p>
<hr>
<h3 id="a-retry-policy">a. Retry Policy</h3>
<ul>
<li>ADF provides built-in <strong>Retry Policy</strong> for all activities.</li>
<li>You can specify:
<ul>
<li><strong>Number of retries</strong> — how many times an activity should retry upon failure.</li>
<li><strong>Retry interval</strong> — time gap between retries.</li>
</ul>
</li>
</ul>
<p><strong>Example:</strong><br>
If a Copy Activity fails due to transient network issues, setting:</p>
<ul>
<li><strong>Retry count:</strong> <code>3</code></li>
<li><strong>Retry interval:</strong> <code>30 seconds</code><br>
ensures ADF automatically retries before marking the activity as failed.</li>
</ul>
<hr>
<h3 id="b-parallelism-in-mapping-data-flows">b. Parallelism in Mapping Data Flows</h3>
<h4 id="i-parallelism-within-a-single-mapping-data-flow">i. Parallelism within a Single Mapping Data Flow</h4>
<ul>
<li>Enables <strong>multiple sink operations</strong> to run <strong>simultaneously</strong> within the same data flow.</li>
<li>Example:<br>
Processing customer data and writing to both:
<ul>
<li>A <strong>SQL database</strong> (for analytics)</li>
<li>A <strong>Data Lake</strong> (for archival)</li>
</ul>
</li>
</ul>
<p>By enabling <strong>&ldquo;Run in parallel&rdquo;</strong> in <strong>Sink Properties</strong>, both sinks execute concurrently instead of sequentially — improving overall performance.</p>
<hr>
<h4 id="ii-parallelism-across-multiple-data-flow-activities-in-a-pipeline">ii. Parallelism Across Multiple Data Flow Activities in a Pipeline</h4>
<p><strong>1. Independent Data Sources</strong></p>
<ul>
<li>If two datasets (e.g., <strong>Sales</strong> and <strong>Inventory</strong>) are independent:
<ul>
<li>Create two Data Flow activities — one for each dataset.</li>
<li>Place them in <strong>parallel branches</strong> within the pipeline.</li>
<li>ADF executes both simultaneously, reducing total runtime.</li>
</ul>
</li>
</ul>
<p><strong>2. Parallel ForEach Processing</strong></p>
<ul>
<li>When processing multiple files (e.g., CSVs in a folder) with identical transformation logic:
<ul>
<li>Use a <strong>ForEach</strong> activity to iterate through the files.</li>
<li>Enable <strong>parallel execution</strong> inside ForEach.</li>
<li>ADF will process multiple files concurrently, greatly accelerating throughput.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="c-failure-notification-and-alerts">c. Failure Notification and Alerts</h3>
<p>To ensure quick response to failures:</p>
<ol>
<li>Go to the <strong>Monitor</strong> tab in ADF.</li>
<li>Click <strong>New Alert Rule</strong>.</li>
<li>Provide details:
<ul>
<li><strong>Name:</strong> <code>failAlert1</code></li>
<li><strong>Severity:</strong> Choose appropriate level.</li>
</ul>
</li>
<li>In <strong>Target criteria</strong>:
<ul>
<li>Add metrics such as:
<ul>
<li><strong>Activity type(s)</strong></li>
<li><strong>Name(s)</strong></li>
<li><strong>Pipeline name(s)</strong></li>
<li><strong>Failure type(s)</strong></li>
</ul>
</li>
</ul>
</li>
<li>Define <strong>condition</strong>, <strong>threshold</strong>, <strong>period</strong>, and <strong>frequency</strong> for triggering alerts.</li>
<li>Configure <strong>Notifications</strong>:
<ul>
<li>Add Email, SMS, or both.</li>
<li>Provide recipient details.</li>
<li>Save to activate the alert.</li>
</ul>
</li>
</ol>
<blockquote>
<p>Example:<br>
For the Copy Activity inside the ForEach (as in Question 4), include the <strong>ForEach activity</strong> itself in alert criteria since a child failure causes the parent to fail as well.</p></blockquote>
<hr>
<p>By combining <strong>Retry Policies</strong>, <strong>Parallelism</strong>, and <strong>Automated Failure Alerts</strong>, you can design a highly <strong>fault-tolerant</strong>, <strong>scalable</strong>, and <strong>resilient</strong> ADF pipeline capable of processing billions of records daily.</p>
<h2 id="6-your-adf-pipeline-is-running-slow--how-to-identify-and-fix-performance-bottlenecks">6. Your ADF Pipeline is Running Slow — How to Identify and Fix Performance Bottlenecks</h2>
<h3 id="a-initial-step-monitor-and-identify">a. Initial Step: Monitor and Identify</h3>
<ul>
<li>As a Data Engineer, the <strong>first step</strong> is to monitor the pipeline and <strong>identify which activity</strong> is causing delays.</li>
<li>Use the <strong>Monitor</strong> tab in ADF to review activity runtimes and pinpoint the bottleneck.</li>
</ul>
<h3 id="b-common-root-causes-and-fixes">b. Common Root Causes and Fixes</h3>
<ol>
<li>
<p><strong>Slow Data Flows</strong></p>
<ul>
<li>Issue: Data flow execution takes longer than expected.</li>
<li>Fix: <strong>Prune the data</strong> in the early stages (apply filters or reduce columns before transformation).</li>
</ul>
</li>
<li>
<p><strong>Slow Copy Activity</strong></p>
<ul>
<li>Issue: Copying data from <strong>on-premises to Azure</strong> takes too long due to <strong>Self-Hosted Integration Runtime (IR)</strong> throttling.</li>
<li>Fix: Scale up the IR VM, allocate more CPU/memory, or distribute load across multiple IR nodes.</li>
</ul>
</li>
</ol>
<hr>
<h2 id="7-implementing-incremental-data-load-in-adf-for-large-transactional-databases">7. Implementing Incremental Data Load in ADF for Large Transactional Databases</h2>
<h3 id="a-watermark-approach--step-by-step">a. Watermark Approach — Step-by-Step</h3>
<ol>
<li>
<p><strong>Identify a Watermark Column</strong><br>
Choose a column that updates with each new or modified record, e.g., <code>lastModifiedDate</code> or an increasing <code>ID</code>.</p>
</li>
<li>
<p><strong>Store the Watermark Value</strong><br>
Maintain the last processed watermark value in a <strong>control table</strong> or <strong>pipeline variable</strong>.</p>
</li>
<li>
<p><strong>Filter Data</strong></p>
<ul>
<li>Use a <strong>Lookup Activity</strong> to fetch the last watermark from the control table.</li>
<li>Use a <strong>Copy Activity</strong> with a dynamic query:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">SourceTable</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lastModifiedDate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="err">{</span><span class="n">activity</span><span class="p">(</span><span class="s1">&#39;Lookup&#39;</span><span class="p">).</span><span class="k">output</span><span class="p">.</span><span class="n">firstRow</span><span class="p">.</span><span class="n">LastWatermark</span><span class="err">}</span></span></span></code></pre></div>
</li>
</ul>
</li>
<li>
<p><strong>Update the Watermark</strong><br>
After the successful copy, use a <strong>Stored Procedure</strong> or <strong>Script Activity</strong> to update the watermark table with the new maximum watermark value.</p>
</li>
</ol>
<hr>
<h3 id="b-cdc-change-data-capture-approach">b. CDC (Change Data Capture) Approach</h3>
<ol>
<li>
<p><strong>Enable CDC on Source</strong><br>
Activate CDC on the source database and required tables — this tracks inserts, updates, and deletes in system tables.</p>
</li>
<li>
<p><strong>Use ADF’s Built-in CDC Feature</strong><br>
ADF can directly read from CDC system tables to identify changed data automatically.</p>
</li>
<li>
<p><strong>Extract and Apply Changes</strong></p>
<ul>
<li>Use the <code>__$operation</code> field to determine change type:
<ul>
<li><code>1</code>: Delete</li>
<li><code>2</code>: Insert</li>
<li><code>3</code>/<code>4</code>: Update</li>
</ul>
</li>
<li>Apply logic accordingly in your sink.</li>
</ul>
</li>
<li>
<p><strong>Manage Checkpoints Automatically</strong><br>
ADF maintains <strong>checkpoints</strong> (like LSN) to ensure only new changes since the last run are processed.</p>
</li>
</ol>
<hr>
<h2 id="8-processing-a-json-file-with-unknown-structure-in-adf">8. Processing a JSON File with Unknown Structure in ADF</h2>
<ul>
<li>Enable <strong>Schema Drift</strong> to handle schema evolution dynamically.</li>
<li>In a <strong>Mapping Data Flow</strong>:
<ol>
<li>Turn on <strong>Debug Mode</strong> to preview the schema.</li>
<li>Apply <strong>Flatten Transformation</strong> to denormalize nested JSON structures for processing.</li>
</ol>
</li>
</ul>
<hr>
<h2 id="9-implementing-real-time-streaming-pipeline-in-adf">9. Implementing Real-Time Streaming Pipeline in ADF</h2>
<h3 id="scenario">Scenario</h3>
<p>A new file arrives in an ADLS container, and you need to <strong>copy it automatically</strong> to another container.</p>
<h3 id="solution-event-based-trigger">Solution: Event-Based Trigger</h3>
<ul>
<li>Use an <strong>Event-Based Trigger</strong> to automatically start the pipeline whenever a new file arrives.</li>
</ul>
<h3 id="configuration-steps">Configuration Steps</h3>
<ol>
<li>Register <strong>Event Grid Services</strong> under <strong>Subscriptions</strong>.</li>
<li>Create a new <strong>Event-Based Trigger</strong> in ADF:
<ul>
<li>Trigger type: <strong>Blob Created</strong></li>
<li>Linked service: Connect to the ADLS container.</li>
<li>Action: Launch the desired pipeline (e.g., Copy Activity).</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>Note:</strong> Registration of <strong>Event Grid Services</strong> is mandatory before using Event-Based Triggers.</p></blockquote>
<h2 id="10-how-would-you-load-data-to-different-locations-based-on-file-name-in-adf">10. How Would You Load Data to Different Locations Based on File Name in ADF</h2>
<h3 id="a-get-file-list-get-metadata-activity">a. Get File List (Get Metadata Activity)</h3>
<ul>
<li>Start the pipeline with a <strong>Get Metadata</strong> activity.</li>
<li>Configure it to retrieve <strong>Child Items</strong> from the source folder in your storage account.</li>
<li>This activity outputs a list of all files present in the specified source location.</li>
</ul>
<h3 id="b-iterate-over-files-for-each-activity">b. Iterate Over Files (For Each Activity)</h3>
<ul>
<li>Pass the output of the <strong>Get Metadata</strong> activity to a <strong>For Each</strong> activity.</li>
<li>This allows the pipeline to <strong>loop through each file</strong> found in the source folder and process them one by one.</li>
</ul>
<h3 id="c-conditional-routing-if-condition-activity">c. Conditional Routing (If Condition Activity)</h3>
<ul>
<li>Inside the <strong>For Each</strong> loop, add an <strong>If Condition</strong> activity.</li>
<li>Use expressions to check the file name for specific patterns or keywords to determine where each file should go.</li>
<li>Example expressions:</li>
</ul>
<p><code>@contains(item().name, 'sales')</code>
or
<code>@startsWith(item().name, 'marketing')</code></p>
<p><strong>Based on the Condition</strong></p>
<ul>
<li>If the file name contains <strong>&ldquo;sales&rdquo;</strong>, route it to a <strong>Sales</strong> destination folder.</li>
<li>If it contains <strong>&ldquo;marketing&rdquo;</strong>, route it to a <strong>Marketing</strong> destination folder.</li>
</ul>
<hr>
<h3 id="d-load-data-copy-data-activity">d. Load Data (Copy Data Activity)</h3>
<ul>
<li>Each branch of the <strong>If Condition</strong> activity will contain a <strong>Copy Data</strong> activity.</li>
<li>Configure as follows:
<ul>
<li><strong>Source Dataset:</strong> The current file being processed (<code>@item().name</code>)</li>
<li><strong>Sink Dataset:</strong> The target destination based on the file name (e.g., Sales or Marketing folder)</li>
</ul>
</li>
<li>The <strong>Copy Data</strong> activity will copy files to their respective destinations according to the defined condition logic.</li>
</ul>
<hr>
<h3 id="example-pipeline-flow">Example Pipeline Flow</h3>
<ol>
<li><strong>Get Metadata Activity</strong> → Retrieve list of files from the source folder.</li>
<li><strong>For Each Activity</strong> → Iterate through each file.</li>
<li><strong>If Condition Activity</strong> → Check the file name for keywords like “sales” or “marketing.”</li>
<li><strong>Copy Data Activity</strong> → Load the file into the corresponding destination folder based on the condition.</li>
</ol>
<h2 id="11-storing-all-file-names-in-a-variable--counting-files-in-a-folder">11. Storing All File Names in a Variable &amp; Counting Files in a Folder</h2>
<h3 id="a-get-file-list">a. Get File List</h3>
<ul>
<li>Use a <strong>Get Metadata</strong> activity configured with <strong>Child Items</strong>.</li>
<li>This returns a single array containing the names of all files and subfolders in the specified location.</li>
</ul>
<h3 id="b-iterate-over-files">b. Iterate Over Files</h3>
<ul>
<li>Use a <strong>For Each</strong> activity to loop through the array returned by Get Metadata.</li>
<li>Inside the loop, you can process each file individually.</li>
</ul>
<h3 id="c-store-file-names">c. Store File Names</h3>
<ul>
<li>Use <strong>Set Variable</strong> and <strong>Append Variable</strong> activities to store and manipulate the list of file names:
<ul>
<li><strong>Set Variable:</strong> Assign an entire list of file names to a pipeline variable (e.g., <code>fileNamesArray</code>).</li>
<li><strong>Append Variable:</strong> When building the list dynamically within a loop, add one filename at a time.
<ul>
<li>Useful if looping through multiple folders and combining all filenames into a single list.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="d-count-the-files">d. Count the Files</h3>
<ul>
<li>Use a second <strong>Set Variable</strong> activity to store the count of files.</li>
<li>Create a variable of type <strong>Integer</strong> (e.g., <code>fileCount</code>).</li>
<li>Use the following expression in the <strong>Value</strong> field:</li>
</ul>
<p><code>@length(variables('fileNamesArray'))</code></p>
<h2 id="12-pipeline-design-in-adf-to-copy-only-files-not-present-in-destination">12. Pipeline Design in ADF to Copy Only Files Not Present in Destination</h2>
<h3 id="a-get-source-file-list">a. Get Source File List</h3>
<ul>
<li>Use a <strong>Get Metadata</strong> activity to retrieve a list of all files from the <strong>source folder</strong>.</li>
</ul>
<h3 id="b-get-destination-file-list">b. Get Destination File List</h3>
<ul>
<li>Use a second <strong>Get Metadata</strong> activity to retrieve all files from the <strong>destination folder</strong>.</li>
<li>Store this list in a <strong>pipeline variable</strong> (e.g., <code>destinationFiles</code>).</li>
</ul>
<h3 id="c-iterate-and-compare">c. Iterate and Compare</h3>
<ul>
<li>Use a <strong>For Each</strong> activity to loop through the array of source files obtained from the first <strong>Get Metadata</strong> activity.</li>
</ul>
<h3 id="d-implement-the-condition">d. Implement the Condition</h3>
<ul>
<li>Inside the loop, add an <strong>If Condition</strong> activity to check if the current file from the source exists in the destination variable.</li>
<li>Expression example:</li>
</ul>
<p><code>@not(contains(string(variables('destinationFiles')), item().name))</code></p>
<h3 id="e-copy-the-file">e. Copy the File</h3>
<ul>
<li>Place a <strong>Copy Data</strong> activity inside the <strong>True</strong> block of the <strong>If Condition</strong>.</li>
<li>This ensures that only files <strong>not present in the destination</strong> are copied from the source.</li>
</ul>
<h2 id="13-calling-secrets-stored-in-key-vault-in-adf">13. Calling Secrets Stored in Key Vault in ADF</h2>
<h3 id="creation-of-secret-in-key-vault">Creation of Secret in Key Vault</h3>
<ol>
<li>
<p><strong>Create Key Vault</strong></p>
<ul>
<li>In the Azure Portal, search for <strong>&ldquo;Key Vaults&rdquo;</strong> and click <strong>Create</strong>.</li>
<li>Fill in the basic details: Subscription, Resource Group, Name (globally unique), and Region.</li>
</ul>
</li>
<li>
<p><strong>Assign Key Vault Administrator Role</strong></p>
<ul>
<li>Navigate to <strong>IAM</strong> and assign the <strong>Key Vault Administrator</strong> role to the ID authorized to create secrets.</li>
</ul>
</li>
<li>
<p><strong>Create a Secret</strong></p>
<ul>
<li>Go to <strong>Secrets</strong> inside the Key Vault and create a new secret.</li>
</ul>
</li>
<li>
<p><strong>(Optional) Provide 3rd Party Access</strong></p>
<ul>
<li>To allow access to external services like Databricks:
<ul>
<li>Key Vault → <strong>Access Configuration</strong> → Choose <strong>Vault Access Policy</strong> to grant data plane access.</li>
</ul>
</li>
<li>By default, <strong>Azure RBAC</strong> is used. This step can also be configured during Key Vault creation.</li>
</ul>
</li>
<li>
<p><strong>Set Access Policies for ADF</strong></p>
<ul>
<li>Navigate to <strong>Access Policies</strong> or <strong>Access Control (IAM)</strong> in the Key Vault.</li>
<li>Grant your <strong>Azure Data Factory</strong> <strong>Get</strong> and <strong>List</strong> permissions for secrets via its <strong>Managed Identity</strong>.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="calling-the-secret-in-adf">Calling the Secret in ADF</h3>
<h4 id="1-standard-method-recommended">1. Standard Method (Recommended)</h4>
<ul>
<li>
<p><strong>Create a Key Vault Linked Service</strong></p>
<ul>
<li>Go to <strong>Manage → Linked Services → New</strong> in your ADF instance.</li>
<li>Choose <strong>Azure Key Vault</strong> and point it to your Key Vault.</li>
</ul>
</li>
<li>
<p><strong>Reference the Secret in Another Linked Service</strong></p>
<ul>
<li>When creating a linked service for a data store (e.g., SQL Database), select the option to <strong>Reference a Secret</strong> for sensitive fields like passwords.</li>
<li>Choose the Key Vault Linked Service created above and provide the <strong>secret name</strong> (e.g., <code>MyDatabasePassword</code>).</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-advanced-method-using-web-activity">2. Advanced Method (Using Web Activity)</h4>
<ul>
<li>
<p><strong>Use Web Activity to Retrieve Secret Dynamically</strong></p>
<ol>
<li>Add a <strong>Web Activity</strong> to your pipeline.</li>
<li>Configure REST API call to Key Vault:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>https://&lt;your_key_vault_name&gt;.vault.azure.net/secrets/&lt;your_secret_name&gt;?api-version=7.4</code></pre></div>
</li>
<li><strong>Authentication:</strong> Managed Identity<br>
<strong>Resource:</strong> <code>https://vault.azure.net</code></li>
<li><strong>Method:</strong> GET</li>
</ol>
</li>
<li>
<p><strong>Use the Secret in Subsequent Activities</strong></p>
<ul>
<li>The secret value will be in the Web Activity output.</li>
<li>Reference it using an expression:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">@activity(&#39;Web1&#39;).output.value</span></span></code></pre></div>
</li>
</ul>
</li>
</ul>
<h2 id="14-avoiding-out-of-memory-oom-errors-in-adf-pipelines-processing-large-datasets">14. Avoiding Out-of-Memory (OOM) Errors in ADF Pipelines Processing Large Datasets</h2>
<h3 id="a-optimize-your-integration-runtime-ir">a. Optimize Your Integration Runtime (IR)</h3>
<ul>
<li>The <strong>IR</strong> is the compute engine for your pipeline. Proper configuration ensures enough memory for large workloads.</li>
</ul>
<h4 id="mapping-data-flows">Mapping Data Flows</h4>
<ul>
<li>Scale up the <strong>Azure IR</strong> used by your data flow.</li>
<li>Increase <strong>Core Count</strong> and choose <strong>Memory Optimized</strong> compute type.</li>
<li>This provides more resources to the underlying Spark cluster for large transformations.</li>
</ul>
<h4 id="self-hosted-ir">Self-Hosted IR</h4>
<ul>
<li>For on-premises data processing, add more nodes to your <strong>Self-Hosted IR</strong>.</li>
<li>Distributes workload across machines to prevent a single node from running out of memory.</li>
</ul>
<hr>
<h3 id="b-partition-large-datasets">b. Partition Large Datasets</h3>
<ul>
<li>Breaking data into smaller chunks prevents OOM issues.</li>
</ul>
<h4 id="files">Files</h4>
<ul>
<li>Use <strong>Get Metadata</strong> to retrieve all files in a folder.</li>
<li>Use a <strong>For Each</strong> loop to process files individually via <strong>Copy Data</strong> or <strong>Mapping Data Flow</strong>.</li>
<li>In <strong>Data Flow source options</strong>, set partitioning (single, multiple, or none) to enable parallel processing.</li>
</ul>
<h4 id="database-tables">Database Tables</h4>
<ul>
<li>Implement <strong>iterative range copy</strong> for large tables:
<ul>
<li>Use a <strong>Lookup</strong> activity to find min and max values of a key column (e.g., ID or date).</li>
<li>Use a <strong>For Each</strong> loop to copy smaller chunks (e.g., 100,000 rows at a time) with a <strong>parameterized query</strong>.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="c-tune-activity-specific-settings">c. Tune Activity-Specific Settings</h3>
<h4 id="mapping-data-flow">Mapping Data Flow</h4>
<ul>
<li>Be cautious with <strong>Broadcast joins or lookups</strong>:
<ul>
<li>Broadcasting improves performance but can cause OOM if the dataset is too large.</li>
<li>Turn off broadcasting for large streams if necessary.</li>
</ul>
</li>
<li>Prune or filter data early in the flow to reduce memory usage.</li>
</ul>
<h4 id="copy-data-activity">Copy Data Activity</h4>
<ul>
<li>For extremely large single files (XML, JSON, Excel), OOM can occur.</li>
<li>Use the <strong>Binary Copy</strong> feature to move files without loading content into memory.</li>
</ul>
<h2 id="15-ensuring-idempotency-in-adf-pipelines">15. Ensuring Idempotency in ADF Pipelines</h2>
<p><strong>Idempotency</strong> ensures that running the same process multiple times with the same input produces the <strong>same result</strong> as running it once, preventing duplicate processing of records. This can be achieved using <strong>UPSERT</strong> on file data, often with <strong>inline datasets</strong> (e.g., Delta Lake) in Mapping Data Flows.</p>
<hr>
<h3 id="a-source-transformations">a. Source Transformations</h3>
<ul>
<li>Configure <strong>at least two source transformations</strong>:
<ol>
<li><strong>Incoming Data Source</strong> – your new data.</li>
<li><strong>Destination Data Source</strong> – existing data in the target.</li>
</ol>
</li>
<li>Use <strong>inline datasets</strong> to define connection details and schema directly in the data flow.</li>
</ul>
<hr>
<h3 id="b-exists-transformation">b. Exists Transformation</h3>
<ul>
<li>Use an <strong>Exists transformation</strong> to implement idempotency.</li>
<li>It acts like a <code>WHERE EXISTS</code> clause in SQL:
<ul>
<li>Checks if rows from the <strong>incoming data stream</strong> (left stream) exist in the <strong>destination stream</strong> (right stream) based on a key (e.g., primary key).</li>
</ul>
</li>
</ul>
<hr>
<h3 id="c-conditional-split">c. Conditional Split</h3>
<ul>
<li>Chain a <strong>Conditional Split</strong> transformation after the Exists transformation.</li>
<li>Split the data into two streams:
<ol>
<li><strong>New Records</strong> – rows where the key does <strong>not exist</strong> in the destination; these will be inserted.</li>
<li><strong>Existing Records</strong> – rows where the key <strong>does exist</strong>; these will be updated.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="d-alter-row--sink">d. Alter Row &amp; Sink</h3>
<ul>
<li>Connect an <strong>Alter Row</strong> transformation to each stream from the Conditional Split:
<ul>
<li><strong>New Records</strong> → set <strong>Insert</strong> policy.</li>
<li><strong>Existing Records</strong> → set <strong>Upsert</strong> or <strong>Update</strong> policy.</li>
</ul>
</li>
<li>Connect both Alter Row outputs to a single <strong>Sink</strong> transformation.
<ul>
<li>Configure the sink to allow <strong>Insert</strong> and <strong>Upsert/Update</strong> policies.</li>
<li>Define the <strong>key columns</strong> for correct record matching.</li>
</ul>
</li>
</ul>
<p>This approach ensures that <strong>duplicate processing of the same records does not occur</strong>, maintaining idempotency in your ADF pipeline.</p>
<h2 id="16-enforcing-file-processing-order-in-adf">16. Enforcing File Processing Order in ADF</h2>
<ul>
<li>To process files in a <strong>specific order</strong> (e.g., <code>sales.csv</code> → <code>product.csv</code> → <code>cust.csv</code>), use the <strong>Sequential</strong> option in the <strong>For Each</strong> activity.</li>
<li>This ensures that files are processed <strong>one after another</strong> rather than in parallel.</li>
</ul>
<hr>
<h2 id="17-processing-two-files-with-different-schemas-using-a-single-copy-data-activity">17. Processing Two Files with Different Schemas Using a Single Copy Data Activity</h2>
<h3 id="a-source-dataset">a. Source Dataset</h3>
<ul>
<li>Create a <strong>source dataset</strong> that takes the <strong>file name as a parameter</strong>.</li>
<li>In the <strong>file path settings</strong>, use a dynamic expression:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">@item().name</span></span></code></pre></div>
</li>
</ul>
<p>This passes the current file name from the For Each loop to the Copy Data activity.</p>
<h3 id="b-dynamic-mapping">b. Dynamic Mapping</h3>
<h4 id="delete-static-mapping">Delete Static Mapping</h4>
<ul>
<li>In the <strong>Mapping</strong> tab of the Copy Data activity, remove existing column mappings.</li>
<li>You can either delete the entire mapping table or remove columns manually.</li>
</ul>
<h4 id="enable-schema-drift">Enable Schema Drift</h4>
<ul>
<li>In the <strong>source settings</strong> of the Copy Data activity, enable <strong>Schema Drift</strong>.</li>
<li>This allows the activity to <strong>dynamically handle different schemas</strong> at runtime.</li>
</ul>
<h4 id="map-dynamically">Map Dynamically</h4>
<p><strong>Option 1: Auto-Mapping</strong></p>
<ul>
<li>Leave the <strong>Mapping</strong> tab blank.</li>
<li>ADF will automatically map columns from source to sink based on matching names.</li>
</ul>
<p><strong>Option 2: Explicit Dynamic Mapping</strong></p>
<ul>
<li>If column transformation or renaming is required, define <strong>dynamic mappings</strong> using expressions.</li>
<li>For simple copy scenarios, leaving the mapping blank is the most efficient approach.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="data-pipeline">Data Pipeline</h1>

<h1 id="databricks-medallion-playbook-adls-csv--delta">Databricks Medallion Playbook (ADLS CSV → Delta)</h1>
<blockquote>
<p>End‑to‑end guide for <strong>incremental loading</strong>, <strong>data validations/quality</strong>, and <strong>SCD Type 2</strong> using <strong>Databricks</strong> + <strong>ADLS</strong> with <strong>Medallion</strong> layers: <em>landing → raw (bronze) → rawint (silver‑staging) → curated (silver) → enriched (gold).</em> Uses <strong>Delta Lake</strong> everywhere.</p></blockquote>
<hr>
<h2 id="0-principles--conventions">0) Principles &amp; Conventions</h2>
<p><strong>General</strong></p>
<ul>
<li>Use <strong>Delta</strong> for all managed tables; avoid plain CSV/Parquet beyond landing.</li>
<li>Prefer <strong>Auto Loader</strong> for incremental files; fall back to <code>COPY INTO</code> for one‑off backfills.</li>
<li>Treat <em>raw</em> as immutable; never update, only append/reprocess.</li>
<li>Store <strong>ingestion metadata</strong> on every row: <code>ingest_id</code>, <code>ingest_ts</code>, <code>source_file</code>, <code>source_mod_ts</code>, <code>batch_id</code>.</li>
</ul>
<p><strong>Naming</strong></p>
<ul>
<li>Workspaces &amp; Catalogs: <code>uc_catalog = &lt;org&gt;_prod|stg</code>, <code>uc_schema = &lt;domain&gt;_&lt;layer&gt;</code> (e.g., <code>sales_raw</code>, <code>sales_curated</code>).</li>
<li>Tables: <code>&lt;entity&gt;_&lt;granularity&gt;</code> (snake_case). Examples: <code>orders_header</code>, <code>orders_line</code>.</li>
<li>Columns: <code>snake_case</code> (e.g., <code>order_id</code>, <code>valid_from</code>).</li>
<li>Notebook files: <code>&lt;layer&gt;-&lt;domain&gt;-&lt;entity&gt;-&lt;purpose&gt;.nb</code> (kebab-case). Example: <code>raw-sales-orders-ingest.nb</code>.</li>
<li>Jobs: <code>&lt;layer&gt;.&lt;domain&gt;.&lt;entity&gt;.&lt;schedule&gt;</code> (e.g., <code>raw.sales.orders.hourly</code>).</li>
<li>Checkpoint &amp; schema locations: <code>/checkpoints/&lt;domain&gt;/&lt;entity&gt;/&lt;layer&gt;/</code> and <code>/schemas/&lt;domain&gt;/&lt;entity&gt;/</code>.</li>
</ul>
<p><strong>Source control &amp; CI/CD</strong></p>
<ul>
<li>Store notebooks as <strong>Databricks Repos</strong> (files) with code‑review; use <strong>bundle</strong>/IaC to deploy.</li>
<li>Parameterize via widgets or job parameters; keep <strong>secrets</strong> in Key Vault / Databricks secrets.</li>
</ul>
<p><strong>Security &amp; Governance</strong></p>
<ul>
<li>Use <strong>Unity Catalog</strong> (UC) for data access, lineage, tags, and ownership.</li>
<li>Assign owners per schema/table; define data classifications via UC tags (e.g., <code>pii=true</code>).</li>
</ul>
<hr>
<h2 id="1-adls-folder-taxonomy-sources-as-csv">1) ADLS Folder Taxonomy (Sources as CSV)</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>/adls/&lt;container&gt;/landing/
  └── &lt;domain&gt;/
       └── &lt;source_system&gt;/
            └── &lt;entity&gt;/
                 ├── year=YYYY/ month=MM/ day=DD/  # preferred partitioned landing
                 │    └── &lt;entity&gt;_&lt;YYYYMMDD_HHMMSS&gt;_&lt;batchid&gt;.csv
                 └── quarantine/  # failed/invalid files</code></pre></div>
<p>Notes</p>
<ul>
<li>Keep <strong>one entity per folder</strong>; include date partitions or place date/batch in filename.</li>
<li>Preserve file immutability; never delete sources, only move to <code>quarantine/</code> when necessary.</li>
</ul>
<hr>
<h2 id="2-medallion-table-layout-in-unity-catalog">2) Medallion Table Layout in Unity Catalog</h2>
<ul>
<li>
<p><strong>Catalog</strong>: <code>&lt;org&gt;_prod</code> (and <code>&lt;org&gt;_stg</code> for non‑prod).</p>
</li>
<li>
<p><strong>Schemas (per domain &amp; layer)</strong>:</p>
<ul>
<li><code>sales_raw</code> (bronze), <code>sales_rawint</code> (silver‑staging), <code>sales_curated</code> (silver), <code>sales_enriched</code> (gold).</li>
</ul>
</li>
<li>
<p><strong>Managed Storage</strong>: Delta tables stored in UC‑managed locations; external volumes for checkpoints/schemas.</p>
</li>
</ul>
<hr>
<h2 id="3-incremental-ingestion-landing--rawbronze">3) Incremental Ingestion (Landing → Raw/Bronze)</h2>
<p><strong>Preferred: Auto Loader (cloudFiles)</strong></p>
<ul>
<li>Handles <strong>new files only</strong>, scalable file discovery, schema inference &amp; evolution.</li>
</ul>
<p><strong>PySpark pattern</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">input_file_name</span><span class="p">,</span> <span class="n">current_timestamp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">source_path</span> <span class="o">=</span> <span class="s2">&#34;/Volumes/&lt;catalog&gt;/&lt;schema&gt;/&lt;volume&gt;/landing/sales/erp/orders/&#34;</span>  <span class="c1"># or abfss://</span>
</span></span><span class="line"><span class="cl"><span class="n">chkpt_path</span>   <span class="o">=</span> <span class="s2">&#34;/Volumes/&lt;catalog&gt;/&lt;schema&gt;/&lt;volume&gt;/checkpoints/sales/orders/raw/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">schema_loc</span>   <span class="o">=</span> <span class="s2">&#34;/Volumes/&lt;catalog&gt;/&lt;schema&gt;/&lt;volume&gt;/schemas/sales/orders/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">raw_tbl</span>      <span class="o">=</span> <span class="s2">&#34;&lt;catalog&gt;.sales_raw.orders&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">df</span> <span class="o">:=</span> <span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">readStream</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;cloudFiles&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;cloudFiles.format&#34;</span><span class="p">,</span> <span class="s2">&#34;csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;inferSchema&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;cloudFiles.schemaLocation&#34;</span><span class="p">,</span> <span class="n">schema_loc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;source_file&#34;</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;ingest_ts&#34;</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">       <span class="p">))</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">writeStream</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;delta&#34;</span><span class="p">)</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;checkpointLocation&#34;</span><span class="p">,</span> <span class="n">chkpt_path</span><span class="p">)</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">availableNow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">toTable</span><span class="p">(</span><span class="n">raw_tbl</span><span class="p">)</span></span></span></code></pre></div>
<p><strong>Alternative: COPY INTO (batch/backfill)</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_raw</span><span class="p">.</span><span class="n">orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="s1">&#39;abfss://&lt;container&gt;@&lt;account&gt;.dfs.core.windows.net/landing/sales/erp/orders/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FILEFORMAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CSV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FORMAT_OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">COPY_OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;mergeSchema&#39;</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">);</span></span></span></code></pre></div>
<p><strong>Raw Table Schema</strong> (append‑only)</p>
<ul>
<li>Original columns as in source.</li>
<li>
<ul>
<li><code>ingest_ts TIMESTAMP</code>, <code>source_file STRING</code>, <code>batch_id STRING</code> (optional), <code>ingest_id STRING</code> (uuid).</li>
</ul>
</li>
</ul>
<hr>
<h2 id="4-data-quality--validations-raw--rawint">4) Data Quality &amp; Validations (Raw → RawInt)</h2>
<p><strong>Approach</strong></p>
<ul>
<li>Apply <strong>schema enforcement</strong>, <strong>type casting</strong>, <strong>conformance</strong> (trim, null handling, defaulting), and <strong>row‑level rules</strong>.</li>
<li>Route failed rows to <strong>quarantine table</strong> with error reasons.</li>
</ul>
<p><strong>Delta Expectations (simple built‑in checks)</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_rawint</span><span class="p">.</span><span class="n">orders_expectations</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">rule_name</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"> </span><span class="n">rule_expr</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"> </span><span class="n">violated_count</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n">batch_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">current_timestamp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">raw</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&#34;&lt;catalog&gt;.sales_raw.orders&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">validated</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;order_id&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;order_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;string&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;amount&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;amount&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;decimal(18,2)&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Rule examples</span>
</span></span><span class="line"><span class="cl"><span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;not_null_order_id&#34;</span><span class="p">:</span> <span class="s2">&#34;order_id IS NOT NULL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;valid_amount&#34;</span><span class="p">:</span> <span class="s2">&#34;amount &gt;= 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;date_present&#34;</span><span class="p">:</span> <span class="s2">&#34;order_date IS NOT NULL&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ok_df</span>    <span class="o">=</span> <span class="n">validated</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&#34; AND &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rules</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="n">rejects</span>  <span class="o">=</span> <span class="n">validated</span><span class="o">.</span><span class="n">exceptAll</span><span class="p">(</span><span class="n">ok_df</span><span class="p">)</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;error_reason&#34;</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;order_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">(),</span> <span class="s2">&#34;order_id_null&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;amount&#34;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;amount_negative&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="s2">&#34;generic_failure&#34;</span><span class="p">))</span> \
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;batch_ts&#34;</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ok_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;append&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;&lt;catalog&gt;.sales_rawint.orders&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rejects</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&#34;append&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&#34;&lt;catalog&gt;.sales_rawint.orders_rejects&#34;</span><span class="p">)</span></span></span></code></pre></div>
<p><strong>Best practices</strong></p>
<ul>
<li>Keep <strong>idempotency</strong>: filter by <code>ingest_ts</code>/<code>batch_id</code> when reprocessing.</li>
<li>Log metrics per batch to an <strong>observability</strong> table and dashboard in <strong>Lakeview/Grafana</strong>.</li>
</ul>
<hr>
<h2 id="5-deduplication--keys-rawint--curatedsilver">5) Deduplication &amp; Keys (RawInt → Curated/Silver)</h2>
<ul>
<li>Define <strong>business key</strong> (e.g., <code>order_id</code> + <code>source_system</code>).</li>
<li>Deduplicate by key &amp; latest <code>source_mod_ts</code>/<code>ingest_ts</code>.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">orders_dedup</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span><span class="w"> </span><span class="p">(</span><span class="n">rn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">source_mod_ts</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">ingest_ts</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_rawint</span><span class="p">.</span><span class="n">orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="6-scd-type-2-in-curated-slowly-changing-dimensions">6) SCD Type 2 in Curated (Slowly Changing Dimensions)</h2>
<p><strong>Target layout</strong></p>
<ul>
<li>Columns: business keys + attributes + <code>valid_from TIMESTAMP</code>, <code>valid_to TIMESTAMP</code>, <code>is_current BOOLEAN</code>, optional <code>record_hash</code>.</li>
</ul>
<p><strong>Upsert logic (MERGE)</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Staging changes (latest per key)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">v_stg</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">customer_changes_latest</span><span class="p">;</span><span class="w"> </span><span class="c1">-- build from rawint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tgt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="w"> </span><span class="n">v_stg</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">src</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">is_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">-- close old record
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">valid_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">(),</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">is_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">-- insert new current version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">valid_from</span><span class="p">,</span><span class="w"> </span><span class="n">valid_to</span><span class="p">,</span><span class="w"> </span><span class="n">is_current</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">(),</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">(</span><span class="s1">&#39;9999-12-31&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">true</span><span class="p">);</span></span></span></code></pre></div>
<p><strong>Hash diff</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sha2</span><span class="p">(</span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)),</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_rawint</span><span class="p">.</span><span class="n">customer_clean</span><span class="p">;</span></span></span></code></pre></div>
<p><strong>Querying current/historical</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Current snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- As-of time travel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">valid_from</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_to</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="7-enrichedgold-layer">7) Enriched/Gold Layer</h2>
<ul>
<li>Build <strong>fact</strong> tables (e.g., <code>fact_orders</code>) and <strong>semantic marts</strong> (aggregates, BI‑ready models).</li>
<li>Maintain <strong>surrogate keys</strong> via identity columns or mapping tables.</li>
<li>Enforce <strong>Z‑ORDER</strong> on common predicates and <strong>OPTIMIZE</strong> periodically.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">OPTIMIZE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">VACUUM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="n">RETAIN</span><span class="w"> </span><span class="mi">168</span><span class="w"> </span><span class="n">HOURS</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 7 days</span></span></span></code></pre></div>
<hr>
<h2 id="8-orchestration--scheduling">8) Orchestration &amp; Scheduling</h2>
<ul>
<li><strong>Databricks Jobs</strong> per domain/entity with dependency graph: <code>raw → rawint → curated → enriched</code>.</li>
<li>Triggers: time‑based (cron) or event‑based (file arrival) using Auto Loader.</li>
<li>Pass parameters: <code>domain</code>, <code>entity</code>, <code>since_ts</code> for incremental windows.</li>
<li>Implement <strong>retry with backoff</strong>, <strong>timeouts</strong>, and <strong>alerts</strong> to email/Slack.</li>
</ul>
<hr>
<h2 id="9-notebooks-youll-need-by-layer">9) Notebooks You’ll Need (by layer)</h2>
<p><strong>Landing/Raw</strong></p>
<ol>
<li><code>raw-&lt;domain&gt;-&lt;entity&gt;-ingest.nb</code> – Auto Loader stream job.</li>
<li><code>raw-&lt;domain&gt;-&lt;entity&gt;-backfill.nb</code> – <code>COPY INTO</code> for historical loads.</li>
</ol>
<p><strong>RawInt (Validation/Conformance)</strong>
3. <code>rawint-&lt;domain&gt;-&lt;entity&gt;-dq.nb</code> – type casting, rules, rejects, metrics.</p>
<p><strong>Curated (Modeling/SCD2)</strong>
4. <code>curated-&lt;domain&gt;-&lt;entity&gt;-dedup.nb</code> – dedup/windowing.
5. <code>curated-&lt;domain&gt;-&lt;entity&gt;-scd2.nb</code> – hash diff + MERGE.</p>
<p><strong>Enriched</strong>
6. <code>enriched-&lt;domain&gt;-&lt;entity&gt;-facts.nb</code> – facts/aggregations.
7. <code>enriched-&lt;domain&gt;-&lt;entity&gt;-optimize.nb</code> – OPTIMIZE/VACUUM.</p>
<p><strong>Ops/Utils</strong>
8. <code>utils-params.nb</code> – common params &amp; widgets.
9. <code>utils-common-fns.nb</code> – reusable functions (ingest metadata, logging, hashing).
10. <code>utils-observability.nb</code> – metrics tables &amp; dashboards.</p>
<hr>
<h2 id="10-parameters-shared-fragment">10) Parameters (shared fragment)</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># utils-params.nb</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;domain&#34;</span><span class="p">,</span> <span class="s2">&#34;sales&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;entity&#34;</span><span class="p">,</span> <span class="s2">&#34;orders&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;source_path&#34;</span><span class="p">,</span> <span class="s2">&#34;/Volumes/.../landing/$</span><span class="si">{domain}</span><span class="s2">/$</span><span class="si">{entity}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;catalog&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;org&gt;_prod&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;domain&#34;</span><span class="p">,</span><span class="s2">&#34;entity&#34;</span><span class="p">,</span><span class="s2">&#34;source_path&#34;</span><span class="p">,</span><span class="s2">&#34;catalog&#34;</span><span class="p">]}</span>
</span></span><span class="line"><span class="cl"><span class="n">cfg</span><span class="p">[</span><span class="s2">&#34;ingest_id&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span></span></span></code></pre></div>
<hr>
<h2 id="11-copying-from-adls--delta-summary">11) Copying from ADLS → Delta (summary)</h2>
<ul>
<li><strong>Auto Loader</strong> streaming job (preferred) from <code>abfss://</code> paths with checkpoints &amp; schema evolution.</li>
<li><strong>COPY INTO</strong> for bulk loads/backfills.</li>
<li>Always write to <strong>Delta tables</strong> in UC; never keep CSV beyond landing.</li>
</ul>
<hr>
<h2 id="12-performance--cost-best-practices">12) Performance &amp; Cost Best Practices</h2>
<ul>
<li><strong>Partition</strong> large tables by low‑cardinality/time columns (e.g., <code>load_date</code>); avoid over‑partitioning.</li>
<li>Periodic <strong>OPTIMIZE</strong> + <strong>Z‑ORDER</strong> on query keys.</li>
<li>Use <strong>availableNow</strong> triggers for micro‑batch bulk catch‑up.</li>
<li>Use <strong>Auto Compaction</strong> and <strong>Optimize Write</strong> (Workspace settings / table properties).</li>
</ul>
<hr>
<h2 id="13-observability--lineage">13) Observability &amp; Lineage</h2>
<ul>
<li>Create <strong>metrics tables</strong> (rows in/out, rejects, rule violations, late files).</li>
<li>Build <strong>Lakeview</strong> dashboards.</li>
<li>Use <strong>Unity Catalog lineage</strong> for end‑to‑end traceability.</li>
</ul>
<hr>
<h2 id="14-what-you-might-have-missed">14) What You Might Have Missed</h2>
<ul>
<li><strong>Quarantine flows</strong> with reason codes.</li>
<li><strong>PII handling</strong>: column‑level masking (views) + UC privileges; store hashes/salts if needed.</li>
<li><strong>Idempotent reprocessing</strong> by <code>batch_id</code> or <code>ingest_ts</code> windows.</li>
<li><strong>Schema evolution</strong> policy: allow additive only in raw/rawint; controlled evolution in curated.</li>
<li><strong>Backfill strategy</strong> separate from incremental.</li>
<li><strong>Vacuum retention</strong> policy aligned to recovery/RPO.</li>
<li><strong>Dev/Stg/Prod</strong> isolation via separate catalogs &amp; volumes.</li>
</ul>
<hr>
<h2 id="15-minimal-endtoend-flow-checklist">15) Minimal End‑to‑End Flow (Checklist)</h2>
<ol>
<li><strong>Create UC</strong> catalog/schemas and ADLS volumes; set grants.</li>
<li><strong>Define ADLS landing taxonomy</strong> per domain/source/entity.</li>
<li><strong>Implement Auto Loader</strong> (landing→raw) with checkpoints &amp; schema locations.</li>
<li><strong>Add validations</strong> (raw→rawint) + rejects/quarantine + metrics.</li>
<li><strong>Deduplicate &amp; standardize</strong> (rawint→curated).</li>
<li><strong>Implement SCD2</strong> dimensions and load <strong>facts</strong> (curated→enriched).</li>
<li><strong>Optimize</strong> tables and set maintenance (OPTIMIZE, VACUUM).</li>
<li><strong>Schedule jobs</strong>, retries, and alerts.</li>
<li><strong>Monitor</strong> with metrics dashboards &amp; UC lineage.</li>
</ol>
<hr>
<h2 id="16-quick-scd2-example-complete">16) Quick SCD2 Example (Complete)</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 1) Clean latest changes per key from rawint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">v_latest</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span><span class="w"> </span><span class="p">(</span><span class="n">rn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">source_mod_ts</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">ingest_ts</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_rawint</span><span class="p">.</span><span class="n">customer_clean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 2) Stage with hash diffs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">v_stage</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sha2</span><span class="p">(</span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)),</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">v_latest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 3) Merge into SCD2 dim
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="n">tgt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USING</span><span class="w"> </span><span class="n">v_stage</span><span class="w"> </span><span class="n">src</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">is_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">valid_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">(),</span><span class="w"> </span><span class="n">tgt</span><span class="p">.</span><span class="n">is_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">valid_from</span><span class="p">,</span><span class="w"> </span><span class="n">valid_to</span><span class="p">,</span><span class="w"> </span><span class="n">is_current</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="k">current_timestamp</span><span class="p">(),</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">(</span><span class="s1">&#39;9999-12-31&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">true</span><span class="p">);</span></span></span></code></pre></div>
<hr>
<h2 id="17-housekeeping-snippets">17) Housekeeping Snippets</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Optimize &amp; clean
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">OPTIMIZE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">VACUUM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="n">RETAIN</span><span class="w"> </span><span class="mi">168</span><span class="w"> </span><span class="n">HOURS</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Table properties (enable auto tuning)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">catalog</span><span class="o">&gt;</span><span class="p">.</span><span class="n">sales_curated</span><span class="p">.</span><span class="n">dim_customer</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">TBLPROPERTIES</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s1">&#39;delta.autoOptimize.optimizeWrite&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s1">&#39;delta.autoOptimize.autoCompact&#39;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<hr>
<h3 id="final-notes">Final Notes</h3>
<ul>
<li>The correct term is <strong>Medallion</strong> (not <em>medtallion</em>). The <code>rawint</code> layer is optional; it’s useful to isolate validation from business modeling.</li>
<li>Consider <strong>DLT</strong> for declarative pipelines (expectations + lineage) if you want fewer custom notebooks; patterns above map 1:1 to DLT.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="sql-theory">SQL Theory</h1>

<h2 id="1-what-is-sql-and-what-is-it-used-for">1. What is <em>SQL</em> and what is it used for?</h2>
<p><strong>SQL</strong> (<strong>Structured Query Language</strong>) is a domain-specific, declarative programming language designed for managing relational databases. It is the primary language for tasks like data retrieval, data manipulation, and database administration.</p>
<h3 id="core-components">Core Components</h3>
<ul>
<li><strong>DDL</strong> (Data Definition Language): Used for defining and modifying the structure of the database.</li>
<li><strong>DML</strong> (Data Manipulation Language): Deals with adding, modifying, and removing data in the database.</li>
<li><strong>DCL</strong> (Data Control Language): Manages the permissions and access rights of the database.</li>
<li><strong>TCL</strong> (Transaction Control Language): Governs the transactional management of the database, such as commits or rollbacks.</li>
</ul>
<h3 id="common-database-management-tasks">Common Database Management Tasks</h3>
<p><strong>Data Retrieval and Reporting</strong>: Retrieve and analyze data, generate reports, and build dashboards.</p>
<p><strong>Data Manipulation</strong>: Insert, update, or delete records from tables. Powerful features like Joins and Subqueries enable complex operations.</p>
<p><strong>Data Integrity</strong>: Ensure data conform to predefined rules. Techniques like foreign keys, constraints, and triggers help maintain the integrity of the data.</p>
<p><strong>Data Security</strong>: Manage user access permissions and roles.</p>
<p><strong>Data Consistency</strong>: Enforce ACID properties (Atomicity, Consistency, Isolation, Durability) in database transactions.</p>
<p><strong>Data Backups and Recovery</strong>: Perform database backups and ensure data is restorable in case of loss.</p>
<p><strong>Data Normalization</strong>: Design databases for efficient storage and reduce data redundancy.</p>
<p><strong>Indices and Performance Tuning</strong>: Optimize queries for faster data retrieval.</p>
<p><strong>Replication and Sharding</strong>: Advanced techniques for distributed systems.</p>
<h3 id="basic-sql-commands">Basic SQL Commands</h3>
<ul>
<li><strong>CREATE DATABASE</strong>: Used to create a new database.</li>
<li><strong>CREATE TABLE</strong>: Defines a new table.</li>
<li><strong>INSERT INTO</strong>: Adds a new record into a table.</li>
<li><strong>SELECT</strong>: Retrieves data from one or more tables.</li>
<li><strong>UPDATE</strong>: Modifies existing records.</li>
<li><strong>DELETE</strong>: Removes records from a table.</li>
<li><strong>ALTER TABLE</strong>: Modifies an existing table (e.g., adds a new column, renames an existing column, etc.).</li>
<li><strong>DROP TABLE</strong>: Deletes a table (along with its data) from the database.</li>
<li><strong>INDEX</strong>: Adds an index to a table for better performance.</li>
<li><strong>VIEW</strong>: Creates a virtual table that can be used for data retrieval.</li>
<li><strong>TRIGGER</strong>: Triggers a specified action when a database event occurs.</li>
<li><strong>PROCEDURE</strong> and <strong>FUNCTION</strong>: Store database logic for reuse and to simplify complex operations.</li>
</ul>
<h3 id="code-example-basic-sql-queries">Code Example: Basic SQL Queries</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Create a database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">Company</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Use Company database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">USE</span><span class="w"> </span><span class="n">Company</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Create tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DeptID</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DeptName</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">EmpID</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">EmpName</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">EmpDeptID</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">EmpDeptID</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">Department</span><span class="p">(</span><span class="n">DeptID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Insert data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="p">(</span><span class="n">DeptName</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Engineering&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="p">(</span><span class="n">DeptName</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="p">(</span><span class="n">EmpName</span><span class="p">,</span><span class="w"> </span><span class="n">EmpDeptID</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;John Doe&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="p">(</span><span class="n">EmpName</span><span class="p">,</span><span class="w"> </span><span class="n">EmpDeptID</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Jane Smith&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Select data from database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Perform an inner join to combine data from two tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">Employee</span><span class="p">.</span><span class="n">EmpID</span><span class="p">,</span><span class="w"> </span><span class="n">Employee</span><span class="p">.</span><span class="n">EmpName</span><span class="p">,</span><span class="w"> </span><span class="n">Department</span><span class="p">.</span><span class="n">DeptName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Employee</span><span class="p">.</span><span class="n">EmpDeptID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Department</span><span class="p">.</span><span class="n">DeptID</span><span class="p">;</span></span></span></code></pre></div>
<h2 id="2-describe-the-difference-between-sql-and-nosql-databases">2. Describe the difference between <em>SQL</em> and <em>NoSQL</em> databases.</h2>
<p><strong>SQL</strong> and <strong>NoSQL</strong> databases offer different paradigms, each designed to suit various types of data and data handling.</p>
<h3 id="top-level-differences">Top-Level Differences</h3>
<ul>
<li>
<p><strong>SQL</strong>: Primarily designed for structured (structured, semi-structured) data — data conforming to a predefined schema.</p>
</li>
<li>
<p><strong>NoSQL</strong>: Suited for unstructured or semi-structured data that evolves gradually, thereby supporting flexible schemas.</p>
</li>
<li>
<p><strong>SQL</strong>: Employs SQL (Structured Query Language) for data modification and retrieval.</p>
</li>
<li>
<p><strong>NoSQL</strong>: Offers various APIs (like the document and key-value store interfaces) for data operations; the use of structured query languages can vary across different NoSQL implementations.</p>
</li>
<li>
<p><strong>SQL</strong>: Often provides ACID (Atomicity, Consistency, Isolation, Durability) compliance to ensure data integrity.</p>
</li>
<li>
<p><strong>NoSQL</strong>: Databases are oftentimes optimized for high performance and horizontal scalability, with potential trade-offs in consistency.</p>
</li>
</ul>
<h3 id="common-nosql-database-types">Common NoSQL Database Types</h3>
<h4 id="document-stores">Document Stores</h4>
<ul>
<li><strong>Example</strong>: MongoDB, Couchbase</li>
<li><strong>Key Features</strong>: Each record is a self-contained document, typically formatted as JSON. Relationship between documents is established through embedded documents or references.
Example: Users and their blog posts could be encapsulated within a single document or linked via document references.</li>
</ul>
<h4 id="key-value-stores">Key-Value Stores</h4>
<ul>
<li><strong>Example</strong>: Redis, Amazon DynamoDB</li>
<li><strong>Key Features</strong>: Data is stored as a collection of unique keys and their corresponding values. No inherent structure or schema is enforced, providing flexibility in data content.
Example: Shopping cart items keyed by a user&rsquo;s ID.</li>
</ul>
<h4 id="wide-column-stores-column-families">Wide-Column Stores (Column Families)</h4>
<ul>
<li><strong>Example</strong>: Apache Cassandra, HBase</li>
<li><strong>Key Features</strong>: Data is grouped into column families, akin to tables in traditional databases. Each column family can possess a distinct set of columns, granting a high degree of schema flexibility.
Example: User profiles, where certain users might have additional or unique attributes.</li>
</ul>
<h4 id="graph-databases">Graph Databases</h4>
<ul>
<li><strong>Example</strong>: Neo4j, JanusGraph</li>
<li><strong>Key Features</strong>: Tailored for data with complex relationships. Data entities are represented as nodes, and relationships between them are visualized as edges.
Example: A social media platform could ensure efficient friend connections management.</li>
</ul>
<h3 id="data-modeling-differences">Data Modeling Differences</h3>
<ul>
<li><strong>SQL</strong>: Normalization is employed to minimize data redundancies and update anomalies.</li>
<li><strong>NoSQL</strong>: Data is often denormalized, packaging entities together to minimize the need for multiple queries.</li>
</ul>
<h3 id="auto-incrementing-ids">Auto-Incrementing IDs</h3>
<ul>
<li><strong>SQL</strong>: Often, each entry is assigned a unique auto-incrementing ID.</li>
<li><strong>NoSQL</strong>: The generation of unique IDs can be driven by external systems or even specific to individual documents within a collection.</li>
</ul>
<h3 id="handling-data-relationships">Handling Data Relationships</h3>
<ul>
<li><strong>SQL</strong>: Relationships between different tables are established using keys (e.g., primary, foreign).</li>
<li><strong>NoSQL</strong>: Relationships are handled either through embedded documents, referencing techniques, or as graph-like structures in dedicated graph databases.</li>
</ul>
<h3 id="transaction-support">Transaction Support</h3>
<ul>
<li><strong>SQL</strong>: Transactions (a series of operations that execute as a single unit) are standard.</li>
<li><strong>NoSQL</strong>: The concept and features of transactions can be more varied based on the specific NoSQL implementation.</li>
</ul>
<h3 id="data-consistency-levels">Data Consistency Levels</h3>
<ul>
<li><strong>SQL</strong>: Traditionally ensures strong consistency across the database to maintain data integrity.</li>
<li><strong>NoSQL</strong>: Offers various consistency models, ranging from strong consistency to eventual consistency. This flexibility enables performance optimizations in distributed environments.</li>
</ul>
<h3 id="scalability">Scalability</h3>
<ul>
<li><strong>SQL</strong>: Typically scales vertically, i.e., by upgrading hardware.</li>
<li><strong>NoSQL</strong>: Is often designed to scale horizontally, using commodity hardware across distributed systems.</li>
</ul>
<h3 id="data-flexibility">Data Flexibility</h3>
<ul>
<li><strong>SQL</strong>: Enforces a predefined, rigid schema, making it challenging to accommodate evolving data structures.</li>
<li><strong>NoSQL</strong>: Supports dynamic, ad-hoc schema updates for maximum flexibility.</li>
</ul>
<h3 id="data-integrity--validation">Data Integrity &amp; Validation</h3>
<ul>
<li><strong>SQL</strong>: Often relies on constraints and strict data types to ensure data integrity and validity.</li>
<li><strong>NoSQL</strong>: Places greater emphasis on the application layer to manage data integrity and validation.</li>
</ul>
<h2 id="3-what-are-the-different-types-of-sql-commands">3. What are the different types of <em>SQL commands</em>?</h2>
<p><strong>SQL</strong> commands fall into four primary categories: <strong>Data Query Language</strong> (DQL), <strong>Data Definition Language</strong> (DDL), <strong>Data Manipulation Language</strong> (DML), and <strong>Data Control Language</strong> (DCL).</p>
<h3 id="data-query-language-dql">Data Query Language (DQL)</h3>
<p>These commands focus on querying data within tables.</p>
<h4 id="keywords-and-examples">Keywords and Examples:</h4>
<ul>
<li><strong>SELECT</strong>: Retrieve data.</li>
<li><strong>FROM</strong>: Identify the source table.</li>
<li><strong>WHERE</strong>: Apply filtering conditions.</li>
<li><strong>GROUP BY</strong>: Group results based on specified fields.</li>
<li><strong>HAVING</strong>: Establish qualifying conditions for grouped data.</li>
<li><strong>ORDER BY</strong>: Arrange data based on one or more fields.</li>
<li><strong>LIMIT</strong>: Specify result count (sometimes replaces <code>SELECT TOP</code> for certain databases).</li>
<li><strong>JOIN</strong>: Bring together related data from multiple tables.</li>
</ul>
<h3 id="data-definition-language-ddl">Data Definition Language (DDL)</h3>
<p>DDL commands are for managing the structure of the database, including tables and constraints.</p>
<h4 id="keywords-and-examples-1">Keywords and Examples:</h4>
<ul>
<li><strong>CREATE TABLE</strong>: Generate new tables.</li>
<li><strong>ALTER TABLE</strong>: Modify existing tables.
<ul>
<li><strong>ADD</strong>, <strong>DROP</strong>: Incorporate or remove elements like columns, constraints, or properties.</li>
</ul>
</li>
<li><strong>CREATE INDEX</strong>: Establish indexes to improve query performance.</li>
<li><strong>DROP INDEX</strong>: Remove existing indexes.</li>
<li><strong>TRUNCATE TABLE</strong>: Delete all rows from a table, but the table structure remains intact.</li>
<li><strong>DROP TABLE</strong>: Delete tables from the database.</li>
</ul>
<h3 id="data-manipulation-language-dml">Data Manipulation Language (DML)</h3>
<p>These commands are useful for handling data within tables.</p>
<h4 id="keywords-and-examples-2">Keywords and Examples:</h4>
<ul>
<li><strong>INSERT INTO</strong>: Add new rows of data.
<ul>
<li><strong>SELECT</strong>: Copy data from another table or tables.</li>
</ul>
</li>
<li><strong>UPDATE</strong>: Modify existing data in a table.</li>
<li><strong>DELETE</strong>: Remove rows of data from a table.</li>
</ul>
<h3 id="data-control-language-dcl">Data Control Language (DCL)</h3>
<p>DCL is all about managing the access and permissions to database objects.</p>
<h4 id="keywords-and-examples-3">Keywords and Examples:</h4>
<ul>
<li><strong>GRANT</strong>: Assign permission to specified users or roles for specific database objects.</li>
<li><strong>REVOKE</strong>: Withdraw or remove these permissions previously granted.</li>
</ul>
<h2 id="4-explain-the-purpose-of-the-select-statement">4. Explain the purpose of the <em>SELECT</em> statement.</h2>
<p>The <strong>SELECT</strong> statement in SQL is fundamental to data retrieval and manipulation within relational databases. Its primary role is to precisely choose, transform, and organize data per specific business requirements.</p>
<h3 id="key-components-of-the-select-statement">Key Components of the SELECT Statement</h3>
<p>The <strong>SELECT</strong> statement typically comprises the following elements:</p>
<ul>
<li><strong>SELECT</strong>: Identifies the columns or expressions to be included in the result set.</li>
<li><strong>FROM</strong>: Specifies the table(s) from which the data should be retrieved.</li>
<li><strong>WHERE</strong>: Introduces conditional statements to filter rows based on specific criteria.</li>
<li><strong>GROUP BY</strong>: Aggregates data for summary or statistical reporting.</li>
<li><strong>HAVING</strong>: Functions like <strong>WHERE</strong>, but operates on aggregated data.</li>
<li><strong>ORDER BY</strong>: Defines the sort order for result sets.</li>
<li><strong>LIMIT</strong> or <strong>TOP</strong>: Limits the number of rows returned.</li>
</ul>
<h3 id="practical-applications-of-select">Practical Applications of SELECT</h3>
<p>The robust design of the <strong>SELECT</strong> statement empowers data professionals across diverse functions, enabling:</p>
<ul>
<li><strong>Data Exploration</strong>: Gaining insights through filtered views or aggregated summaries.</li>
<li><strong>Data Transformation</strong>: Creating new fields via operations such as concatenation or mathematical calculations.</li>
<li><strong>Data Validation</strong>: Verifying data against defined criteria.</li>
<li><strong>Data Reporting</strong>: Generating formatted outputs for business reporting needs.</li>
<li><strong>Data Consolidation</strong>: Bringing together information from multiple tables or databases.</li>
<li><strong>Data Export</strong>: Facilitating the transfer of query results to other systems or for data backup.</li>
</ul>
<p>Beyond these functions, proper utilization of the other components ensures efficiency and consistency working with relational databases.</p>
<h3 id="select-query-example">SELECT Query Example</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Orders</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Customers</span><span class="p">.</span><span class="n">CustomerName</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Orders</span><span class="p">.</span><span class="n">OrderDate</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">UnitPrice</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">Quantity</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Products</span><span class="p">.</span><span class="n">ProductName</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Employees</span><span class="p">.</span><span class="n">LastName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="n">Orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Customers</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">CustomerID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Customers</span><span class="p">.</span><span class="n">CustomerID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employees</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">EmployeeID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Employees</span><span class="p">.</span><span class="n">EmployeeID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">OrderDetails</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">OrderID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">OrderID</span></span></span></code></pre></div>
<h2 id="5-what-is-the-difference-between-where-and-having-clauses">5. What is the difference between <em>WHERE</em> and <em>HAVING</em> clauses?</h2>
<p><strong>WHERE</strong> and <strong>HAVING</strong> clauses are both used in SQL queries to filter data, but they operate in distinct ways.</p>
<h3 id="where-clause">WHERE Clause</h3>
<p>The <code>WHERE</code> clause is primarily used to filter records before they are grouped or aggregated. It&rsquo;s typically employed with non-aggregated fields or raw data.</p>
<h3 id="having-clause">HAVING Clause</h3>
<p>Conversely, the <code>HAVING</code> clause filters data <strong>after</strong> the grouping step, often in conjunction with aggregate functions like <code>SUM</code> or <code>COUNT</code>. This makes it useful for setting group-level conditions.</p>
<h2 id="6-define-what-a-join-is-in-sql-and-list-its-types">6. Define what a <em>JOIN</em> is in SQL and list its types.</h2>
<p><strong>Join</strong> operations in SQL are responsible for combining rows from multiple tables, primarily based on related columns that are established using a foreign key relationship.</p>
<p>The <strong>three common types of joins</strong> in SQL are:</p>
<ul>
<li><strong>Inner Join</strong></li>
<li><strong>Outer Join</strong>
<ul>
<li>Left Outer Join</li>
<li>Right Outer Join</li>
<li>Full Outer Join</li>
</ul>
</li>
<li><strong>Cross Join</strong></li>
<li><strong>Self Join</strong></li>
</ul>
<h3 id="inner-join">Inner Join</h3>
<p>Inner Join only returns rows where there is a match in both tables for the specified column(s).</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Table1:        Table2:            Result (Inner Join):

A   B         B    C               A    B    C
-   -         -    -               -    -    -
1  aa         aa   20              1   aa   20
2  bb         bb   30              2   bb   30
3  cc         cc   40    </code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Table1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="n">B</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="outer-join">Outer Join</h3>
<p>Outer Joins—whether left, right or full—include all records from one table (the &ldquo;left&rdquo; or the &ldquo;right&rdquo; table&quot;) and matched existing records from the other table. Unmatched records are filled with NULL values for missing columns from the other table.</p>
<h4 id="left-outer-join">Left Outer Join</h4>
<p>Left Outer Join (or simply Left Join) returns all records from the &ldquo;left&rdquo; table and the matched records from the &ldquo;right&rdquo; table.</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Table1:        Table2:            Result (Left Outer Join):

A   B         B    C               A    B    C
-   -         -    -               -    -    -
1  aa         aa   20              1   aa   20
2  bb         bb   30              2   bb   30
3  cc         NULL  NULL            3   cc  NULL</code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Table1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="n">B</span><span class="p">;</span></span></span></code></pre></div>
<h4 id="right-outer-join">Right Outer Join</h4>
<p>Right Outer Join (or Right Join) returns all records from the &ldquo;right&rdquo; table and the matched records from the &ldquo;left&rdquo; table.</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Table1:        Table2:            Result (Right Outer Join):

A   B         B    C               A    B    C
-   -         -    -               -    -    -
1  aa         aa   20              1   aa   20
2  bb         bb   30              2   bb   30
NULL NULL      cc   40             NULL NULL  40</code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Table1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="n">B</span><span class="p">;</span></span></span></code></pre></div>
<h4 id="full-outer-join">Full Outer Join</h4>
<p>Full Outer Join (or Full Join) returns all records when there is a match in either the left or the right table.</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Table1:        Table2:            Result (Full Outer Join):

A   B         B    C               A    B    C
-   -         -    -               -    -    -
1  aa         aa   20              1   aa   20
2  bb         bb   30              2   bb   30
3  cc         NULL  NULL            3   cc  NULL                           
NULL NULL      cc   40            NULL NULL  40</code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">COALESCE</span><span class="p">(</span><span class="n">Table1</span><span class="p">.</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Table1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FULL</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Table2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="n">B</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="cross-join">Cross Join</h3>
<p>A Cross Join, also known as a Cartesian Join, produces a result set that is the cartesian product of the two input sets. It will generate every possible combination of rows from both tables.</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Table1:        Table2:            Result (Cross Join):

A   B         C    D               A    B    C    D
-   -         -    -               -    -    -    -
1  aa        20    X               1   aa   20   X
2  bb        30    Y               1   aa   30   Y
3  cc        40    Z               1   aa   40   Z
                                    2   bb   20   X
                                    2   bb   30   Y
                                    2   bb   40   Z
                                    3   cc   20   X
                                    3   cc   30   Y
                                    3   cc   40   Z</code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Table1</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Table2</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Table1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Table2</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="self-join">Self Join</h3>
<p>A Self Join is when a table is joined with itself. This is used when a table has a relationship with itself, typically when it has a parent-child relationship.</p>
<p><strong>Visual Representation</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Employee:                              Result (Self Join):

EmpID   Name       ManagerID       EmpID  Name     ManagerID
-       -           -               -       -          -
1      John         3               1     John        3
2      Amy          3               2     Amy         3
3      Chris       NULL              3    Chris      NULL
4      Lisa        2                4     Lisa        2
5      Mike        2                5     Mike        2</code></pre></div>
<p><strong>SQL Query</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">E1</span><span class="p">.</span><span class="n">EmpID</span><span class="p">,</span><span class="w"> </span><span class="n">E1</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">E1</span><span class="p">.</span><span class="n">ManagerID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">E1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">E2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">E1</span><span class="p">.</span><span class="n">ManagerID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">E2</span><span class="p">.</span><span class="n">EmpID</span><span class="p">;</span></span></span></code></pre></div>
<h2 id="7-what-is-a-primary-key-in-a-database">7. What is a <em>primary key</em> in a database?</h2>
<p>A <strong>primary key</strong> in a database is a unique identifier for each record in a table.</p>
<h3 id="key-characteristics">Key Characteristics</h3>
<ul>
<li>
<p><strong>Uniqueness</strong>: Each value in the primary key column is unique, distinguishing every record.</p>
</li>
<li>
<p><strong>Non-Nullity</strong>: The primary key cannot be null, ensuring data integrity.</p>
</li>
<li>
<p><strong>Stability</strong>: It generally does not change throughout the record&rsquo;s lifetime, promoting consistency.</p>
</li>
</ul>
<h3 id="data-integrity-benefits">Data Integrity Benefits</h3>
<ul>
<li>
<p><strong>Entity Distinctness</strong>: Enforces that each record in the table represents a unique entity.</p>
</li>
<li>
<p><strong>Association Control</strong>: Helps manage relationships across tables and ensures referential integrity in foreign keys.</p>
</li>
</ul>
<h3 id="performance-advantages">Performance Advantages</h3>
<ul>
<li>
<p><strong>Efficient Indexing</strong>: Primary keys are often auto-indexed, making data retrieval faster.</p>
</li>
<li>
<p><strong>Optimized Joins</strong>: When the primary key links to a foreign key, query performance improves for related tables.</p>
</li>
</ul>
<h3 id="industry-best-practice">Industry Best Practice</h3>
<ul>
<li>
<p><strong>Pick a Natural Key</strong>: Whenever possible, choose existing data values that are unique and stable.</p>
</li>
<li>
<p><strong>Keep It Simple</strong>: Single-column primary keys are easier to manage.</p>
</li>
<li>
<p><strong>Avoid Data in Column Attributes</strong>: Using data can lead to bloat, adds complexity, and can be restrictive.</p>
</li>
<li>
<p><strong>Avoid Data Sensitivity</strong>: Decrease potential risks associated with sensitive data by separating it from keys.</p>
</li>
<li>
<p><strong>Evaluate Multi-Column Keys Carefully</strong>: Identify and justify the need for such complexity.</p>
</li>
</ul>
<h3 id="code-example-declaring-a-primary-key">Code Example: Declaring a Primary Key</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Students</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">student_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">grade_level</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<h2 id="8-explain-what-a-foreign-key-is-and-how-it-is-used">8. Explain what a <em>foreign key</em> is and how it is used.</h2>
<p>A <strong>foreign key</strong> (FK) is a column or a set of columns in a table that uniquely identifies a row or a set of rows in another table. It establishes a relationship between two tables, often referred to as the <strong>parent table</strong> and the <strong>child table</strong>.</p>
<h3 id="key-functions-of-a-foreign-key">Key Functions of a Foreign Key</h3>
<ul>
<li>
<p><strong>Data Integrity</strong>: Assures that each entry in the referencing table has a corresponding record in the referenced table, ensuring the data&rsquo;s accuracy and reliability.</p>
</li>
<li>
<p><strong>Relationship Mapping</strong>: Defines logical connections between tables that can be used to retrieve related data.</p>
</li>
<li>
<p><strong>Action Propagation</strong>: Specify what action should be taken in the child table when a matching record in the parent table is created, updated, or deleted.</p>
</li>
<li>
<p><strong>Cascade Control</strong>: Allows operations like deletion or updates to propagate to related tables, maintaining data consistency.</p>
</li>
</ul>
<h3 id="foreign-key-constraints">Foreign Key Constraints</h3>
<p>The database ensures the following with foreign key constraints:</p>
<ul>
<li>
<p><strong>Uniqueness</strong>: The referencing column or combination of columns in the child table is unique.</p>
</li>
<li>
<p><strong>Consistency</strong>: Each foreign key in the child table either matches a corresponding primary key or unique key in the parent table or contains a null value.</p>
</li>
</ul>
<h3 id="use-cases-and-best-practices">Use Cases and Best Practices</h3>
<ul>
<li>
<p><strong>Data Integrity and Consistency</strong>: FKs ensure that references between tables are valid and up-to-date. For instance, a sales entry references a valid product ID and a customer ID.</p>
</li>
<li>
<p><strong>Relationship Representation</strong>: FKs depict relationships between tables, such as &lsquo;One-to-Many&rsquo; (e.g., one department in a company can have multiple employees) or &lsquo;Many-to-Many&rsquo; (like in associative entities).</p>
</li>
<li>
<p><strong>Querying Simplification</strong>: They aid in performing joined operations to retrieve related data, abstracting away complex data relationships.</p>
</li>
</ul>
<h3 id="code-example-creating-a-foreign-key-relationship">Code Example: Creating a Foreign Key Relationship</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Create the parent (referenced) table first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Add a foreign key reference to the child table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">department_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">departments</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<h2 id="9-how-can-you-prevent-sql-injections">9. How can you prevent <em>SQL injections</em>?</h2>
<p><strong>SQL injection</strong> occurs when untrusted data is mixed with SQL commands. To prevent these attacks, use <strong>parameterized queries</strong> and input validation.</p>
<p>Here are specific methods to guard against SQL injection:</p>
<h3 id="parameterized-queries">Parameterized Queries</h3>
<ul>
<li>
<p><strong>Description</strong>: Also known as a prepared statement, it separates SQL code from user input, rendering direct command injection impossible.</p>
</li>
<li>
<p><strong>Code Example</strong>:</p>
<ul>
<li>Java (JDBC):</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;SELECT * FROM users WHERE username = ? AND password = ?&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">con</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="n">query</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ps</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ps</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ps</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">();</span></span></span></code></pre></div>
<ul>
<li>Python (MySQL):</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT * FROM users WHERE username = </span><span class="si">%s</span><span class="s2"> AND password = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span></span></span></code></pre></div>
</li>
<li>
<p><strong>Benefits</strong>:</p>
<ul>
<li>Improved security.</li>
<li>Reliability across different databases.</li>
<li>No need for manual escaping.</li>
</ul>
</li>
</ul>
<h3 id="stored-procedures">Stored Procedures</h3>
<ul>
<li>
<p><strong>Description</strong>: Allows the database to pre-compile and store your SQL code, providing a layer of abstraction between user input and database operations.</p>
</li>
<li>
<p><strong>Code Example</strong>:</p>
<ul>
<li>With MySQL:
<ul>
<li>Procedure definition:</li>
</ul>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">login</span><span class="p">(</span><span class="k">IN</span><span class="w"> </span><span class="n">p_username</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">p_password</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_username</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_password</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span></span></span></code></pre></div>
<ul>
<li>Calling the procedure:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">cursor</span><span class="o">.</span><span class="n">callproc</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span></span></span></code></pre></div>
</li>
<li>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Reduction of code redundancy.</li>
<li>Allows for granular permissions.</li>
<li>Can improve performance through query plan caching.</li>
</ul>
</li>
</ul>
<h3 id="input-validation">Input Validation</h3>
<ul>
<li>
<p><strong>Description</strong>: Examine user-supplied data to ensure it meets specific criteria before allowing it in a query.</p>
</li>
<li>
<p><strong>Code Example</strong>:
Using regex:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="s2">&#34;^[A-Za-z0-9_-]*$&#34;</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Invalid username format&#34;</span><span class="p">)</span></span></span></code></pre></div>
</li>
<li>
<p><strong>Drawbacks</strong>:</p>
<ul>
<li>Not a standalone method for preventing SQL injection.</li>
<li>Might introduce false positives, limiting the user&rsquo;s input freedom.</li>
</ul>
</li>
</ul>
<h3 id="code-filtering">Code Filtering</h3>
<ul>
<li>
<p><strong>Description</strong>: Sanitize incoming data based on its type, like strings or numbers. This approach works best in conjunction with other methods.</p>
</li>
<li>
<p><strong>Code Example</strong>:
In Python:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">username</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;[^a-zA-Z0-9_-]&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span></span></span></code></pre></div>
</li>
<li>
<p><strong>Considerations</strong>:</p>
<ul>
<li>Still necessitates additional measures for robust security.</li>
<li>Can restrict legitimate user input.</li>
</ul>
</li>
</ul>
<h2 id="10-what-is-normalization-explain-with-examples">10. What is <em>normalization</em>? Explain with examples.</h2>
<p><strong>Normalization</strong> is a database design method, refining table structures to reduce data redundancy and improve data integrity. It is a multi-step process, divided into five normal forms (1NF, 2NF, 3NF, BCNF, 4NF), each with specific rules.</p>
<h3 id="normalization-in-action">Normalization in Action</h3>
<p>Let&rsquo;s consider a simplistic &ldquo;Customer Invoices&rdquo; scenario, starting from an unnormalized state:</p>
<h4 id="unnormalized-table-0nf">Unnormalized Table (0NF)</h4>
<table>
  <thead>
      <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Invoice No.</th>
          <th>Invoice Date</th>
          <th>Item No.</th>
          <th>Description</th>
          <th>Quantity</th>
          <th>Unit Price</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>In this initial state, all data is stored in a single table without structural cohesion. Each record is a mix of customer and invoice information. This can lead to data redundancy and anomalies.</p>
<h4 id="first-normal-form-1nf">First Normal Form (1NF)</h4>
<p>To reach 1NF, ensure <strong>all cells are atomic</strong>, meaning they hold single values. Make separate tables for related groups of data. In our example, let&rsquo;s separate customer details from invoices and address multiple items on a single invoice.</p>
<h5 id="customer-details-table">Customer Details Table</h5>
<table>
  <thead>
      <tr>
          <th>ID</th>
          <th>Name</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h5 id="invoices-table">Invoices Table</h5>
<table>
  <thead>
      <tr>
          <th>Invoice No.</th>
          <th>Customer_ID</th>
          <th>Invoice Date</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h5 id="items-table">Items Table</h5>
<table>
  <thead>
      <tr>
          <th>Invoice No.</th>
          <th>Item No.</th>
          <th>Description</th>
          <th>Quantity</th>
          <th>Unit Price</th>
      </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<p>Now, each table focuses on specific data, unique to 1NF.</p>
<p>1NF is crucial for efficient database operations, especially for tasks like reporting and maintenance.</p>
<h4 id="second-normal-form-2nf">Second Normal Form (2NF)</h4>
<p>To achieve 2NF, consider the context of a complete data entry. <strong>Each non-key column should be dependent on the whole primary key</strong>.</p>
<p>In our example, the Items table already satisfies 2NF, as all non-key columns, like <code>Description</code> and <code>Unit Price</code>, depend on the entire primary key, formed by <code>Invoice No.</code> and <code>Item No.</code> together.</p>
<h4 id="third-normal-form-3nf">Third Normal Form (3NF)</h4>
<p>For 3NF compliance, <strong>there should be no transitive dependencies</strong>. Non-key columns should rely only on the primary key.</p>
<p>The Invoices table requires further refinement:</p>
<h5 id="updated-invoices-table">Updated Invoices Table</h5>
<table>
  <thead>
      <tr>
          <th>Invoice No.</th>
          <th>Customer_ID</th>
          <th>Invoice Date</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>Here, <code>Customer_ID</code> is the sole attribute associated with the customer.</p>
<h3 id="practical-implications">Practical Implications</h3>
<ul>
<li>Higher normal forms provide <strong>stronger</strong> data integrity but might be harder to maintain during regular data operations.</li>
<li>Consider your specific application needs when determining the target normal form.</li>
</ul>
<h3 id="real-world-usage">Real-World Usage</h3>
<ul>
<li>Many databases aim for 3NF.</li>
<li>In scenarios requiring exhaustive data integrity, 4NF, and sometimes beyond, are appropriate.</li>
</ul>
<h3 id="code-example-implementing-3nf">Code Example: Implementing 3NF</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Create Customer and Invoices Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Customers</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ID</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Invoices</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">InvoiceNo</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Customer_ID</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">InvoiceDate</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">Customer_ID</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">Customers</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Create Items Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Items</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">InvoiceNo</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ItemNo</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Description</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Quantity</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">UnitPrice</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">InvoiceNo</span><span class="p">,</span><span class="w"> </span><span class="n">ItemNo</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">InvoiceNo</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">Invoices</span><span class="p">(</span><span class="n">InvoiceNo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<p>This code demonstrates the specified 3NF structure with distinct tables for Customer, Invoices, and Items, ensuring data integrity during operations.</p>
<h2 id="11-describe-the-concept-of-denormalization-and-when-you-would-use-it">11. Describe the concept of <em>denormalization</em> and when you would use it.</h2>
<p><strong>Denormalization</strong> involves optimizing database performance by reducing redundancy at the cost of some data integrity.</p>
<h3 id="common-techniques-for-denormalization">Common Techniques for Denormalization</h3>
<ol>
<li>
<p><strong>Flattening Relationships</strong>:</p>
<ul>
<li>Combining related tables to minimize joins.</li>
<li>Example: <code>Order</code> and <code>Product</code> tables are merged, eliminating the many-to-many relationship.</li>
</ul>
</li>
<li>
<p><strong>Aggregating Data</strong>:</p>
<ul>
<li>Precomputing derived values to minimize costly calculations.</li>
<li>Example: a <code>Sales_Total</code> column in an <code>Order</code> table.</li>
</ul>
</li>
<li>
<p><strong>Adding Additional Redundant Data</strong>:</p>
<ul>
<li>Replicating data from one table in another to reduce the need for joins.</li>
<li>Example: The <code>Customer</code> and <code>Sales</code> tables can both have a <code>Country</code> column, even though the country is indirectly linked through the <code>Customer</code> table.</li>
</ul>
</li>
</ol>
<h3 id="common-use-cases">Common Use Cases</h3>
<ul>
<li>
<p><strong>Reporting and Analytics</strong>:</p>
<ul>
<li>Companies often need to run complex reports that span numerous tables.</li>
<li>Denormalization can flatten these tables, making the reporting process more efficient.</li>
</ul>
</li>
<li>
<p><strong>High-Volume Transaction Systems</strong>:</p>
<ul>
<li>In systems where data consistency can be relaxed momentarily, denormalization can speed up operations.</li>
<li>It&rsquo;s commonly seen in e-commerce sites where a brief delay in updating the sales figures might be acceptable for faster checkouts and improved user experience.</li>
</ul>
</li>
<li>
<p><strong>Read-Mostly Applications</strong>:</p>
<ul>
<li>Systems that are heavy on data reads and relatively light on writes can benefit from denormalization.</li>
</ul>
</li>
<li>
<p><strong>Search- and Query-Intensive Applications</strong>:</p>
<ul>
<li>For example, search engines often store data in a denormalized format to enhance retrieval speed.</li>
</ul>
</li>
<li>
<p><strong>Partitioning Data</strong>:</p>
<ul>
<li>In distributed systems like Hadoop or NoSQL databases, data is often stored redundantly across multiple nodes for enhanced performance.</li>
</ul>
</li>
</ul>
<h3 id="considerations-and-trade-offs">Considerations and Trade-offs</h3>
<ul>
<li>
<p><strong>Performance vs. Consistency</strong>:</p>
<ul>
<li>Denormalization can boost performance but at the expense of data consistency.</li>
</ul>
</li>
<li>
<p><strong>Maintenance Challenges</strong>:</p>
<ul>
<li>Redundant data must be managed consistently, which can pose challenges.</li>
</ul>
</li>
<li>
<p><strong>Operational Simplicity</strong>:</p>
<ul>
<li>Sometimes, having a simple, denormalized structure can outweigh the benefits of granularity and normalization.</li>
</ul>
</li>
<li>
<p><strong>Query Flexibility</strong>:</p>
<ul>
<li>A normalized structure can be more flexible for ad-hoc queries and schema changes. Denormalized structures might require more effort to adapt to such changes.</li>
</ul>
</li>
</ul>
<h2 id="12-what-are-indexes-and-how-can-they-improve-query-performance">12. What are <em>indexes</em> and how can they improve query performance?</h2>
<p><strong>Indexes</strong> are essential in SQL to accelerate queries by providing quick data lookups.</p>
<h3 id="how-do-indexes-improve-performance">How Do Indexes Improve Performance?</h3>
<ul>
<li>
<p><strong>Faster Data Retrieval</strong>: Think of an index like a book&rsquo;s table of contents, which leads you right to the desired section.</p>
</li>
<li>
<p><strong>Sorted Data Access</strong>: With data logically ordered, lookups are more efficient.</p>
</li>
<li>
<p><strong>Reduces Disk I/O</strong>: Queries may read fewer data pages when using an index.</p>
</li>
<li>
<p><strong>Enhances Joins</strong>: Indexes help optimize join conditions, particularly in larger tables.</p>
</li>
<li>
<p><strong>Aggregates and Uniques</strong>: They can swiftly resolve aggregate functions and enforce data uniqueness.</p>
</li>
</ul>
<h3 id="index-types">Index Types</h3>
<ul>
<li><strong>B-Tree</strong>: Standard for most databases, arranges data in a balanced tree structure.</li>
<li><strong>Hash</strong>: Direct lookup based on a hash of the indexed column.</li>
<li><strong>Bitmap</strong>: Best used for columns with a low cardinality.</li>
<li><strong>R-Tree</strong>: Optimized for spatial data, such as maps.</li>
</ul>
<p>Different databases may offer additional specialized index types.</p>
<h3 id="when-to-use-carefully">When to Use Carefully</h3>
<p>Excessive or unnecessary indexing can:</p>
<ul>
<li><strong>Consume Resources</strong>: Indexes require disk space and upkeep during data modifications.</li>
<li><strong>Slow Down Writes</strong>: Each write operation might trigger updates to associated indexes.</li>
</ul>
<h3 id="best-practices">Best Practices</h3>
<ol>
<li><strong>Appropriate Index Count</strong>: Identify crucial columns and refrain from over-indexing.</li>
<li><strong>Monitor and Refactor</strong>: Regularly assess index performance and refine or remove redundant ones.</li>
<li><strong>Consistency</strong>: Ensure all queries access data in a consistent manner to take full advantage of indexes.</li>
<li><strong>Data Type Consideration</strong>: Certain data types are better suited for indexing than others.</li>
</ol>
<h3 id="types-of-keys">Types of Keys</h3>
<ul>
<li><strong>Primary Key</strong>: Uniquely identifies each record in a table.</li>
<li><strong>Foreign Key</strong>: Establishes a link between tables, enforcing referential integrity.</li>
<li><strong>Compound Key</strong>: Combines two or more columns to form a unique identifier.</li>
</ul>
<h2 id="13-explain-the-purpose-of-the-group-by-clause">13. Explain the purpose of the <em>GROUP BY</em> clause.</h2>
<p>The <strong>GROUP BY</strong> clause in SQL serves to consolidate data and perform operations across groups of records.</p>
<h3 id="key-functions">Key Functions</h3>
<ul>
<li><strong>Data Aggregation</strong>: Collapses rows into summary data.</li>
<li><strong>Filtering</strong>: Provides filtering criteria for groups.</li>
<li><strong>Calculated Fields</strong>: Allows computation on group-level data.</li>
</ul>
<h3 id="usage-examples">Usage Examples</h3>
<p>Consider a <code>Sales</code> table with the following columns: <code>Product</code>, <code>Region</code>, and <code>Amount</code>.</p>
<h4 id="data-aggregation">Data Aggregation</h4>
<p>For data aggregation, we use aggregate functions such as <code>SUM</code>, <code>AVG</code>, <code>COUNT</code>, <code>MIN</code>, or <code>MAX</code>.</p>
<p>The query below calculates total sales by region:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TotalSales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Region</span><span class="p">;</span></span></span></code></pre></div>
<h4 id="filtering">Filtering</h4>
<p>The <strong>GROUP BY</strong> clause can include conditional statements. For example, to count only those sales that exceed $100 in amount:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">SalesAbove100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">Amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Region</span><span class="p">;</span></span></span></code></pre></div>
<h4 id="calculated-fields">Calculated Fields</h4>
<p>You can compute derived values for groups. For instance, to find what proportion each product contributes to the overall sales in a region, use this query:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">Amount</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Sales</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">Region</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">RelativeContribution</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Sales</span><span class="w"> </span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="performance-considerations">Performance Considerations</h3>
<p>Efficient database design aims to balance query performance with storage requirements. Aggregating data during retrieval can optimize performance, especially when dealing with huge datasets.</p>
<p>It&rsquo;s essential to verify these calculations for accuracy, as improper data handling can lead to skewed results.</p>
<h2 id="14-what-is-a-subquery-and-when-would-you-use-one">14. What is a <em>subquery</em>, and when would you use one?</h2>
<p><strong>Subqueries</strong> are embedded SQL select statements that provide inputs for an outer query. They can perform various tasks, such as filtering and aggregate computations. <strong>Subqueries</strong> can also be useful for complex join conditions, self-joins, and more.</p>
<h3 id="common-subquery-types">Common Subquery Types</h3>
<h4 id="scalar-subquery">Scalar Subquery</h4>
<p>A <strong>Scalar Subquery</strong> returns a single value. They&rsquo;re frequently used for comparisons—like <code>&gt;</code>, <code>=</code>, or <code>IN</code>.</p>
<p>Examples:</p>
<ul>
<li>
<p>Getting the <strong>maximum</strong> value:</p>
<ul>
<li><code>SELECT col1 FROM table1 WHERE col1 = (SELECT MAX(col1) FROM table1);</code></li>
</ul>
</li>
<li>
<p>Checking existence:</p>
<ul>
<li><code>SELECT col1, col2 FROM table1 WHERE col1 = (SELECT col1 FROM table2 WHERE condition);</code></li>
</ul>
</li>
<li>
<p>Using <strong>aggregates</strong>:</p>
<ul>
<li><code>SELECT col1 FROM table1 WHERE col1 = (SELECT SUM(col2) FROM table2);</code></li>
</ul>
</li>
</ul>
<h4 id="table-subquery">Table Subquery</h4>
<p>A <strong>Table Subquery</strong> is like a temporary table. It returns rows and columns and can be treated as a regular table for further processing.</p>
<p>Examples:</p>
<ul>
<li>
<p>Filtering data:</p>
<ul>
<li><code>SELECT * FROM table1 WHERE col1 IN (SELECT col1 FROM table2 WHERE condition);</code></li>
</ul>
</li>
<li>
<p>Data deduplication:</p>
<ul>
<li><code>SELECT DISTINCT col1 FROM table1 WHERE condition1 AND col1 IN (SELECT col1 FROM table2 WHERE condition2);</code></li>
</ul>
</li>
</ul>
<h3 id="advantages-of-using-subqueries">Advantages of Using Subqueries</h3>
<ul>
<li>
<p><strong>Simplicity</strong>: They offer cleaner syntax, especially for complex queries.</p>
</li>
<li>
<p><strong>Structured Data</strong>: Subqueries can ensure that intermediate data is properly processed, making them ideal for multi-step tasks.</p>
</li>
<li>
<p><strong>Reduced Code Duplication</strong>: By encapsulating certain logic within a subquery, you can avoid repetitive code.</p>
</li>
<li>
<p><strong>Dynamic Filtering</strong>: The data returned by a subquery can dynamically influence the scope of the outer query.</p>
</li>
<li>
<p><strong>Milestone Calculations</strong>: For long and complex queries, subqueries can provide clarity and help break down the logic into manageable parts.</p>
</li>
</ul>
<h3 id="limitations-and-optimization">Limitations and Optimization</h3>
<ul>
<li>
<p><strong>Performance</strong>: Subqueries can sometimes be less efficient. Advanced databases like Oracle, SQL Server, and PostgreSQL offer optimizations, but it&rsquo;s essential to monitor query performance.</p>
</li>
<li>
<p><strong>Versatility</strong>: While subqueries are powerful, they can be less flexible in some scenarios compared to other advanced features like Common Table Expressions (CTEs) and Window Functions.</p>
</li>
<li>
<p><strong>Understanding and Debugging</strong>: Nested logic might make a stored procedure or more advanced techniques like CTEs easier to follow and troubleshoot.</p>
</li>
</ul>
<h3 id="code-example-using-subqueries">Code Example: Using Subqueries</h3>
<p>Here is the SQL code:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Assuming you have table1 and table2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Scalar Subquery Example
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">col1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">col1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">col1</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Table Subquery Example
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">col1</span><span class="p">,</span><span class="w"> </span><span class="n">col2</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">col1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">col1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span><span class="p">);</span></span></span></code></pre></div>
<h2 id="15-describe-the-functions-of-the-order-by-clause">15. Describe the functions of the <em>ORDER BY</em> clause.</h2>
<p>The <strong>ORDER BY</strong> clause in SQL serves to sort the result set based on specified columns, in either ascending (<strong>ASC</strong>, default) or descending (<strong>DESC</strong>) order. It&rsquo;s often used in conjunction with various SQL statements like <strong>SELECT</strong> or <strong>UNION</strong> to enhance result presentation.</p>
<h3 id="key-features">Key Features</h3>
<ul>
<li><strong>Column-Specific Sorting</strong>: You can designate one or more columns as the basis for sorting. For multiple columns, the order of precedence is from left to right.</li>
<li><strong>ASC and DESC Directives</strong>: These allow for both ascending and descending sorting. If neither is specified, it defaults to ascending.</li>
</ul>
<h3 id="use-cases">Use Cases</h3>
<ul>
<li>
<p><strong>Top-N Queries</strong>: Selecting a specific number of top or bottom records can be accomplished using <strong>ORDER BY</strong> along with <strong>LIMIT</strong> or <strong>OFFSET</strong>.</p>
</li>
<li>
<p><strong>Trends Identification</strong>: With <strong>ORDER BY</strong>, you can identify trends or patterns in your data, such as ranking by sales volume or time-based sequences.</p>
</li>
<li>
<p><strong>Improved Data Presentation</strong>: By sorting records in a logical order, you can enhance the visual appeal and comprehension of your data representations.</p>
</li>
</ul>
<h3 id="code-example-order-by-multiple-columns-and-limit-results">Code Example: Order by Multiple Columns and Limit Results</h3>
<p>Let&rsquo;s say you have a &ldquo;sales&rdquo; table with columns <code>product_name</code>, <code>sale_date</code>, and <code>units_sold</code>. You want to fetch the top 3 products that sold the most units on a specific date, sorted by units sold (in descending order) and product name (in ascending order).</p>
<p>Here is the SQL query:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">product_name</span><span class="p">,</span><span class="w"> </span><span class="n">sale_date</span><span class="p">,</span><span class="w"> </span><span class="n">units_sold</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sale_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2022-01-15&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">units_sold</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span></span></span></code></pre></div>
<p>The expected result will show the top 3 products with the highest units sold on the given date. If two products have the same number of units sold, they will be sorted in alphabetical order by their names.</p>
<h3 id="sql-server-specific-order-by-column-position">SQL Server Specific: Order by Column Position</h3>
<p>In <strong>SQL Server</strong>, you can also use the column position in the ORDER BY clause. For example, instead of using column names, you can use 1 for the first column, 2 for the second, and so on. This syntax:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">product_name</span><span class="p">,</span><span class="w"> </span><span class="n">sale_date</span><span class="p">,</span><span class="w"> </span><span class="n">units_sold</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sale_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2022-01-15&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span></span></span></code></pre></div>
<p>performs the same operation as the previous example.</p>
<h3 id="mysql-specific-random-order">MySQL Specific: Random Order</h3>
<p>In <strong>MySQL</strong>, you can reorder the results in a random sequence. This can be useful, for instance, in a quiz app to randomize the order of questions. The <strong>ORDER BY</strong> clause with the <strong>RAND()</strong> function looks like this:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">product_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RAND</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="100-sql-queries">100 SQL Queries</h1>

<p>This cheat sheet provides a quick reference to common SQL queries and concepts used in data analysis, from fundamental commands to advanced techniques.</p>
<hr>
<h2 id="section-1-basic-queries-110">Section 1: Basic Queries (1–10)</h2>
<p>Use these to select and filter data from a table.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 1. Select all columns from a table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 2. Select specific columns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 3. Count all rows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 4. Count non-null values in a column
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 5. Find unique values in a column
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 6. Filter data using WHERE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 7. Filter with multiple conditions using AND
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 8. Filter with multiple conditions using OR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 9. Combine AND and OR with parentheses
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 10. Exclude a value using NOT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-2-filtering--pattern-matching-1120">Section 2: Filtering &amp; Pattern Matching (11–20)</h2>
<p>Advanced filtering using IN, BETWEEN, and LIKE.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 11. Filter by a list of values using IN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 12. Exclude a list of values using NOT IN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 13. Filter values within a range using BETWEEN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">75000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 14. Case-insensitive substring search
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">ILIKE</span><span class="w"> </span><span class="s1">&#39;%jo%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 15. Starts with a specific pattern
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Smi%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 16. Ends with a specific pattern
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@gmail.com&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 17. Pattern at a specific position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;_a%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 18. Find rows with NULL values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 19. Find rows with non-NULL values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 20. Filter by date range
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">&#39;2023-12-31&#39;</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-3-sorting--limiting-2130">Section 3: Sorting &amp; Limiting (21–30)</h2>
<p>Control the order of your results and limit the number of rows.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 21. Sort results in ascending order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 22. Sort results in descending order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 23. Sort by multiple columns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 24. Top 10 highest paid employees
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 25. Latest 5 hired employees
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 26. DISTINCT and ORDER BY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 27. Fetch rows 11–20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 28. Employee with the highest salary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 29. Second-highest salary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 30. Order by a calculated field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bonus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">bonus</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-4-aggregation--grouping-3140">Section 4: Aggregation &amp; Grouping (31–40)</h2>
<p>Summarize and analyze data with aggregate functions.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 31. Count rows for each group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 32. Average salary per department
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 33. Total salary per department
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 34. Maximum salary in each department
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 35. Minimum salary in each department
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 36. Filter groups using HAVING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">65000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 37. Count employees in departments with more than 5 employees
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 38. Filter and then group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2022-01-01&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 39. Group by multiple columns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 40. Highest salary in each department (value)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-5-joins-4160">Section 5: Joins (41–60)</h2>
<p>Combine data from multiple tables.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 41. INNER JOIN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 42. LEFT JOIN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 43. LEFT JOIN to find rows in left table with no match in right
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 44. RIGHT JOIN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 45. FULL OUTER JOIN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 46. Join three tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 47. Self-Join (employee to manager)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 48. Join on a non-key column
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 49. CROSS JOIN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 50. LEFT JOIN with filtering (find products without sales)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">sale_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 51. Employees not assigned to any project
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 52. Projects without any employees assigned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 53. Total salary of each department, including departments with no employees
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 54. Number of employees in each department (including zero)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 55. Join based on multiple conditions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">last_purchase_date</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 56. Employees, their managers, and managers&#39; departments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 57. Non-equi join (range join)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">salary_grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">salary_grades</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">min_salary</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">max_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 58. Filter a joined table using WHERE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;New York&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 59. Aggregation on a joined table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 60. Join on common column with different names
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">table_a</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">table_b</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_id</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-6-subqueries-6175">Section 6: Subqueries (61–75)</h2>
<p>Use a query within another query.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 61. Subquery in WHERE (single value)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 62. Subquery in WHERE (multiple values)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;San Francisco&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 63. Subquery in FROM (derived table)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 64. Subquery in SELECT (scalar subquery)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">company_avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 65. Correlated subquery: higher than dept average
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 66. EXISTS to check existence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 67. NOT EXISTS to find non-matching rows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 68. Departments with at least one employee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 69. Employees who have placed an order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 70. Total salary for each department using a subquery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">AS</span><span class="w"> </span><span class="n">total_department_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 71. Department with the highest average salary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 72. Customers who ordered a specific product
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 73. Employees earning more than the average
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 74. Customers who have not placed an order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 75. Salary less than the average of their job title
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">job_title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span></span></span></code></pre></div>
<hr>
<h2 id="section-7-window-functions-7685">Section 7: Window Functions (76–85)</h2>
<p>Perform calculations across a set of table rows related to the current row.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 76. ROW_NUMBER()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 77. RANK()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 78. DENSE_RANK()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">DENSE_RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dense_rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 79. NTILE(n)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">NTILE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">quartile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 80. LEAD()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LEAD</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">next_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 81. LAG()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LAG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 82. Running total
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">running_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 83. Moving average (window = 3)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">moving_avg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 84. Top 3 employees in each department
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ranked_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 85. Percentage of total sales for each product
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">product_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percentage_of_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="p">;</span></span></span></code></pre></div>
<hr>
<h2 id="section-8-common-table-expressions-ctes--data-manipulation-86100">Section 8: Common Table Expressions (CTEs) &amp; Data Manipulation (86–100)</h2>
<p>Organize complex queries and modify data.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 86. Use a CTE to simplify a query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="n">da</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 87. INSERT INTO: Add a new row
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 88. UPDATE: Modify existing data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 89. DELETE: Remove rows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 90. TRUNCATE TABLE: Remove all rows quickly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">old_data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 91. UNION: Combine distinct rows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 92. UNION ALL: Combine including duplicates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 93. CASE statement for conditional logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;High Earner&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Mid-Range&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Junior&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salary_level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 94. Pivot data using CASE and GROUP BY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">department</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">high_salary_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">low_salary_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 95. CAST: Convert data type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 96. COALESCE: First non-null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">COALESCE</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No Email Provided&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 97. NULLIF: Returns NULL if equal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 98. Recursive CTE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">subordinates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 99. GROUPING SETS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">((</span><span class="n">department</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">job_title</span><span class="p">),</span><span class="w"> </span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 100. ROLLUP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">ROLLUP</span><span class="p">(</span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">);</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="sql-cheat-sheet">SQL cheat sheet</h1>

<h2 id="-data-manipulation-language-dml">🧩 Data Manipulation Language (DML)</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>SELECT</strong></td>
          <td>Retrieves data from a database.</td>
          <td><code>SELECT column1, column2 FROM table_name;</code></td>
          <td><code>SELECT first_name, last_name FROM customers;</code></td>
      </tr>
      <tr>
          <td><strong>INSERT</strong></td>
          <td>Adds new records to a table.</td>
          <td><code>INSERT INTO table_name (column1, column2) VALUES (value1, value2);</code></td>
          <td><code>INSERT INTO customers (first_name, last_name) VALUES ('Mary', 'Doe');</code></td>
      </tr>
      <tr>
          <td><strong>UPDATE</strong></td>
          <td>Modifies existing records in a table.</td>
          <td><code>UPDATE table_name SET column1 = value1, column2 = value2 WHERE condition;</code></td>
          <td><code>UPDATE employees SET employee_name = 'John Doe', department = 'Marketing';</code></td>
      </tr>
      <tr>
          <td><strong>DELETE</strong></td>
          <td>Removes records from a table.</td>
          <td><code>DELETE FROM table_name WHERE condition;</code></td>
          <td><code>DELETE FROM employees WHERE employee_name = 'John Doe';</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-data-definition-language-ddl">🏗️ Data Definition Language (DDL)</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CREATE</strong></td>
          <td>Creates a new database object (table, view, etc.).</td>
          <td><code>CREATE TABLE table_name (column1 datatype1, column2 datatype2, ...);</code></td>
          <td><code>CREATE TABLE employees (employee_id INT PRIMARY KEY, first_name VARCHAR(50), last_name VARCHAR(50), age INT);</code></td>
      </tr>
      <tr>
          <td><strong>ALTER</strong></td>
          <td>Adds, deletes, or modifies columns in an existing table.</td>
          <td><code>ALTER TABLE table_name ADD column_name datatype;</code></td>
          <td><code>ALTER TABLE customers ADD email VARCHAR(100);</code></td>
      </tr>
      <tr>
          <td><strong>DROP</strong></td>
          <td>Deletes an existing table or database object.</td>
          <td><code>DROP TABLE table_name;</code></td>
          <td><code>DROP TABLE customers;</code></td>
      </tr>
      <tr>
          <td><strong>TRUNCATE</strong></td>
          <td>Removes all rows from a table but keeps the structure.</td>
          <td><code>TRUNCATE TABLE table_name;</code></td>
          <td><code>TRUNCATE TABLE customers;</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-data-control-language-dcl">🔐 Data Control Language (DCL)</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>GRANT</strong></td>
          <td>Gives privileges to users or roles.</td>
          <td><code>GRANT SELECT, INSERT ON table_name TO user_name;</code></td>
          <td><code>GRANT SELECT, INSERT ON employees TO 'John Doe';</code></td>
      </tr>
      <tr>
          <td><strong>REVOKE</strong></td>
          <td>Removes privileges previously granted.</td>
          <td><code>REVOKE SELECT, INSERT ON table_name FROM user_name;</code></td>
          <td><code>REVOKE SELECT, INSERT ON employees FROM 'John Doe';</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-querying-data">🔍 Querying Data</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>SELECT Statement</strong></td>
          <td>Retrieves data from one or more tables.</td>
          <td><code>SELECT column1, column2 FROM table_name;</code></td>
          <td><code>SELECT first_name, last_name FROM customers;</code></td>
      </tr>
      <tr>
          <td><strong>WHERE Clause</strong></td>
          <td>Filters rows based on specific conditions.</td>
          <td><code>SELECT * FROM table_name WHERE condition;</code></td>
          <td><code>SELECT * FROM customers WHERE age &gt; 30;</code></td>
      </tr>
      <tr>
          <td><strong>ORDER BY Clause</strong></td>
          <td>Sorts the result set by one or more columns.</td>
          <td><code>SELECT * FROM table_name ORDER BY column_name ASC/DESC;</code></td>
          <td><code>SELECT * FROM products ORDER BY price DESC;</code></td>
      </tr>
      <tr>
          <td><strong>GROUP BY Clause</strong></td>
          <td>Groups rows sharing a property and is used with aggregates.</td>
          <td><code>SELECT column_name, COUNT(*) FROM table_name GROUP BY column_name;</code></td>
          <td><code>SELECT category, COUNT(*) FROM products GROUP BY category;</code></td>
      </tr>
      <tr>
          <td><strong>HAVING Clause</strong></td>
          <td>Filters grouped results (used with GROUP BY).</td>
          <td><code>SELECT column_name, COUNT(*) FROM table_name GROUP BY column_name HAVING condition;</code></td>
          <td><code>SELECT category, COUNT(*) FROM products GROUP BY category HAVING COUNT(*) &gt; 5;</code></td>
      </tr>
  </tbody>
</table>
<h2 id="-joining-commands">🔗 Joining Commands</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>INNER JOIN</strong></td>
          <td>Returns rows with matching values in both tables.</td>
          <td><code>SELECT * FROM table1 INNER JOIN table2 ON table1.column = table2.column;</code></td>
          <td><code>SELECT * FROM employees INNER JOIN departments ON employees.department_id = departments.id;</code></td>
      </tr>
      <tr>
          <td><strong>LEFT JOIN / LEFT OUTER JOIN</strong></td>
          <td>Returns all rows from the left table and matching rows from the right table.</td>
          <td><code>SELECT * FROM table1 LEFT JOIN table2 ON table1.column = table2.column;</code></td>
          <td><code>SELECT * FROM employees LEFT JOIN departments ON employees.department_id = departments.id;</code></td>
      </tr>
      <tr>
          <td><strong>RIGHT JOIN / RIGHT OUTER JOIN</strong></td>
          <td>Returns all rows from the right table and matching rows from the left table.</td>
          <td><code>SELECT * FROM table1 RIGHT JOIN table2 ON table1.column = table2.column;</code></td>
          <td><code>SELECT * FROM employees RIGHT JOIN departments ON employees.department_id = departments.department_id;</code></td>
      </tr>
      <tr>
          <td><strong>FULL JOIN / FULL OUTER JOIN</strong></td>
          <td>Returns all rows when there’s a match in either table.</td>
          <td><code>SELECT * FROM table1 FULL JOIN table2 ON table1.column = table2.column;</code></td>
          <td><code>sql SELECT * FROM employees LEFT JOIN departments ON employees.employee_id = departments.employee_id UNION SELECT * FROM employees RIGHT JOIN departments ON employees.employee_id = departments.employee_id; </code></td>
      </tr>
      <tr>
          <td><strong>CROSS JOIN</strong></td>
          <td>Combines every row from the first table with every row from the second (Cartesian product).</td>
          <td><code>SELECT * FROM table1 CROSS JOIN table2;</code></td>
          <td><code>SELECT * FROM employees CROSS JOIN departments;</code></td>
      </tr>
      <tr>
          <td><strong>SELF JOIN</strong></td>
          <td>Joins a table with itself.</td>
          <td><code>SELECT * FROM table1 t1, table1 t2 WHERE t1.column = t2.column;</code></td>
          <td><code>SELECT * FROM employees t1, employees t2 WHERE t1.employee_id = t2.employee_id;</code></td>
      </tr>
      <tr>
          <td><strong>NATURAL JOIN</strong></td>
          <td>Matches columns with the same name in both tables.</td>
          <td><code>SELECT * FROM table1 NATURAL JOIN table2;</code></td>
          <td><code>SELECT * FROM employees NATURAL JOIN departments;</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-subqueries-in-sql">🧮 Subqueries in SQL</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>IN</strong></td>
          <td>Checks if a value matches any in a subquery result.</td>
          <td><code>SELECT column(s) FROM table WHERE value IN (subquery);</code></td>
          <td><code>SELECT * FROM customers WHERE city IN (SELECT city FROM suppliers);</code></td>
      </tr>
      <tr>
          <td><strong>ANY</strong></td>
          <td>Compares a value to any returned by a subquery (used with =, &gt;, &lt;, etc.).</td>
          <td><code>SELECT column(s) FROM table WHERE value &lt; ANY (subquery);</code></td>
          <td><code>SELECT * FROM products WHERE price &lt; ANY (SELECT unit_price FROM supplier_products);</code></td>
      </tr>
      <tr>
          <td><strong>ALL</strong></td>
          <td>Compares a value to all values returned by a subquery.</td>
          <td><code>SELECT column(s) FROM table WHERE value &gt; ALL (subquery);</code></td>
          <td><code>SELECT * FROM orders WHERE order_amount &gt; ALL (SELECT total_amount FROM previous_orders);</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-aggregate-functions">📊 Aggregate Functions</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>COUNT()</strong></td>
          <td>Counts rows or non-null values in a column.</td>
          <td><code>SELECT COUNT(column_name) FROM table_name;</code></td>
          <td><code>SELECT COUNT(age) FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>SUM()</strong></td>
          <td>Calculates the sum of values in a column.</td>
          <td><code>SELECT SUM(column_name) FROM table_name;</code></td>
          <td><code>SELECT SUM(revenue) FROM sales;</code></td>
      </tr>
      <tr>
          <td><strong>AVG()</strong></td>
          <td>Calculates the average of values in a column.</td>
          <td><code>SELECT AVG(column_name) FROM table_name;</code></td>
          <td><code>SELECT AVG(price) FROM products;</code></td>
      </tr>
      <tr>
          <td><strong>MIN()</strong></td>
          <td>Returns the minimum value in a column.</td>
          <td><code>SELECT MIN(column_name) FROM table_name;</code></td>
          <td><code>SELECT MIN(price) FROM products;</code></td>
      </tr>
      <tr>
          <td><strong>MAX()</strong></td>
          <td>Returns the maximum value in a column.</td>
          <td><code>SELECT MAX(column_name) FROM table_name;</code></td>
          <td><code>SELECT MAX(price) FROM products;</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-string-functions">🔤 String Functions</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CONCAT()</strong></td>
          <td>Concatenates two or more strings.</td>
          <td><code>SELECT CONCAT(string1, string2, ...) AS concatenated_string FROM table_name;</code></td>
          <td><code>SELECT CONCAT(first_name, ' ', last_name) AS full_name FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>SUBSTRING() / SUBSTR()</strong></td>
          <td>Extracts a substring from a string.</td>
          <td><code>SELECT SUBSTRING(string FROM start_position [FOR length]) AS substring FROM table_name;</code></td>
          <td><code>SELECT SUBSTRING(product_name FROM 1 FOR 5) AS substring FROM products;</code></td>
      </tr>
      <tr>
          <td><strong>CHAR_LENGTH() / LENGTH()</strong></td>
          <td>Returns the number of characters in a string.</td>
          <td><code>SELECT CHAR_LENGTH(string) AS length FROM table_name;</code></td>
          <td><code>SELECT CHAR_LENGTH(product_name) AS length FROM products;</code></td>
      </tr>
      <tr>
          <td><strong>UPPER()</strong></td>
          <td>Converts all characters to uppercase.</td>
          <td><code>SELECT UPPER(string) AS uppercase_string FROM table_name;</code></td>
          <td><code>SELECT UPPER(first_name) AS uppercase_first_name FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>LOWER()</strong></td>
          <td>Converts all characters to lowercase.</td>
          <td><code>SELECT LOWER(string) AS lowercase_string FROM table_name;</code></td>
          <td><code>SELECT LOWER(last_name) AS lowercase_last_name FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>TRIM()</strong></td>
          <td>Removes specified prefixes, suffixes, or whitespace.</td>
          <td><code>SELECT TRIM([LEADING / TRAILING / BOTH] characters FROM string) AS trimmed_string FROM table_name;</code></td>
          <td><code>SELECT TRIM(TRAILING ' ' FROM full_name) AS trimmed_full_name FROM customers;</code></td>
      </tr>
      <tr>
          <td><strong>LEFT()</strong></td>
          <td>Returns characters from the left of a string.</td>
          <td><code>SELECT LEFT(string, num_characters) AS left_string FROM table_name;</code></td>
          <td><code>SELECT LEFT(product_name, 5) AS left_product_name FROM products;</code></td>
      </tr>
      <tr>
          <td><strong>RIGHT()</strong></td>
          <td>Returns characters from the right of a string.</td>
          <td><code>SELECT RIGHT(string, num_characters) AS right_string FROM table_name;</code></td>
          <td><code>SELECT RIGHT(order_number, 4) AS right_order_number FROM orders;</code></td>
      </tr>
      <tr>
          <td><strong>REPLACE()</strong></td>
          <td>Replaces occurrences of a substring within a string.</td>
          <td><code>SELECT REPLACE(string, old_substring, new_substring) AS replaced_string FROM table_name;</code></td>
          <td><code>SELECT REPLACE(description, 'old_string', 'new_string') AS replaced_description FROM product_descriptions;</code></td>
      </tr>
  </tbody>
</table>
<h2 id="-date-and-time-sql-commands">🕒 Date and Time SQL Commands</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CURRENT_DATE()</strong></td>
          <td>Returns the current date.</td>
          <td><code>SELECT CURRENT_DATE() AS current_date;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>CURRENT_TIME()</strong></td>
          <td>Returns the current time.</td>
          <td><code>SELECT CURRENT_TIME() AS current_time;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>CURRENT_TIMESTAMP()</strong></td>
          <td>Returns the current date and time.</td>
          <td><code>SELECT CURRENT_TIMESTAMP() AS current_timestamp;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>DATE_PART()</strong></td>
          <td>Extracts a specific part (year, month, day, etc.) from a date or time.</td>
          <td><code>SELECT DATE_PART('part', date_expression) AS extracted_part;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>DATE_ADD() / DATE_SUB()</strong></td>
          <td>Adds or subtracts a specified interval (days, months, years) to/from a date.</td>
          <td><code>SELECT DATE_ADD(date_expression, INTERVAL value unit) AS new_date;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>EXTRACT()</strong></td>
          <td>Extracts a specific component from a date or time.</td>
          <td><code>SELECT EXTRACT(part FROM date_expression) AS extracted_part;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>TO_CHAR()</strong></td>
          <td>Converts a date or time to a specific string format.</td>
          <td><code>SELECT TO_CHAR(date_expression, 'format') AS formatted_date;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>TIMESTAMPDIFF()</strong></td>
          <td>Calculates the difference between two timestamps in a specified unit.</td>
          <td><code>SELECT TIMESTAMPDIFF(unit, timestamp1, timestamp2) AS difference;</code></td>
          <td>—</td>
      </tr>
      <tr>
          <td><strong>DATEDIFF()</strong></td>
          <td>Returns the number of days between two dates.</td>
          <td><code>SELECT DATEDIFF(date1, date2) AS difference_in_days;</code></td>
          <td>—</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-conditional-expressions">⚙️ Conditional Expressions</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CASE Statement</strong></td>
          <td>Performs conditional logic within a query.</td>
          <td><code>sql SELECT column1, column2, CASE WHEN condition1 THEN result1 WHEN condition2 THEN result2 ELSE default_result END AS alias FROM table_name; </code></td>
          <td><code>sql SELECT order_id, total_amount, CASE WHEN total_amount &gt; 1000 THEN 'High Value Order' WHEN total_amount &gt; 500 THEN 'Medium Value Order' ELSE 'Low Value Order' END AS order_status FROM orders; </code></td>
      </tr>
      <tr>
          <td><strong>IF() Function</strong></td>
          <td>Evaluates a condition and returns a value based on the evaluation.</td>
          <td><code>SELECT IF(condition, true_value, false_value) AS alias FROM table_name;</code></td>
          <td><code>SELECT name, age, IF(age &gt; 50, 'Senior', 'Junior') AS employee_category FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>COALESCE() Function</strong></td>
          <td>Returns the first non-null value from a list.</td>
          <td><code>SELECT COALESCE(value1, value2, ...) AS alias FROM table_name;</code></td>
          <td><code>SELECT COALESCE(first_name, middle_name) AS preferred_name FROM employees;</code></td>
      </tr>
      <tr>
          <td><strong>NULLIF() Function</strong></td>
          <td>Returns NULL if two expressions are equal.</td>
          <td><code>SELECT NULLIF(expression1, expression2) AS alias FROM table_name;</code></td>
          <td><code>SELECT NULLIF(total_amount, discounted_amount) AS diff_amount FROM orders;</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-set-operations">🔁 Set Operations</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>UNION</strong></td>
          <td>Combines result sets of two or more <code>SELECT</code> statements (removes duplicates).</td>
          <td><code>sql SELECT column1, column2 FROM table1 UNION SELECT column1, column2 FROM table2; </code></td>
          <td><code>sql SELECT first_name, last_name FROM customers UNION SELECT first_name, last_name FROM employees; </code></td>
      </tr>
      <tr>
          <td><strong>INTERSECT</strong></td>
          <td>Returns common rows that appear in both result sets.</td>
          <td><code>sql SELECT column1, column2 FROM table1 INTERSECT SELECT column1, column2 FROM table2; </code></td>
          <td><code>sql SELECT first_name, last_name FROM customers INTERSECT SELECT first_name, last_name FROM employees; </code></td>
      </tr>
      <tr>
          <td><strong>EXCEPT</strong></td>
          <td>Returns rows from the first query that are not present in the second.</td>
          <td><code>sql SELECT column1, column2 FROM table1 EXCEPT SELECT column1, column2 FROM table2; </code></td>
          <td><code>sql SELECT first_name, last_name FROM customers EXCEPT SELECT first_name, last_name FROM employees; </code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-transaction-control-commands-tcl">💾 Transaction Control Commands (TCL)</h2>
<table>
  <thead>
      <tr>
          <th><strong>Command</strong></th>
          <th><strong>Description</strong></th>
          <th><strong>Syntax</strong></th>
          <th><strong>Example</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>COMMIT</strong></td>
          <td>Saves all the changes made during the current transaction and makes them permanent.</td>
          <td><code>COMMIT;</code></td>
          <td><code>sql BEGIN TRANSACTION; -- SQL statements and changes within the transaction INSERT INTO employees (name, age) VALUES ('Alice', 30); UPDATE products SET price = 25.00 WHERE category = 'Electronics'; COMMIT; </code></td>
      </tr>
      <tr>
          <td><strong>ROLLBACK</strong></td>
          <td>Undoes all the changes made during the current transaction and discards them.</td>
          <td><code>ROLLBACK;</code></td>
          <td><code>sql BEGIN TRANSACTION; -- SQL statements and changes within the transaction INSERT INTO employees (name, age) VALUES ('Bob', 35); UPDATE products SET price = 30.00 WHERE category = 'Electronics'; ROLLBACK; </code></td>
      </tr>
      <tr>
          <td><strong>SAVEPOINT</strong></td>
          <td>Sets a point within a transaction to which you can later roll back.</td>
          <td><code>SAVEPOINT savepoint_name;</code></td>
          <td><code>sql BEGIN TRANSACTION; INSERT INTO employees (name, age) VALUES ('Carol', 28); SAVEPOINT before_update; UPDATE products SET price = 40.00 WHERE category = 'Electronics'; SAVEPOINT after_update; DELETE FROM customers WHERE age &gt; 60; ROLLBACK TO before_update; -- DELETE is rolled back, but UPDATE remains COMMIT; </code></td>
      </tr>
      <tr>
          <td><strong>ROLLBACK TO SAVEPOINT</strong></td>
          <td>Rolls back the transaction to a specific savepoint without affecting prior operations.</td>
          <td><code>ROLLBACK TO SAVEPOINT savepoint_name;</code></td>
          <td><code>sql BEGIN TRANSACTION; INSERT INTO employees (name, age) VALUES ('David', 42); SAVEPOINT before_update; UPDATE products SET price = 50.00 WHERE category = 'Electronics'; SAVEPOINT after_update; DELETE FROM customers WHERE age &gt; 60; ROLLBACK TO SAVEPOINT before_update; -- UPDATE is rolled back, but INSERT remains COMMIT; </code></td>
      </tr>
      <tr>
          <td><strong>SET TRANSACTION</strong></td>
          <td>Configures properties for the current transaction, such as isolation level or mode.</td>
          <td><code>SET TRANSACTION [ISOLATION LEVEL { READ COMMITTED / SERIALIZABLE }];</code></td>
          <td><code>sql BEGIN TRANSACTION; -- Set isolation level to READ COMMITTED SET TRANSACTION ISOLATION LEVEL READ COMMITTED; INSERT INTO employees (name, age) VALUES ('Emily', 35); UPDATE products SET price = 60.00 WHERE category = 'Electronics'; COMMIT; </code></td>
      </tr>
  </tbody>
</table>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="sql--pyspark-queries">SQL &amp; PySpark Queries</h1>

<p>This guide pairs each <strong>SQL</strong> example with a <strong>PySpark DataFrame API</strong> equivalent.<br>
Assumptions: <code>df</code> is <code>employees</code>, and other tables are similarly named DataFrames (<code>departments</code>, <code>orders</code>, etc.).</p>
<blockquote>
<p><strong>Imports used in PySpark examples</strong></p></blockquote>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">row_number</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">ntile</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">coalesce</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span></span></span></code></pre></div>
<hr>
<h2 id="-section-1-basic-queries-110">🧩 Section 1: Basic Queries (1–10)</h2>
<h3 id="sql">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sales&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 5</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 6</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 7</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 8</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 9</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Sales&#34;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 10</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;IT&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-2-filtering--pattern-matching-1120">🔎 Section 2: Filtering &amp; Pattern Matching (11–20)</h2>
<h3 id="sql-1">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Marketing&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">75000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">ILIKE</span><span class="w"> </span><span class="s1">&#39;%jo%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 15
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Smi%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@gmail.com&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 17
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;_a%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">&#39;2023-12-31&#39;</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-1">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 11</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="s2">&#34;Sales&#34;</span><span class="p">,</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">,</span> <span class="s2">&#34;IT&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 12</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="s2">&#34;Sales&#34;</span><span class="p">,</span> <span class="s2">&#34;Marketing&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 13</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">75000</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 14  (case-insensitive search)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">lower</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&#34;%jo%&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 15</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;Smi&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 16</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;@gmail.com&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 17  (single char then &#39;a&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rlike</span><span class="p">(</span><span class="s2">&#34;^.a.*&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 18</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;manager_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 19</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;manager_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 20</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="s2">&#34;2023-01-01&#34;</span><span class="p">,</span> <span class="s2">&#34;2023-12-31&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-3-sorting--limiting-2130">↕️ Section 3: Sorting &amp; Limiting (21–30)</h2>
<h3 id="sql-2">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 21
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 22
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 23
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 25
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 26
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 27
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 29
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bonus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">bonus</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-2">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 21</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 22</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 23</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 24</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 25</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 26</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 27  (rows 11–20): use ROW_NUMBER then filter</span>
</span></span><span class="line"><span class="cl"><span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 28</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 29  (second-highest salary) – two ways</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># or using dense_rank</span>
</span></span><span class="line"><span class="cl"><span class="n">w2</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dr&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;dr&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 30</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;bonus&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-4-aggregation--grouping-3140">📊 Section 4: Aggregation &amp; Grouping (31–40)</h2>
<h3 id="sql-3">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 31
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 33
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 34
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 35
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 36
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">65000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 37
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">hire_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2022-01-01&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 39
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-3">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 31</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 32</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 33</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 34</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;max_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 35</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;min_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 36</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65000</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 37</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 38</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;hire_date&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&#34;2022-01-01&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 39</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 40</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;max_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-5-joins-4160">🔗 Section 5: Joins (41–60)</h2>
<h3 id="sql-4">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 41
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 43
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 44
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">RIGHT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 45
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 46
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 47
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 48
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_zip_code</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 49
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 50
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">sale_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 51
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 52
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="n">ep</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">project_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 53
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 54
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 55
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">last_purchase_date</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 56
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">m</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 57
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">salary_grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">salary_grades</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">min_salary</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">max_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 58
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;New York&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 59
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 60
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">table_a</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">table_b</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">item_id</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-4">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 41</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;inner&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 42</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 43</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">departments</span><span class="o">.</span><span class="n">department_id</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 44</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;right&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 45</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;outer&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 46</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;project_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 47</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">);</span> <span class="n">m</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;m&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.manager_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.employee_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;employee&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;manager&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 48</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">orders</span><span class="o">.</span><span class="n">customer_zip_code</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_zip_code</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_id&#34;</span><span class="p">,</span> <span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 49</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">departments</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 50</span>
</span></span><span class="line"><span class="cl"><span class="n">products</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;sale_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">products</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&#34;product_id&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 51</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employee_projects</span><span class="p">,</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;project_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 52</span>
</span></span><span class="line"><span class="cl"><span class="n">projects</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employee_projects</span><span class="p">,</span> <span class="s2">&#34;project_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>\
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;project_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 53</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employees</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 54</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">employees</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;num_employees&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 55</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">order_date</span> <span class="o">==</span> <span class="n">customers</span><span class="o">.</span><span class="n">last_purchase_date</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">],</span> <span class="n">customers</span><span class="o">.</span><span class="n">customer_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 56</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;e&#34;</span><span class="p">);</span> <span class="n">m</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;m&#34;</span><span class="p">);</span> <span class="n">d</span> <span class="o">=</span> <span class="n">departments</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;d&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.manager_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.employee_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.department_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;d.department_id&#34;</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl"> <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;e.first_name&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;m.first_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;manager_name&#34;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;d.department_name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 57</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">salary_grades</span><span class="p">,</span> <span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">salary</span> <span class="o">&gt;=</span> <span class="n">salary_grades</span><span class="o">.</span><span class="n">min_salary</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">employees</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;=</span> <span class="n">salary_grades</span><span class="o">.</span><span class="n">max_salary</span><span class="p">))</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;salary_grade&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 58</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;location_city&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;New York&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 59</span>
</span></span><span class="line"><span class="cl"><span class="n">employees</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">         <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 60</span>
</span></span><span class="line"><span class="cl"><span class="n">table_a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_b</span><span class="p">,</span> <span class="n">table_a</span><span class="o">.</span><span class="n">product_id</span> <span class="o">==</span> <span class="n">table_b</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">       <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table_a</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">table_b</span><span class="o">.</span><span class="n">item_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-6-subqueries-6175">🧠 Section 6: Subqueries (61–75)</h2>
<h3 id="sql-5">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 61
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 62
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">location_city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;San Francisco&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 63
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">company_avg_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 65
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 66
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 67
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 68
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 69
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_department_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 71
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 72
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 73
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 74
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 75
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">job_title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">job_title</span><span class="p">);</span></span></span></code></pre></div>
<h3 id="pyspark-5">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 61</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_sal</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="s2">&#34;avg&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">avg_sal</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 62</span>
</span></span><span class="line"><span class="cl"><span class="n">sf_depts</span> <span class="o">=</span> <span class="n">departments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;location_city&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;San Francisco&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sf_depts</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 63</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 64</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_val</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="s2">&#34;avg&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="n">avg_val</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;company_avg_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 65</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dept_avg&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept_avg</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;dept_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 66</span>
</span></span><span class="line"><span class="cl"><span class="n">high_paid</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">high_paid</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 67</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;department_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 68</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 69</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;employee_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 70</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_totals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;total_department_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dept_totals</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">,</span> <span class="s2">&#34;total_department_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 71</span>
</span></span><span class="line"><span class="cl"><span class="n">dept_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">top_dept</span> <span class="o">=</span> <span class="n">dept_avg</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;avg_salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">departments</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top_dept</span><span class="p">,</span> <span class="s2">&#34;department_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;department_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 72</span>
</span></span><span class="line"><span class="cl"><span class="n">buyers</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">customers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buyers</span><span class="p">,</span> <span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 73</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">avg_sal</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 74</span>
</span></span><span class="line"><span class="cl"><span class="n">customers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="s2">&#34;customer_id&#34;</span><span class="p">,</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;customer_name&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 75</span>
</span></span><span class="line"><span class="cl"><span class="n">job_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;job_avg&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_avg</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;job_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-7-window-functions-7685">🪟 Section 7: Window Functions (76–85)</h2>
<h3 id="sql-6">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 76
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 77
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">DENSE_RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dense_rank</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 79
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">NTILE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">quartile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LEAD</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">next_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 81
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">LAG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_order_amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 82
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">running_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 83
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">total_amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="n">total_amount</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">moving_avg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 84
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ranked_employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 85
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">product_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_sales</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">))</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percentage_of_total</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="p">;</span></span></span></code></pre></div>
<h3 id="pyspark-6">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w_dept</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 76</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 77</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;rank&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 78</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;dense_rank&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 79</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">ntile</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;quartile&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 80</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">lead</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;next_order_amount&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 81</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">lag</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;previous_order_amount&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 82</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;running_total&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 83</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">,</span> <span class="s2">&#34;total_amount&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">avg</span><span class="p">(</span><span class="s2">&#34;total_amount&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;moving_avg&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 84</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">,</span> <span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_dept</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;rn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 85</span>
</span></span><span class="line"><span class="cl"><span class="n">prod_sales</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">prod_sales</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;total_sales&#34;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">()))</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;percentage_of_total&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;product_sales&#34;</span><span class="p">)</span> <span class="o">/</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;total_sales&#34;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;product_id&#34;</span><span class="p">,</span> <span class="s2">&#34;product_sales&#34;</span><span class="p">,</span> <span class="s2">&#34;total_sales&#34;</span><span class="p">,</span> <span class="s2">&#34;percentage_of_total&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h2 id="-section-8-ctes--data-manipulation-86100">🧮 Section 8: CTEs &amp; Data Manipulation (86–100)</h2>
<h3 id="sql-7">SQL</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 86
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">JOIN</span><span class="w"> </span><span class="n">department_avg</span><span class="w"> </span><span class="n">da</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">department_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">da</span><span class="p">.</span><span class="n">avg_dept_salary</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 87
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 88
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">department</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;IT&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 89
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 90
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">old_data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 91
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 92
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 93
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;High Earner&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Mid-Range&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Junior&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salary_level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 94
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">high_salary_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">low_salary_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">department</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 95
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 96
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">COALESCE</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No Email Provided&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 97
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 98 (Recursive CTE)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">subordinates</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">subordinates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 99
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">((</span><span class="n">department</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">job_title</span><span class="p">),</span><span class="w"> </span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 100
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">ROLLUP</span><span class="p">(</span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">job_title</span><span class="p">);</span></span></span></code></pre></div>
<h3 id="pyspark-7">PySpark</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 86  (Use SQL CTE via temp view)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&#34;employees&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">WITH department_avg AS (
</span></span></span><span class="line"><span class="cl"><span class="s2">  SELECT department_id, AVG(salary) AS avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">  FROM employees GROUP BY department_id
</span></span></span><span class="line"><span class="cl"><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">SELECT e.first_name, e.salary, da.avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">FROM employees e
</span></span></span><span class="line"><span class="cl"><span class="s2">JOIN department_avg da ON e.department_id = da.department_id
</span></span></span><span class="line"><span class="cl"><span class="s2">WHERE e.salary &gt; da.avg_dept_salary
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 87  (Insert-like: union new rows)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_new</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s2">&#34;John&#34;</span><span class="p">,</span> <span class="s2">&#34;Doe&#34;</span><span class="p">,</span> <span class="mi">60000</span><span class="p">)],</span> <span class="p">[</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 88  (Update-like)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;IT&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 89  (Delete-like)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">101</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 90  (Truncate-like in-memory)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for Delta table: spark.sql(&#34;TRUNCATE TABLE old_data&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 91  UNION (distinct)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_union_distinct</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 92  UNION ALL</span>
</span></span><span class="line"><span class="cl"><span class="n">df_union_all</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 93  CASE/WHEN</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;salary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&#34;High Earner&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100000</span><span class="p">),</span> <span class="s2">&#34;Mid-Range&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="s2">&#34;Junior&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;salary_level&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 94  Pivot without true pivot</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;high_salary_count&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;low_salary_count&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 95  CAST</span>
</span></span><span class="line"><span class="cl"><span class="n">orders</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;order_date&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 96  COALESCE</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&#34;No Email Provided&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 97  NULLIF(salary,0) =&gt; NULL when equal</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;salary_or_null&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 98  Recursive CTE not native; iterative approach example (hierarchy traversal)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Start with seed</span>
</span></span><span class="line"><span class="cl"><span class="n">seed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl"><span class="n">frontier</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">step</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frontier</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">manager_id</span> <span class="o">==</span> <span class="n">frontier</span><span class="o">.</span><span class="n">employee_id</span><span class="p">,</span> <span class="s2">&#34;inner&#34;</span><span class="p">)</span>\
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">employee_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">manager_id</span><span class="p">)</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;employee_id&#34;</span><span class="p">,</span> <span class="s2">&#34;manager_id&#34;</span><span class="p">],</span> <span class="s2">&#34;left_anti&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">new_nodes</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">frontier</span> <span class="o">=</span> <span class="n">new_nodes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># result contains recursive closure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 99  GROUPING SETS -&gt; cube with filters</span>
</span></span><span class="line"><span class="cl"><span class="n">cube_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cube</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;sum_salary&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Keep only grouping sets: (department), (job_title), ()</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">grouping_id</span>
</span></span><span class="line"><span class="cl"><span class="n">cube_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># (department,NULL)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># (NULL,job_title)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">grouping_id</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>    <span class="c1"># (NULL,NULL)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 100  ROLLUP</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&#34;department&#34;</span><span class="p">,</span> <span class="s2">&#34;job_title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;salary&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&#34;sum_salary&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></span></span></code></pre></div>
<hr>
<h3 id="-notes">✅ Notes</h3>
<ul>
<li>Some SQL constructs (OFFSET, Recursive CTE) don’t map 1:1 to PySpark; patterns above show practical equivalents.</li>
<li>Replace <code>.show()</code> with <code>.write.format(&quot;delta&quot;)...</code> to persist as needed.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
          </section>
        </div>
      </main>
    </div>
    <script src="/js/clipboard/clipboard.min.js?1761501432" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1761501432" defer></script>
    <script src="/js/theme.js?1761501432" defer></script>
  </body>
</html>
